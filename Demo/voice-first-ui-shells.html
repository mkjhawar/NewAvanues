<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-First UI Shells ‚Äî Avanues Cockpit</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1565C0;
            --secondary: #42A5F5;
            --surface: #121212;
            --surface2: #1e1e2e;
            --on-surface: #FFFFFF;
            --on-surface-dim: #B0B0B0;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent-green: #4CAF50;
            --accent-orange: #FF9800;
            --accent-red: #F44336;
            --accent-purple: #9C27B0;
            --radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 100%);
            color: var(--on-surface);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-frame { width: 100vw; height: 100vh; display: flex; flex-direction: column; }

        /* === STATUS BAR === */
        .status-bar {
            height: 28px; background: rgba(0,0,0,0.6); display: flex;
            align-items: center; justify-content: space-between;
            padding: 0 16px; font-size: 11px; color: var(--on-surface-dim); flex-shrink: 0;
        }

        /* === TOP NAV === */
        .top-nav {
            height: 52px; background: rgba(18, 18, 18, 0.9); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(21, 101, 192, 0.15);
            display: flex; align-items: center; padding: 0 16px; gap: 12px; flex-shrink: 0;
        }
        .back-btn {
            background: none; border: none; color: var(--secondary);
            font-size: 18px; cursor: pointer; padding: 4px 8px;
            border-radius: 8px; transition: background 150ms; display: none;
        }
        .back-btn:hover { background: var(--glass); }
        .back-btn.visible { display: flex; }
        .nav-title {
            font-size: 16px; font-weight: 700;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; flex: 1;
        }
        .shell-badge {
            font-size: 11px; padding: 4px 10px;
            background: rgba(21,101,192,0.2); border: 1px solid var(--glass-border);
            border-radius: 12px; color: var(--secondary);
        }

        /* === SHELL TABS === */
        .shell-tabs {
            height: 44px; background: rgba(18, 18, 18, 0.6);
            display: flex; align-items: center; gap: 4px; padding: 0 16px;
            border-bottom: 1px solid rgba(21, 101, 192, 0.08); flex-shrink: 0;
        }
        .shell-tabs.hidden { display: none; }
        .tab-btn {
            padding: 8px 18px; background: transparent; border: none;
            color: var(--on-surface-dim); font-size: 13px; font-weight: 600;
            cursor: pointer; border-bottom: 2px solid transparent;
            transition: all 150ms; white-space: nowrap;
        }
        .tab-btn:hover { color: var(--on-surface); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* === VIEWPORT === */
        .viewport { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; }
        .screen { display: none; height: 100%; }
        .screen.active { display: flex; flex-direction: column; animation: fadeIn 250ms ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        /* === ACTION BAR === */
        .action-bar {
            height: 52px; background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(21, 101, 192, 0.1);
            display: flex; align-items: center; gap: 8px; padding: 0 16px; flex-shrink: 0; overflow-x: auto;
        }
        .action-chip {
            background: rgba(21,101,192,0.15); border: 1px solid var(--glass-border);
            color: var(--on-surface); padding: 7px 14px; border-radius: 18px;
            cursor: pointer; transition: all 150ms; white-space: nowrap;
            font-size: 12px; font-weight: 600;
        }
        .action-chip:hover { background: rgba(21,101,192,0.3); border-color: var(--primary); color: var(--primary); }
        .action-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .action-spacer { flex: 1; }
        .action-more {
            background: var(--primary); color: #fff; border: none;
            padding: 7px 16px; border-radius: 18px; cursor: pointer;
            font-weight: 600; font-size: 12px; transition: all 150ms;
        }
        .action-more:hover { background: var(--secondary); }

        /* ========== CLASSIC SHELL ‚Äî ALL 4 LAYOUTS ========== */

        /* Grid layout (default) */
        .layout-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 14px; padding: 20px; flex: 1; align-content: start;
        }
        .tile {
            aspect-ratio: 1; background: linear-gradient(135deg, rgba(21,101,192,0.18), rgba(66,165,245,0.08));
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 200ms; gap: 8px;
        }
        .tile:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 8px 24px rgba(21,101,192,0.25); }
        .tile .icon { font-size: 2em; }
        .tile .label { font-size: 12px; font-weight: 600; color: var(--on-surface-dim); }

        /* Cockpit layout ‚Äî windshield perspective (3 angled panels) */
        .layout-cockpit {
            display: flex; flex: 1; padding: 12px 8px; gap: 0;
            perspective: 1000px;
            align-items: stretch; position: relative;
        }
        .cockpit-panel {
            display: flex; flex-direction: column; gap: 8px; padding: 10px;
            background: linear-gradient(180deg, rgba(21,101,192,0.10), rgba(66,165,245,0.04));
            border: 1px solid var(--glass-border);
            transition: all 300ms ease;
        }
        .cockpit-panel .tile { aspect-ratio: auto; min-height: 70px; font-size: 0.9em; }
        .cockpit-panel.left {
            transform: rotateY(16deg);
            transform-origin: right center;
            border-radius: 16px 0 0 16px;
            flex: 0.65;
            border-right: none;
        }
        .cockpit-panel.center {
            flex: 1.7; z-index: 1;
            background: linear-gradient(180deg, rgba(21,101,192,0.20), rgba(66,165,245,0.08));
            border-color: rgba(21,101,192,0.4);
            box-shadow: 0 0 50px rgba(21,101,192,0.12), inset 0 1px 0 rgba(66,165,245,0.15);
        }
        .cockpit-panel.center .tile {
            min-height: 85px; font-size: 1em;
            background: linear-gradient(135deg, rgba(21,101,192,0.25), rgba(66,165,245,0.10));
            border-color: rgba(21,101,192,0.3);
        }
        .cockpit-panel.center .tile .icon { font-size: 2.4em; }
        .cockpit-panel.center .tile .label { font-size: 13px; color: var(--secondary); }
        .cockpit-panel.right {
            transform: rotateY(-16deg);
            transform-origin: left center;
            border-radius: 0 16px 16px 0;
            flex: 0.65;
            border-left: none;
        }
        /* Windshield frame accent lines */
        .layout-cockpit::before, .layout-cockpit::after {
            content: ''; position: absolute; top: 0; bottom: 0; width: 1px;
            background: linear-gradient(180deg, rgba(21,101,192,0.3), transparent 30%, transparent 70%, rgba(21,101,192,0.3));
            z-index: 2; pointer-events: none;
        }
        .layout-cockpit::before { left: calc(35% - 4px); }
        .layout-cockpit::after { right: calc(35% - 4px); }

        /* ‚îÄ‚îÄ Cockpit Workspace (live module panels) ‚îÄ‚îÄ */
        .layout-cockpit.cockpit-workspace .cockpit-panel {
            display: flex; flex-direction: column; overflow: hidden;
            cursor: pointer; position: relative; gap: 0;
        }
        .cockpit-mini-header {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 8px; font-size: 11px; font-weight: 700;
            background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        .cockpit-mini-header .mini-icon { font-size: 14px; }
        .cockpit-mini-header .mini-title { flex: 1; color: var(--on-surface-dim); }
        .cockpit-mini-header .mini-expand-btn,
        .cockpit-mini-header .mini-picker-btn {
            background: none; border: none; color: var(--on-surface-dim);
            cursor: pointer; font-size: 12px; padding: 2px 5px; border-radius: 4px;
            transition: all 150ms;
        }
        .cockpit-mini-header .mini-expand-btn:hover,
        .cockpit-mini-header .mini-picker-btn:hover {
            background: var(--glass); color: var(--on-surface);
        }
        .mini-module-body {
            flex: 1; overflow: hidden; padding: 8px; font-size: 11px;
            display: flex; flex-direction: column; gap: 4px;
        }
        /* Focus glow */
        .cockpit-panel.focused {
            border-color: rgba(21,101,192,0.6) !important;
            box-shadow: 0 0 30px rgba(21,101,192,0.2), inset 0 1px 0 rgba(66,165,245,0.2);
            z-index: 2;
        }
        .cockpit-panel:not(.focused) { opacity: 0.85; }
        .cockpit-panel:not(.focused):hover { opacity: 1; }

        /* Mini module type-specific styles */
        .mini-browser-url {
            background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 10px;
            font-size: 10px; color: var(--on-surface-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .mini-browser-viewport {
            flex: 1; background: rgba(0,0,0,0.2); border-radius: 4px; min-height: 40px;
            display: flex; align-items: center; justify-content: center; font-size: 24px; opacity: 0.3;
        }
        .mini-editor-line {
            height: 6px; background: rgba(255,255,255,0.12); border-radius: 3px; width: 100%;
        }
        .mini-editor-line.heading {
            height: auto; background: none; font-size: 11px; font-weight: 700;
            color: var(--on-surface); margin-bottom: 4px; padding: 0;
        }
        .mini-pdf-page {
            flex: 1; background: rgba(42,42,62,0.8); border: 1px solid var(--glass-border);
            border-radius: 3px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 10px; color: var(--on-surface-dim); min-height: 60px;
        }
        .mini-video {
            flex: 1; background: #000; border-radius: 4px; min-height: 40px;
            display: flex; align-items: center; justify-content: center;
        }
        .mini-video .mini-play { font-size: 20px; opacity: 0.6; }
        .mini-progress { height: 3px; background: rgba(255,255,255,0.15); border-radius: 2px; margin-top: 4px; }
        .mini-progress .mini-progress-fill { height: 100%; background: var(--primary); border-radius: 2px; }
        .mini-camera {
            flex: 1; background: #000; border-radius: 4px; min-height: 50px;
            display: flex; align-items: center; justify-content: center; font-size: 24px; opacity: 0.4;
        }
        .mini-file-row {
            padding: 3px 6px; background: rgba(255,255,255,0.04); border-radius: 3px;
            font-size: 10px; color: var(--on-surface-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .mini-gallery {
            display: grid; grid-template-columns: 1fr 1fr; gap: 3px; flex: 1;
        }
        .mini-gallery-thumb {
            background: rgba(21,101,192,0.15); border-radius: 3px;
            display: flex; align-items: center; justify-content: center; font-size: 14px; min-height: 28px;
        }
        .mini-cast {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-size: 10px; color: var(--on-surface-dim); gap: 2px;
        }
        .mini-cast span { font-size: 24px; }
        .mini-settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 3px 6px; font-size: 10px; color: var(--on-surface-dim);
        }
        .mini-toggle {
            width: 20px; height: 11px; border-radius: 6px; background: rgba(255,255,255,0.15);
            display: inline-block; position: relative;
        }
        .mini-toggle.on { background: var(--primary); }

        /* Maximize mode */
        .layout-cockpit.cockpit-workspace.maximized .cockpit-panel { display: none; }
        .layout-cockpit.cockpit-workspace.maximized .cockpit-panel.focused {
            display: flex; flex: 1; transform: none !important; border-radius: var(--radius);
        }
        .layout-cockpit.cockpit-workspace.maximized::before,
        .layout-cockpit.cockpit-workspace.maximized::after { display: none; }

        /* Module picker dropdown */
        .panel-picker-dropdown {
            position: absolute; top: 28px; right: 4px; z-index: 10;
            background: var(--surface2); border: 1px solid var(--glass-border);
            border-radius: 8px; padding: 4px; display: none;
            min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        .panel-picker-dropdown.visible { display: flex; flex-direction: column; }
        .panel-picker-option {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 10px; border-radius: 4px; cursor: pointer;
            font-size: 11px; color: var(--on-surface-dim); transition: background 100ms;
        }
        .panel-picker-option:hover { background: rgba(21,101,192,0.2); color: var(--on-surface); }
        .panel-picker-option.current { color: var(--primary); font-weight: 700; }

        /* Cockpit action bar divider */
        .action-divider {
            width: 1px; height: 24px; background: var(--glass-border); flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ MapViews card preview ‚îÄ‚îÄ */
        .card-preview {
            height: 80px; overflow: hidden; border-radius: 6px; margin: 8px 0;
            background: rgba(0,0,0,0.2); padding: 8px; font-size: 11px;
            display: flex; flex-direction: column; gap: 4px;
        }

        /* ‚îÄ‚îÄ SpaceAvanue island preview ‚îÄ‚îÄ */
        .island-preview {
            margin-top: 6px; font-size: 9px; overflow: hidden; max-height: 70px;
            opacity: 0.8;
        }
        .island.depth-mid .island-preview { max-height: 50px; }
        .island.depth-far .island-preview { display: none; }

        /* Usage-based island sizing */
        .island.size-lg { min-width: 180px; padding: 18px 22px; }
        .island.size-lg .i-icon { font-size: 2.2em; }
        .island.size-lg .i-label { font-size: 14px; }
        .island.size-lg .island-preview { max-height: 90px; }
        .island.size-md { min-width: 145px; padding: 14px 18px; }
        .island.size-sm { min-width: 110px; padding: 10px 14px; }
        .island.size-sm .i-icon { font-size: 1.3em; }
        .island.size-sm .i-label { font-size: 11px; }

        /* ‚îÄ‚îÄ SearchAvanue result preview ‚îÄ‚îÄ */
        .lens-result-item { position: relative; }
        .result-preview {
            display: none; position: absolute; right: -220px; top: 0;
            width: 200px; background: var(--surface2); border: 1px solid var(--glass-border);
            border-radius: 8px; padding: 8px; font-size: 10px; z-index: 5;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }
        .lens-result-item:hover .result-preview { display: flex; flex-direction: column; gap: 4px; }

        /* Carousel layout ‚Äî horizontal scroll */
        .layout-carousel {
            display: flex; gap: 16px; padding: 20px; flex: 1; align-items: stretch;
            overflow-x: auto; overflow-y: hidden; scroll-snap-type: x mandatory;
        }
        .layout-carousel .tile {
            flex: 0 0 220px; aspect-ratio: auto; min-height: 260px;
            scroll-snap-align: start;
        }
        .layout-carousel .tile .icon { font-size: 3em; }
        .layout-carousel .tile .label { font-size: 14px; }

        /* Freeform layout ‚Äî scattered absolute */
        .layout-freeform {
            position: relative; flex: 1; overflow: hidden;
            background: radial-gradient(circle at 50% 50%, rgba(21,101,192,0.03), transparent);
        }
        .layout-freeform .grid-dots {
            position: absolute; inset: 0;
            background-image: radial-gradient(rgba(21,101,192,0.08) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .layout-freeform .tile {
            position: absolute; aspect-ratio: auto;
            width: 130px; min-height: 100px; cursor: grab;
        }
        .layout-freeform .tile:active { cursor: grabbing; }

        /* ========== AVANUEVIEWS SHELL ========== */
        .card-stream { display: flex; flex-direction: column; gap: 12px; padding: 16px; flex: 1; }
        .card-stream.layout-compact { gap: 4px; }
        .card-stream.layout-compact .stream-card { padding: 10px 14px; }
        .card-stream.layout-compact .card-body { display: none; }
        .card-stream.layout-grid-view { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .card-stream.layout-timeline { border-left: 2px solid var(--glass-border); margin-left: 32px; padding-left: 20px; }
        .card-stream.layout-timeline .stream-card { position: relative; }
        .card-stream.layout-timeline .stream-card::before {
            content: ''; position: absolute; left: -27px; top: 18px;
            width: 10px; height: 10px; border-radius: 50%; background: var(--primary);
        }
        .stream-card {
            background: linear-gradient(135deg, rgba(21,101,192,0.12), rgba(66,165,245,0.04));
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 16px; cursor: pointer; transition: all 200ms;
        }
        .stream-card:hover { border-color: var(--primary); box-shadow: 0 4px 16px rgba(21,101,192,0.2); }
        .stream-card .card-head { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .stream-card .card-icon { font-size: 1.3em; }
        .stream-card .card-title { font-weight: 700; font-size: 14px; }
        .stream-card .card-meta { font-size: 11px; color: var(--on-surface-dim); margin-left: auto; }
        .stream-card .card-body { font-size: 13px; color: var(--on-surface-dim); line-height: 1.5; margin-bottom: 10px; }
        .stream-card .card-cta {
            display: inline-block; background: rgba(21,101,192,0.2); color: var(--primary);
            padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;
            border: 1px solid rgba(21,101,192,0.3);
        }
        .stream-card.hidden-card { display: none; }

        /* ========== LENS SHELL ========== */
        .lens-center { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 40px 20px; }
        .search-bar {
            width: 100%; max-width: 520px; height: 52px;
            background: rgba(255,255,255,0.06); border: 1px solid var(--primary);
            border-radius: 26px; padding: 0 20px; display: flex; align-items: center; gap: 10px;
            margin-bottom: 28px;
        }
        .search-bar input { flex: 1; background: none; border: none; color: var(--on-surface); font-size: 14px; outline: none; }
        .search-bar input::placeholder { color: var(--on-surface-dim); }
        .search-bar .mic { font-size: 18px; cursor: pointer; opacity: 0.7; transition: opacity 150ms; }
        .search-bar .mic:hover { opacity: 1; }
        .quick-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 10px; width: 100%; max-width: 520px;
        }
        .quick-grid.layout-list { grid-template-columns: 1fr; max-width: 400px; }
        .quick-grid.layout-compact { grid-template-columns: repeat(6, 1fr); gap: 6px; }
        .quick-chip {
            background: rgba(21,101,192,0.15); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 10px 14px; cursor: pointer;
            transition: all 150ms; text-align: center; font-size: 13px; font-weight: 600;
        }
        .quick-chip:hover { background: rgba(21,101,192,0.3); border-color: var(--primary); transform: scale(1.04); }
        .lens-results {
            width: 100%; max-width: 520px; margin-top: 20px;
            display: none; flex-direction: column; gap: 6px;
        }
        .lens-results.visible { display: flex; }
        .lens-result-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; background: var(--glass); border-radius: 8px;
            cursor: pointer; transition: background 150ms; font-size: 13px;
        }
        .lens-result-item:hover { background: rgba(21,101,192,0.2); }
        .lens-result-item .r-icon { font-size: 16px; }
        .lens-result-item .r-label { flex: 1; }
        .lens-result-item .r-type { font-size: 11px; color: var(--on-surface-dim); }

        /* ========== SPATIAL SHELL ========== */
        .spatial-space {
            flex: 1; position: relative; overflow: hidden;
            perspective: 1200px;
            transform-style: preserve-3d;
            background: radial-gradient(ellipse at 50% 40%, rgba(21,101,192,0.06), transparent 70%);
            transition: transform 300ms ease;
            transform-origin: center center;
        }
        .spatial-space .grid-bg {
            position: absolute; inset: 0;
            background-image:
                linear-gradient(rgba(21,101,192,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(21,101,192,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .island {
            position: absolute; border-radius: var(--radius);
            padding: 16px 20px; cursor: grab;
            transition: box-shadow 300ms, border-color 300ms, transform 300ms;
            text-align: center; min-width: 130px; user-select: none;
        }
        .island:hover { border-color: var(--primary); box-shadow: 0 12px 40px rgba(21,101,192,0.4); }
        .island:active { cursor: grabbing; }
        .island .i-icon { font-size: 1.6em; margin-bottom: 6px; }
        .island .i-label { font-size: 12px; font-weight: 600; }
        /* Depth layers */
        .island.depth-near {
            background: linear-gradient(135deg, rgba(21,101,192,0.30), rgba(66,165,245,0.18));
            border: 1px solid rgba(66,165,245,0.25);
            z-index: 3; transform: translateZ(50px);
            box-shadow: 0 8px 32px rgba(21,101,192,0.3);
            min-width: 145px;
        }
        .island.depth-near .i-icon { font-size: 1.9em; }
        .island.depth-near .i-label { color: var(--on-surface); font-size: 13px; }
        .island.depth-mid {
            background: linear-gradient(135deg, rgba(21,101,192,0.18), rgba(66,165,245,0.08));
            border: 1px solid var(--glass-border);
            z-index: 2; transform: translateZ(0px);
            opacity: 0.92;
        }
        .island.depth-mid .i-label { color: var(--on-surface-dim); }
        .island.depth-far {
            background: linear-gradient(135deg, rgba(21,101,192,0.10), rgba(66,165,245,0.04));
            border: 1px solid rgba(255,255,255,0.06);
            z-index: 1; transform: translateZ(-60px) scale(0.88);
            opacity: 0.65;
            animation: float-depth 8s ease-in-out infinite;
        }
        .island.depth-far .i-icon { font-size: 1.4em; }
        .island.depth-far .i-label { color: rgba(176,176,176,0.7); font-size: 11px; }
        @keyframes float-depth {
            0%, 100% { transform: translateZ(-60px) scale(0.88) translateY(0); }
            50% { transform: translateZ(-60px) scale(0.88) translateY(-6px); }
        }
        .spatial-zoom-label {
            position: absolute; bottom: 12px; right: 16px; font-size: 11px;
            color: var(--on-surface-dim); background: rgba(0,0,0,0.5); padding: 3px 10px;
            border-radius: 8px; z-index: 10;
        }

        /* ========== MODULE SCREENS ========== */
        .module-screen { flex: 1; display: flex; flex-direction: column; }
        .module-header {
            padding: 16px 20px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid rgba(21,101,192,0.08);
        }
        .module-header .m-icon { font-size: 1.6em; }
        .module-header .m-info { flex: 1; }
        .module-header .m-title { font-size: 15px; font-weight: 700; }
        .module-header .m-sub { font-size: 11px; color: var(--on-surface-dim); }
        .module-body { flex: 1; padding: 20px; overflow-y: auto; }

        /* Browser mock */
        .browser-mock { background: var(--surface2); border-radius: 8px; overflow: hidden; }
        .browser-url {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px;
            background: rgba(0,0,0,0.3); font-size: 12px;
        }
        .browser-url .url-pill {
            flex: 1; background: rgba(255,255,255,0.06); padding: 6px 12px;
            border-radius: 16px; color: var(--on-surface-dim); font-size: 12px;
        }
        .browser-content { height: 360px; background: #1a1a2e; display: flex; align-items: center; justify-content: center; color: var(--on-surface-dim); font-size: 14px; flex-direction: column; gap: 8px; }

        /* Editor mock */
        .editor-mock { background: var(--surface2); border-radius: 8px; padding: 16px; min-height: 300px; }
        .editor-toolbar {
            display: flex; gap: 6px; padding-bottom: 12px; margin-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }
        .editor-toolbar button {
            background: var(--glass); border: 1px solid var(--glass-border); color: var(--on-surface);
            padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .editor-body { font-size: 14px; line-height: 1.8; color: var(--on-surface-dim); }
        .editor-body p { margin-bottom: 12px; }

        /* PDF mock */
        .pdf-mock { background: var(--surface2); border-radius: 8px; display: flex; flex-direction: column; align-items: center; padding: 20px; gap: 16px; }
        .pdf-page {
            width: 100%; max-width: 500px; aspect-ratio: 8.5/11; background: #2a2a3e;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--glass-border);
        }
        .pdf-page-num { font-size: 12px; color: var(--on-surface-dim); }

        /* Camera mock */
        .camera-mock {
            background: #000; border-radius: 8px; aspect-ratio: 4/3; display: flex;
            align-items: center; justify-content: center; position: relative; overflow: hidden;
        }
        .camera-mock .viewfinder { font-size: 60px; opacity: 0.3; }
        .cam-controls {
            position: absolute; bottom: 16px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 20px;
        }
        .cam-btn {
            width: 56px; height: 56px; border-radius: 50%; border: 3px solid #fff;
            background: rgba(255,255,255,0.1); cursor: pointer; transition: all 150ms;
        }
        .cam-btn:hover { background: rgba(255,255,255,0.3); }
        .cam-btn.shutter { width: 64px; height: 64px; background: rgba(244,67,54,0.4); border-color: #F44336; }

        /* Video mock */
        .video-mock {
            background: #000; border-radius: 8px; aspect-ratio: 16/9; display: flex;
            align-items: center; justify-content: center; position: relative;
        }
        .video-mock .play-btn { font-size: 48px; opacity: 0.7; cursor: pointer; }
        .time-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 36px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            display: flex; align-items: center; padding: 0 12px; gap: 8px; font-size: 11px;
        }
        .progress { flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 2px; }
        .progress-fill { height: 100%; width: 35%; background: var(--primary); border-radius: 2px; }

        /* Whiteboard mock */
        .whiteboard-mock {
            background: #1a1a2e; border-radius: 8px; aspect-ratio: 16/10;
            position: relative; border: 1px solid var(--glass-border); overflow: hidden;
        }
        .wb-toolbar {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 6px;
        }
        .wb-tool {
            width: 36px; height: 36px; border-radius: 8px; background: var(--glass);
            border: 1px solid var(--glass-border); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 14px;
        }
        .wb-tool.selected { background: rgba(21,101,192,0.3); border-color: var(--primary); }
        .whiteboard-mock svg { position: absolute; inset: 0; width: 100%; height: 100%; }

        /* Files mock */
        .files-mock { display: flex; flex-direction: column; gap: 4px; }
        .file-row {
            display: flex; align-items: center; gap: 12px; padding: 10px 14px;
            background: var(--glass); border-radius: 8px; cursor: pointer; transition: background 150ms;
        }
        .file-row:hover { background: rgba(21,101,192,0.15); }
        .f-icon { font-size: 1.3em; } .f-name { flex: 1; font-size: 13px; font-weight: 600; }
        .f-size { font-size: 11px; color: var(--on-surface-dim); } .f-date { font-size: 11px; color: var(--on-surface-dim); }

        /* Settings mock */
        .settings-mock { display: flex; flex-direction: column; gap: 2px; }
        .settings-section { font-size: 11px; font-weight: 700; color: var(--primary); padding: 12px 14px 4px; text-transform: uppercase; letter-spacing: 1px; }
        .settings-row {
            display: flex; align-items: center; gap: 12px; padding: 12px 14px;
            background: var(--glass); border-radius: 8px; cursor: pointer; transition: background 150ms;
        }
        .settings-row:hover { background: rgba(21,101,192,0.12); }
        .s-label { flex: 1; font-size: 13px; } .s-value { font-size: 12px; color: var(--on-surface-dim); }
        .toggle { width: 40px; height: 22px; border-radius: 11px; background: rgba(255,255,255,0.15); position: relative; cursor: pointer; }
        .toggle.on { background: var(--primary); }
        .toggle::after { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%; background: #fff; top: 2px; left: 2px; transition: left 150ms; }
        .toggle.on::after { left: 20px; }

        /* Image gallery */
        .image-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .gallery-thumb {
            aspect-ratio: 1; background: linear-gradient(135deg, rgba(21,101,192,0.2), rgba(66,165,245,0.1));
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 2em; cursor: pointer; transition: all 150ms; border: 1px solid var(--glass-border);
        }
        .gallery-thumb:hover { border-color: var(--primary); transform: scale(1.03); }

        /* Cast mock */
        .cast-mock { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 30px; }
        .cast-status { font-size: 48px; }
        .cast-label { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .cast-sub { font-size: 12px; color: var(--on-surface-dim); }
        .cast-btn {
            background: var(--accent-green); color: #fff; border: none;
            padding: 12px 32px; border-radius: 24px; font-size: 14px; font-weight: 700; cursor: pointer;
        }

        /* Layout indicator */
        .layout-indicator {
            position: absolute; top: 8px; right: 16px; font-size: 10px;
            color: var(--on-surface-dim); background: rgba(0,0,0,0.4); padding: 3px 8px;
            border-radius: 6px; z-index: 2; pointer-events: none;
        }
    </style>
</head>
<body>
<div class="app-frame">

    <div class="status-bar">
        <span>VoiceOS¬Æ Avanues</span>
        <span>üîã 87% &nbsp; üì∂ &nbsp; 14:32</span>
    </div>

    <div class="top-nav">
        <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê Back</button>
        <div class="nav-title" id="navTitle">Voice-First UI Shells</div>
        <div class="shell-badge" id="shellBadge">CockpitAvanue</div>
    </div>

    <div class="shell-tabs" id="shellTabs">
        <button class="tab-btn active" data-shell="classic">‚úàÔ∏è CockpitAvanue</button>
        <button class="tab-btn" data-shell="avanue-views">üó∫Ô∏è MapViews</button>
        <button class="tab-btn" data-shell="lens">üîç SearchAvanue</button>
        <button class="tab-btn" data-shell="spatial">üåå SpaceAvanue</button>
    </div>

    <div class="viewport">

        <!-- ============ CLASSIC SHELL ============ -->
        <div class="screen active" id="screen-classic">
            <span class="layout-indicator" id="classicLayoutLabel">üìê Grid</span>
            <div class="layout-grid" id="classicContainer"></div>
        </div>

        <!-- ============ AVANUEVIEWS SHELL ============ -->
        <div class="screen" id="screen-avanue-views">
            <span class="layout-indicator" id="avLayoutLabel">üìã Stream</span>
            <div class="card-stream" id="avContainer">
                <div class="stream-card" data-mod="note" data-cat="active" onclick="openModule('note')">
                    <div class="card-head"><span class="card-icon">üìù</span><span class="card-title">Active: Meeting Notes</span><span class="card-meta">5 min ago</span></div>
                    <div class="card-preview" id="av-preview-note"></div>
                    <span class="card-cta">Resume Editing</span>
                </div>
                <div class="stream-card" data-mod="pdf" data-cat="active" onclick="openModule('pdf')">
                    <div class="card-head"><span class="card-icon">üìÑ</span><span class="card-title">Research: Quantum Computing</span><span class="card-meta">3 PDFs</span></div>
                    <div class="card-preview" id="av-preview-pdf"></div>
                    <span class="card-cta">View Papers</span>
                </div>
                <div class="stream-card" data-mod="photo" data-cat="suggested" onclick="openModule('photo')">
                    <div class="card-head"><span class="card-icon">üì∑</span><span class="card-title">Suggested: Morning Sketches</span><span class="card-meta">12 photos</span></div>
                    <div class="card-preview" id="av-preview-photo"></div>
                    <span class="card-cta">Convert Now</span>
                </div>
                <div class="stream-card" data-mod="web" data-cat="recent" onclick="openModule('web')">
                    <div class="card-head"><span class="card-icon">üåê</span><span class="card-title">Reading: AI in Healthcare</span><span class="card-meta">8 min read</span></div>
                    <div class="card-preview" id="av-preview-web"></div>
                    <span class="card-cta">Continue Reading</span>
                </div>
                <div class="stream-card" data-mod="whiteboard" data-cat="suggested" onclick="openModule('whiteboard')">
                    <div class="card-head"><span class="card-icon">‚úèÔ∏è</span><span class="card-title">Export Whiteboard Diagrams</span><span class="card-meta">3 diagrams</span></div>
                    <div class="card-preview" id="av-preview-whiteboard"></div>
                    <span class="card-cta">Export SVG</span>
                </div>
                <div class="stream-card" data-mod="video" data-cat="recent" onclick="openModule('video')">
                    <div class="card-head"><span class="card-icon">üé¨</span><span class="card-title">Continue: Tutorial Video</span><span class="card-meta">35% watched</span></div>
                    <div class="card-preview" id="av-preview-video"></div>
                    <span class="card-cta">Resume</span>
                </div>
            </div>
        </div>

        <!-- ============ LENS SHELL ============ -->
        <div class="screen" id="screen-lens">
            <div class="lens-center">
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" placeholder="Search modules, commands, settings, files..." id="lensInput" oninput="onLensInput(this.value)">
                    <span class="mic">üé§</span>
                </div>
                <div class="lens-results" id="lensResults"></div>
                <div class="quick-grid" id="quickGrid">
                    <div class="quick-chip" onclick="openModule('web')">üåê Web</div>
                    <div class="quick-chip" onclick="openModule('note')">üìù Note</div>
                    <div class="quick-chip" onclick="openModule('photo')">üì∑ Camera</div>
                    <div class="quick-chip" onclick="openModule('pdf')">üìÑ PDF</div>
                    <div class="quick-chip" onclick="openModule('whiteboard')">‚úèÔ∏è Whiteboard</div>
                    <div class="quick-chip" onclick="openModule('video')">üé¨ Video</div>
                    <div class="quick-chip" onclick="openModule('files')">üìÇ Files</div>
                    <div class="quick-chip" onclick="openModule('settings')">‚öôÔ∏è Settings</div>
                    <div class="quick-chip" onclick="openModule('image')">üñºÔ∏è Images</div>
                    <div class="quick-chip" onclick="openModule('cast')">üì° Cast</div>
                    <div class="quick-chip" onclick="openModule('annotation')">üé§ Help</div>
                    <div class="quick-chip" onclick="openModule('annotation')">üé® Annotate</div>
                </div>
            </div>
        </div>

        <!-- ============ SPATIAL SHELL ============ -->
        <div class="screen" id="screen-spatial">
            <div class="spatial-space" id="spatialSpace">
                <div class="grid-bg"></div>
                <!-- Islands generated dynamically by buildSpatialIslands() -->
            </div>
            <span class="spatial-zoom-label" id="spatialZoomLabel">Zoom: 100%</span>
        </div>

        <!-- ============ MODULE SCREENS ============ -->
        <!-- WebAvanue -->
        <div class="screen" id="screen-mod-web">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üåê</span><div class="m-info"><div class="m-title">WebAvanue</div><div class="m-sub">Voice-First Browser</div></div></div>
                <div class="module-body">
                    <div class="browser-mock">
                        <div class="browser-url"><span>‚Üê</span><span>‚Üí</span><span>üîÑ</span><div class="url-pill">https://techcrunch.com/ai-healthcare-2026</div><span>‚≠ê</span></div>
                        <div class="browser-content">üåê Web page content renders here<br><span style="font-size:12px;opacity:0.5">Say "scroll down" or "click first link"</span></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- NoteAvanue -->
        <div class="screen" id="screen-mod-note">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üìù</span><div class="m-info"><div class="m-title">NoteAvanue</div><div class="m-sub">Voice-First Rich Editor</div></div></div>
                <div class="module-body">
                    <div class="editor-mock">
                        <div class="editor-toolbar">
                            <button><b>B</b></button><button><i>I</i></button><button><u>U</u></button>
                            <button>H1</button><button>H2</button><button>‚Ä¢ List</button>
                            <button>‚òë Check</button><button>‚Ü© Undo</button><button>‚Ü™ Redo</button>
                        </div>
                        <div class="editor-body">
                            <p><b>Sprint Retrospective ‚Äî Feb 25, 2026</b></p>
                            <p>What went well: KMP migration completed ahead of schedule. Voice command coverage hit 94% across all modules.</p>
                            <p>Action items:</p>
                            <p>‚òë Merge MapViews branch into main<br>‚òê Glass optimization for MICRO display profile<br>‚òê iOS CockpitScreen wrapper</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- PDFAvanue -->
        <div class="screen" id="screen-mod-pdf">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üìÑ</span><div class="m-info"><div class="m-title">PDFAvanue</div><div class="m-sub">Document Viewer</div></div></div>
                <div class="module-body">
                    <div class="pdf-mock">
                        <div class="pdf-page"><div style="text-align:center;color:var(--on-surface-dim)">üìÑ<br>Quantum Computing Trends 2026<br><span style="font-size:11px;opacity:0.6">Page 1 of 24</span></div></div>
                        <div class="pdf-page-num">Page 1 / 24 ‚Äî Continuous View ‚Äî Fit Width</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- PhotoAvanue -->
        <div class="screen" id="screen-mod-photo">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üì∑</span><div class="m-info"><div class="m-title">PhotoAvanue</div><div class="m-sub">KMP Camera</div></div></div>
                <div class="module-body">
                    <div class="camera-mock">
                        <div class="viewfinder">üì∑</div>
                        <div class="cam-controls"><div class="cam-btn"></div><div class="cam-btn shutter"></div><div class="cam-btn"></div></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- VideoAvanue -->
        <div class="screen" id="screen-mod-video">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üé¨</span><div class="m-info"><div class="m-title">VideoAvanue</div><div class="m-sub">Media Player</div></div></div>
                <div class="module-body">
                    <div class="video-mock">
                        <div class="play-btn">‚ñ∂Ô∏è</div>
                        <div class="time-bar"><span>12:34</span><div class="progress"><div class="progress-fill"></div></div><span>35:20</span></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Whiteboard -->
        <div class="screen" id="screen-mod-whiteboard">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">‚úèÔ∏è</span><div class="m-info"><div class="m-title">AnnotationAvanue</div><div class="m-sub">Whiteboard + Drawing</div></div></div>
                <div class="module-body">
                    <div class="whiteboard-mock">
                        <div class="wb-toolbar"><div class="wb-tool selected">üñä</div><div class="wb-tool">üñç</div><div class="wb-tool">‚¨ú</div><div class="wb-tool">‚≠ï</div><div class="wb-tool">üßπ</div></div>
                        <svg viewBox="0 0 800 500">
                            <path d="M120,100 Q200,50 280,120 T440,100" stroke="#42A5F5" stroke-width="3" fill="none" opacity="0.8"/>
                            <path d="M150,200 Q250,180 350,220 T500,200" stroke="#4CAF50" stroke-width="3" fill="none" opacity="0.8"/>
                            <rect x="300" y="280" width="180" height="120" rx="8" stroke="#FF9800" stroke-width="2" fill="none" opacity="0.6"/>
                            <circle cx="600" cy="200" r="60" stroke="#9C27B0" stroke-width="2" fill="none" opacity="0.6"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <!-- Files -->
        <div class="screen" id="screen-mod-files">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üìÇ</span><div class="m-info"><div class="m-title">FileAvanue</div><div class="m-sub">File Manager</div></div></div>
                <div class="module-body">
                    <div class="files-mock">
                        <div class="file-row"><span class="f-icon">üìÅ</span><span class="f-name">Documents</span><span class="f-size">24 items</span><span class="f-date">Today</span></div>
                        <div class="file-row"><span class="f-icon">üìÅ</span><span class="f-name">Downloads</span><span class="f-size">18 items</span><span class="f-date">Today</span></div>
                        <div class="file-row"><span class="f-icon">üìÅ</span><span class="f-name">Photos</span><span class="f-size">847 items</span><span class="f-date">Yesterday</span></div>
                        <div class="file-row"><span class="f-icon">üìÑ</span><span class="f-name">Sprint-Notes.md</span><span class="f-size">12 KB</span><span class="f-date">5 min ago</span></div>
                        <div class="file-row"><span class="f-icon">üìÑ</span><span class="f-name">Architecture-Diagram.svg</span><span class="f-size">48 KB</span><span class="f-date">1 hour ago</span></div>
                        <div class="file-row"><span class="f-icon">üìÑ</span><span class="f-name">quantum-computing-2026.pdf</span><span class="f-size">2.4 MB</span><span class="f-date">Today</span></div>
                        <div class="file-row"><span class="f-icon">üé¨</span><span class="f-name">KMP-Tutorial-Ch4.mp4</span><span class="f-size">320 MB</span><span class="f-date">Feb 24</span></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ImageAvanue -->
        <div class="screen" id="screen-mod-image">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üñºÔ∏è</span><div class="m-info"><div class="m-title">ImageAvanue</div><div class="m-sub">Gallery + Filters</div></div></div>
                <div class="module-body">
                    <div class="image-gallery">
                        <div class="gallery-thumb">üèîÔ∏è</div><div class="gallery-thumb">üåÖ</div><div class="gallery-thumb">üèôÔ∏è</div>
                        <div class="gallery-thumb">üåø</div><div class="gallery-thumb">üé®</div><div class="gallery-thumb">üìê</div>
                        <div class="gallery-thumb">üèñÔ∏è</div><div class="gallery-thumb">üå∏</div><div class="gallery-thumb">üåä</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- RemoteCast -->
        <div class="screen" id="screen-mod-cast">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üì°</span><div class="m-info"><div class="m-title">RemoteCast</div><div class="m-sub">Screen Casting + Glass</div></div></div>
                <div class="module-body">
                    <div class="cast-mock">
                        <div class="cast-status">üì°</div>
                        <div style="text-align:center"><div class="cast-label">Ready to Cast</div><div class="cast-sub">No devices connected ‚Ä¢ Port 54321 ‚Ä¢ JPEG 60% ‚Ä¢ 15 FPS</div></div>
                        <button class="cast-btn" onclick="this.textContent='üî¥ Casting...';this.style.background='#F44336'">Start Casting</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Annotation -->
        <div class="screen" id="screen-mod-annotation">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">üé®</span><div class="m-info"><div class="m-title">AnnotationAvanue</div><div class="m-sub">Drawing Tools</div></div></div>
                <div class="module-body">
                    <div class="whiteboard-mock">
                        <div class="wb-toolbar"><div class="wb-tool selected">üñä</div><div class="wb-tool">üñç</div><div class="wb-tool">üßπ</div></div>
                        <svg viewBox="0 0 800 500"><path d="M100,250 C200,100 400,400 600,200 S750,300 780,250" stroke="var(--primary)" stroke-width="4" fill="none"/></svg>
                    </div>
                </div>
            </div>
        </div>
        <!-- Settings -->
        <div class="screen" id="screen-mod-settings">
            <div class="module-screen">
                <div class="module-header"><span class="m-icon">‚öôÔ∏è</span><div class="m-info"><div class="m-title">Settings</div><div class="m-sub">Unified Adaptive Settings</div></div></div>
                <div class="module-body">
                    <div class="settings-mock">
                        <div class="settings-section">Cockpit</div>
                        <div class="settings-row"><span class="s-label">Shell Mode</span><span class="s-value">SearchAvanue ‚ñæ</span></div>
                        <div class="settings-row"><span class="s-label">Default Arrangement</span><span class="s-value">Focus ‚ñæ</span></div>
                        <div class="settings-row"><span class="s-label">Max Frames</span><span class="s-value">6</span></div>
                        <div class="settings-row"><span class="s-label">Head Tracking</span><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
                        <div class="settings-section">Appearance</div>
                        <div class="settings-row"><span class="s-label">Color Palette</span><span class="s-value">HYDRA ‚ñæ</span></div>
                        <div class="settings-row"><span class="s-label">Material Style</span><span class="s-value">Water ‚ñæ</span></div>
                        <div class="settings-row"><span class="s-label">Dark Mode</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
                        <div class="settings-section">Voice</div>
                        <div class="settings-row"><span class="s-label">Wake Word</span><span class="s-value">Hey AVA ‚ñæ</span></div>
                        <div class="settings-row"><span class="s-label">Sensitivity</span><span class="s-value">50%</span></div>
                        <div class="settings-row"><span class="s-label">Voice Isolation</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="action-bar" id="actionBar"></div>

</div>

<script>
// ========== DATA ==========
const TILE_DATA = [
    { id:'web', icon:'üåê', label:'WebAvanue' },
    { id:'photo', icon:'üì∑', label:'PhotoAvanue' },
    { id:'note', icon:'üìù', label:'NoteAvanue' },
    { id:'pdf', icon:'üìÑ', label:'PDFAvanue' },
    { id:'whiteboard', icon:'‚úèÔ∏è', label:'Whiteboard' },
    { id:'video', icon:'üé¨', label:'VideoAvanue' },
    { id:'files', icon:'üìÇ', label:'Files' },
    { id:'image', icon:'üñºÔ∏è', label:'ImageAvanue' },
    { id:'cast', icon:'üì°', label:'RemoteCast' },
    { id:'settings', icon:'‚öôÔ∏è', label:'Settings' },
];

const FREEFORM_POS = [
    {top:30,left:40},{top:30,left:200},{top:30,left:380},{top:30,left:560},{top:30,left:740},
    {top:190,left:100},{top:190,left:300},{top:190,left:500},{top:350,left:40},{top:350,left:240},
];

const MODULES = {
    web:        { title:'WebAvanue', icon:'üåê', actions:['‚Üê Back','‚Üí Fwd','üîÑ Reload','‚≠ê Bookmark','üìã Read Mode'], more:'All Actions' },
    note:       { title:'NoteAvanue', icon:'üìù', actions:['B Bold','I Italic','U Under','‚Ü© Undo','üíæ Save'], more:'Format' },
    pdf:        { title:'PDFAvanue', icon:'üìÑ', actions:['üîç Search','üìë Bookmarks','üåô Night','üìê Fit Width'], more:'View' },
    photo:      { title:'PhotoAvanue', icon:'üì∑', actions:['üîÑ Flip','‚ö° Flash','üéØ Focus','üìè Grid'], more:'Pro Mode' },
    video:      { title:'VideoAvanue', icon:'üé¨', actions:['‚èØ Play','‚è™ -10s','‚è© +10s','üîä Volume','üîÅ Loop'], more:'Speed' },
    whiteboard: { title:'Whiteboard', icon:'‚úèÔ∏è', actions:['üñä Pen','üñç Highlight','üßπ Eraser','‚Ü© Undo','üóë Clear'], more:'Tools' },
    files:      { title:'FileAvanue', icon:'üìÇ', actions:['üìä Sort','üìã List','üìÅ New Folder','üîç Search'], more:'Actions' },
    image:      { title:'ImageAvanue', icon:'üñºÔ∏è', actions:['üîç Zoom','üîÑ Rotate','‚úÇÔ∏è Crop','üé® Filter'], more:'Edit' },
    cast:       { title:'RemoteCast', icon:'üì°', actions:['‚ñ∂Ô∏è Start','‚è∏ Pause','üìä Quality','üîó Devices'], more:'Settings' },
    annotation: { title:'AnnotationAvanue', icon:'üé®', actions:['üñä Pen','üñç Highlight','‚¨ú Shape','‚≠ï Circle','üßπ Eraser'], more:'Tools' },
    settings:   { title:'Settings', icon:'‚öôÔ∏è', actions:['üè† Cockpit','üé® Theme','üé§ Voice','üì± Display','üë§ Profile'], more:'All' },
};

// ========== STATE ==========
let currentShell = 'classic';
let currentModule = null;
let classicLayout = 'grid';
let avLayout = 'stream';
let lensLayout = 'grid';
let spatialZoom = 1.0;

// ========== COCKPIT WORKSPACE STATE ==========
const cockpitState = {
    panels: { left: 'pdf', center: 'web', right: 'video' },
    focusedPanel: 'center',
    maximized: false
};

function renderMiniModule(moduleId) {
    const mod = MODULES[moduleId];
    if (!mod) return '<div style="opacity:0.3;text-align:center;padding:16px">Empty</div>';
    switch (moduleId) {
        case 'web':
            return `<div class="mini-browser-url">üîí techcrunch.com/ai-healthcare</div>
                    <div class="mini-browser-viewport">üåê</div>`;
        case 'note':
            return `<div class="mini-editor-line heading">Sprint Retrospective</div>
                    <div class="mini-editor-line"></div>
                    <div class="mini-editor-line" style="width:80%"></div>
                    <div class="mini-editor-line" style="width:60%"></div>`;
        case 'pdf':
            return `<div class="mini-pdf-page"><span>üìÑ</span><br>Page 1 / 24</div>`;
        case 'video':
            return `<div class="mini-video"><span class="mini-play">‚ñ∂</span></div>
                    <div class="mini-progress"><div class="mini-progress-fill" style="width:35%"></div></div>`;
        case 'photo':
            return `<div class="mini-camera">üì∑</div>`;
        case 'whiteboard':
            return `<svg viewBox="0 0 200 120" style="width:100%;height:60px">
                        <path d="M20,30 Q60,10 100,40 T180,30" stroke="var(--secondary)" stroke-width="2" fill="none"/>
                        <path d="M30,70 Q80,50 140,80" stroke="var(--accent-green)" stroke-width="2" fill="none"/>
                    </svg>`;
        case 'files':
            return `<div class="mini-file-row">üìÅ Documents</div>
                    <div class="mini-file-row">üìÑ Sprint-Notes.md</div>
                    <div class="mini-file-row">üìÑ quantum-2026.pdf</div>`;
        case 'image':
            return `<div class="mini-gallery">
                        <div class="mini-gallery-thumb">üèîÔ∏è</div><div class="mini-gallery-thumb">üåÖ</div>
                        <div class="mini-gallery-thumb">üèôÔ∏è</div><div class="mini-gallery-thumb">üåø</div>
                    </div>`;
        case 'cast':
            return `<div class="mini-cast"><span>üì°</span>Ready</div>`;
        case 'annotation':
            return `<svg viewBox="0 0 200 120" style="width:100%;height:60px">
                        <path d="M20,60 C60,20 120,100 180,50" stroke="var(--primary)" stroke-width="3" fill="none"/>
                    </svg>`;
        case 'settings':
            return `<div class="mini-settings-row"><span>Shell Mode</span><span class="mini-toggle on"></span></div>
                    <div class="mini-settings-row"><span>Dark Mode</span><span class="mini-toggle on"></span></div>
                    <div class="mini-settings-row"><span>Voice</span><span class="mini-toggle"></span></div>`;
        default:
            return `<div style="text-align:center;opacity:0.5;padding:20px">${mod.icon}</div>`;
    }
}

function buildPickerOptions(pos) {
    return Object.entries(MODULES).map(([id, mod]) => {
        const isCurrent = cockpitState.panels[pos] === id;
        return `<div class="panel-picker-option${isCurrent ? ' current' : ''}" onclick="event.stopPropagation(); assignModuleToPanel('${pos}','${id}')">${mod.icon} ${mod.title}${isCurrent ? ' ‚úì' : ''}</div>`;
    }).join('');
}

function togglePanelPicker(pos) {
    document.querySelectorAll('.panel-picker-dropdown').forEach(d => {
        if (d.id !== 'picker-' + pos) d.classList.remove('visible');
    });
    const picker = document.getElementById('picker-' + pos);
    if (picker) picker.classList.toggle('visible');
}

function assignModuleToPanel(pos, moduleId) {
    cockpitState.panels[pos] = moduleId;
    document.querySelectorAll('.panel-picker-dropdown').forEach(d => d.classList.remove('visible'));
    buildClassicLayout('cockpit');
}

function focusCockpitPanel(pos) {
    cockpitState.focusedPanel = pos;
    document.querySelectorAll('.cockpit-panel').forEach(p => {
        p.classList.toggle('focused', p.dataset.position === pos);
    });
    updateCockpitActions();
}

function swapPanels(posA, posB) {
    const tmp = cockpitState.panels[posA];
    cockpitState.panels[posA] = cockpitState.panels[posB];
    cockpitState.panels[posB] = tmp;
    buildClassicLayout('cockpit');
}

function rotatePanels() {
    const { left, center, right } = cockpitState.panels;
    cockpitState.panels.left = right;
    cockpitState.panels.center = left;
    cockpitState.panels.right = center;
    buildClassicLayout('cockpit');
}

function toggleMaximize() {
    cockpitState.maximized = !cockpitState.maximized;
    buildClassicLayout('cockpit');
}

// ‚îÄ‚îÄ Voice Navigation Commands (same vocab as VoiceOS) ‚îÄ‚îÄ
function nextScreen() {
    const order = ['left', 'center', 'right'];
    const idx = order.indexOf(cockpitState.focusedPanel);
    const next = order[Math.min(idx + 1, order.length - 1)];
    focusCockpitPanel(next);
}

function previousScreen() {
    const order = ['left', 'center', 'right'];
    const idx = order.indexOf(cockpitState.focusedPanel);
    const prev = order[Math.max(idx - 1, 0)];
    focusCockpitPanel(prev);
}

function openNewScreen() {
    // Open picker on focused panel to let user choose a module
    togglePanelPicker(cockpitState.focusedPanel);
}

function openApp(appName) {
    // Match appName to a module ID ‚Äî fuzzy match on title or id
    const query = (appName || '').toLowerCase().trim();
    const match = Object.entries(MODULES).find(([id, mod]) =>
        id === query || mod.title.toLowerCase().includes(query)
    );
    if (match) {
        assignModuleToPanel(cockpitState.focusedPanel, match[0]);
    } else {
        // Show picker if no match
        openNewScreen();
    }
}

function closeScreen() {
    // Reset focused panel to a blank/default state by cycling to next available module
    // In 3-panel mode, "close" reassigns the focused panel to settings (neutral)
    const current = cockpitState.panels[cockpitState.focusedPanel];
    const inUse = Object.values(cockpitState.panels);
    const available = Object.keys(MODULES).find(id => !inUse.includes(id)) || 'settings';
    assignModuleToPanel(cockpitState.focusedPanel, available);
}

function updateCockpitActions() {
    const focusedModId = cockpitState.panels[cockpitState.focusedPanel];
    const focusedMod = MODULES[focusedModId];

    // Voice navigation chips (same vocabulary as VoiceOS apps)
    const navItems = [
        { label: '‚óÄ Prev Screen', active: false, action: previousScreen },
        { label: '‚ñ∂ Next Screen', active: false, action: nextScreen },
        { label: '‚ûï Open Screen', active: false, action: openNewScreen },
        { label: '‚úï Close Screen', active: false, action: closeScreen },
    ];

    // Panel management chips
    const panelItems = [
        { label: 'üîÑ Rotate', active: false, action: rotatePanels },
        { label: cockpitState.maximized ? 'üóó Restore' : 'üóñ Maximize', active: cockpitState.maximized, action: toggleMaximize },
    ];

    // Build custom action bar with divider
    const bar = document.getElementById('actionBar');
    bar.innerHTML = '';

    // Voice navigation section (same as app nav commands)
    navItems.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'action-chip' + (item.active ? ' active' : '');
        btn.textContent = item.label;
        btn.onclick = () => { if (item.action) item.action(); };
        bar.appendChild(btn);
    });

    // Divider
    const div1 = document.createElement('div');
    div1.className = 'action-divider';
    bar.appendChild(div1);

    // Panel management section
    panelItems.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'action-chip' + (item.active ? ' active' : '');
        btn.textContent = item.label;
        btn.onclick = () => { if (item.action) item.action(); };
        bar.appendChild(btn);
    });

    // Divider
    const div2 = document.createElement('div');
    div2.className = 'action-divider';
    bar.appendChild(div2);

    // Focused module actions
    if (focusedMod) {
        focusedMod.actions.forEach(a => {
            const btn = document.createElement('button');
            btn.className = 'action-chip';
            btn.textContent = a;
            bar.appendChild(btn);
        });
    }

    // Spacer + Layouts button
    const spacer = document.createElement('div');
    spacer.className = 'action-spacer';
    bar.appendChild(spacer);
    const more = document.createElement('button');
    more.className = 'action-more';
    more.textContent = 'Layouts';
    more.onclick = () => {
        // Temporarily show layout picker
        updateClassicActions();
    };
    bar.appendChild(more);
}

// Close pickers on outside click
document.addEventListener('click', () => {
    document.querySelectorAll('.panel-picker-dropdown').forEach(d => d.classList.remove('visible'));
});

// ========== CLASSIC SHELL LAYOUTS ==========
function buildClassicLayout(layout) {
    classicLayout = layout;
    const container = document.getElementById('classicContainer');
    const label = document.getElementById('classicLayoutLabel');

    // Clear existing
    container.className = '';
    container.innerHTML = '';

    if (layout === 'grid') {
        label.textContent = 'üìê Grid';
        container.className = 'layout-grid';
        TILE_DATA.forEach(t => {
            container.innerHTML += `<div class="tile" onclick="openModule('${t.id}')"><div class="icon">${t.icon}</div><div class="label">${t.label}</div></div>`;
        });
    }
    else if (layout === 'cockpit') {
        label.textContent = '‚úàÔ∏è Cockpit';
        container.className = 'layout-cockpit cockpit-workspace';
        if (cockpitState.maximized) container.classList.add('maximized');

        ['left', 'center', 'right'].forEach(pos => {
            const modId = cockpitState.panels[pos];
            const mod = MODULES[modId];
            if (!mod) return;
            const panel = document.createElement('div');
            panel.className = `cockpit-panel ${pos}`;
            panel.dataset.position = pos;
            if (pos === cockpitState.focusedPanel) panel.classList.add('focused');

            panel.innerHTML = `
                <div class="cockpit-mini-header">
                    <span class="mini-icon">${mod.icon}</span>
                    <span class="mini-title">${mod.title}</span>
                    <button class="mini-expand-btn" onclick="event.stopPropagation(); openModule('${modId}')" title="Full screen">‚õ∂</button>
                    <button class="mini-picker-btn" onclick="event.stopPropagation(); togglePanelPicker('${pos}')" title="Change module">‚ñæ</button>
                </div>
                <div class="mini-module-body">${renderMiniModule(modId)}</div>
                <div class="panel-picker-dropdown" id="picker-${pos}">${buildPickerOptions(pos)}</div>
            `;
            panel.addEventListener('click', () => focusCockpitPanel(pos));
            panel.addEventListener('dblclick', (e) => { e.preventDefault(); toggleMaximize(); });
            container.appendChild(panel);
        });
        updateCockpitActions();
        return; // Skip updateClassicActions ‚Äî cockpit manages its own action bar
    }
    else if (layout === 'carousel') {
        label.textContent = 'üé† Carousel';
        container.className = 'layout-carousel';
        TILE_DATA.forEach(t => {
            container.innerHTML += `<div class="tile" onclick="openModule('${t.id}')"><div class="icon">${t.icon}</div><div class="label">${t.label}</div></div>`;
        });
    }
    else if (layout === 'freeform') {
        label.textContent = 'üé® Freeform';
        container.className = 'layout-freeform';
        container.innerHTML = '<div class="grid-dots"></div>';
        TILE_DATA.forEach((t, i) => {
            const pos = FREEFORM_POS[i];
            const div = document.createElement('div');
            div.className = 'tile';
            div.style.top = pos.top + 'px';
            div.style.left = pos.left + 'px';
            div.innerHTML = `<div class="icon">${t.icon}</div><div class="label">${t.label}</div>`;
            // Draggable
            div.addEventListener('mousedown', function(e) {
                const rect = this.getBoundingClientRect();
                const cRect = container.getBoundingClientRect();
                const ox = e.clientX - rect.left, oy = e.clientY - rect.top;
                let dragged = false;
                const onMove = (me) => { dragged = true; this.style.left = Math.max(0, me.clientX - cRect.left - ox) + 'px'; this.style.top = Math.max(0, me.clientY - cRect.top - oy) + 'px'; };
                const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); if (!dragged) openModule(t.id); };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
                e.preventDefault();
            });
            container.appendChild(div);
        });
    }

    updateClassicActions();
}

function updateClassicActions() {
    if (classicLayout === 'cockpit') { updateCockpitActions(); return; }
    const layouts = [
        { id:'grid', icon:'üìê', label:'Grid' },
        { id:'cockpit', icon:'‚úàÔ∏è', label:'Cockpit' },
        { id:'carousel', icon:'üé†', label:'Carousel' },
        { id:'freeform', icon:'üé®', label:'Freeform' },
    ];
    updateActionBar(
        layouts.map(l => ({ label: `${l.icon} ${l.label}`, active: l.id === classicLayout, action: () => buildClassicLayout(l.id) })),
        'More Layouts'
    );
}

// ========== MAPVIEWS LAYOUTS ==========
function setAVLayout(layout) {
    avLayout = layout;
    const container = document.getElementById('avContainer');
    const label = document.getElementById('avLayoutLabel');

    container.className = 'card-stream';
    container.querySelectorAll('.stream-card').forEach(c => c.classList.remove('hidden-card'));

    if (layout === 'stream') {
        label.textContent = 'üìã Stream';
    } else if (layout === 'compact') {
        label.textContent = 'üìë Compact';
        container.classList.add('layout-compact');
    } else if (layout === 'grid') {
        label.textContent = 'üìê Grid View';
        container.classList.add('layout-grid-view');
    } else if (layout === 'timeline') {
        label.textContent = 'üìÖ Timeline';
        container.classList.add('layout-timeline');
    }
    updateAVActions();
}

function filterAVCards(cat) {
    const container = document.getElementById('avContainer');
    container.querySelectorAll('.stream-card').forEach(c => {
        if (cat === 'all') { c.classList.remove('hidden-card'); }
        else { c.classList.toggle('hidden-card', c.dataset.cat !== cat); }
    });
}

function updateAVActions() {
    const layouts = [
        { id:'stream', icon:'üìã', label:'Stream' },
        { id:'compact', icon:'üìë', label:'Compact' },
        { id:'grid', icon:'üìê', label:'Grid' },
        { id:'timeline', icon:'üìÖ', label:'Timeline' },
    ];
    updateActionBar(
        layouts.map(l => ({ label: `${l.icon} ${l.label}`, active: l.id === avLayout, action: () => setAVLayout(l.id) })),
        'Filter'
    );
}

// ========== SEARCHAVANUE LAYOUTS ==========
function setLensLayout(layout) {
    lensLayout = layout;
    const grid = document.getElementById('quickGrid');
    grid.className = 'quick-grid';
    if (layout === 'list') grid.classList.add('layout-list');
    else if (layout === 'compact') grid.classList.add('layout-compact');
    updateLensActions();
}

function updateLensActions() {
    const layouts = [
        { id:'grid', icon:'üìê', label:'Grid' },
        { id:'list', icon:'üìã', label:'List' },
        { id:'compact', icon:'üìë', label:'Compact' },
    ];
    updateActionBar(
        layouts.map(l => ({ label: `${l.icon} ${l.label}`, active: l.id === lensLayout, action: () => setLensLayout(l.id) })),
        'üé§ Voice'
    );
}

// ========== SPATIAL ‚Äî USAGE-BASED ISLANDS ==========
// Simulated usage stats (0-100): higher = more recently/frequently used
const SPATIAL_USAGE = {
    web: 95, note: 82, photo: 70, pdf: 60, video: 55,
    whiteboard: 40, files: 35, image: 28, cast: 15, settings: 10,
};

function buildSpatialIslands() {
    const space = document.getElementById('spatialSpace');
    // Keep the grid background, remove old islands
    space.querySelectorAll('.island').forEach(el => el.remove());

    // Sort by usage (highest first)
    const sorted = Object.entries(SPATIAL_USAGE).sort((a, b) => b[1] - a[1]);

    // Map usage to depth + size: top 3 = near/lg, next 4 = mid/md, rest = far/sm
    const layout = sorted.map(([modId, usage], i) => {
        let depth, size;
        if (i < 3) { depth = 'depth-near'; size = 'size-lg'; }
        else if (i < 7) { depth = 'depth-mid'; size = 'size-md'; }
        else { depth = 'depth-far'; size = 'size-sm'; }
        return { modId, usage, depth, size };
    });

    // Smart staggered placement: 3 columns, cascade within each column
    // High-usage items cluster center-top, low-usage items drift to edges
    const cols = 3;
    const colWidth = 320;
    const startX = 50;
    const colOffsets = [0, 0, 0]; // track Y offset per column

    layout.forEach((item, i) => {
        const mod = MODULES[item.modId];
        if (!mod) return;
        const col = i % cols;
        const baseX = startX + col * colWidth;
        // Stagger: offset odd items right, add slight randomness
        const jitterX = (i % 2 === 1) ? 60 : 0;
        const jitterY = (i * 17) % 30; // deterministic pseudo-random
        const top = colOffsets[col] + 30 + jitterY;
        const left = baseX + jitterX;
        colOffsets[col] = top + (item.depth === 'depth-near' ? 170 : item.depth === 'depth-mid' ? 140 : 110);

        const island = document.createElement('div');
        island.className = `island ${item.depth} ${item.size}`;
        island.style.top = top + 'px';
        island.style.left = left + 'px';
        island.dataset.mod = item.modId;

        // Usage indicator bar
        const usageBar = `<div style="height:2px;background:rgba(21,101,192,0.3);border-radius:1px;margin-top:4px;overflow:hidden"><div style="height:100%;width:${item.usage}%;background:var(--primary);border-radius:1px"></div></div>`;

        island.innerHTML = `<div class="i-icon">${mod.icon}</div><div class="i-label">${mod.title}</div>${usageBar}`;

        // Add mini module preview for near and mid depth
        if (item.depth !== 'depth-far') {
            const preview = document.createElement('div');
            preview.className = 'island-preview';
            preview.innerHTML = renderMiniModule(item.modId);
            island.appendChild(preview);
        }

        // Draggable + click to open
        island.addEventListener('mousedown', function(e) {
            const rect = this.getBoundingClientRect();
            const container = this.parentElement.getBoundingClientRect();
            const ox = e.clientX - rect.left, oy = e.clientY - rect.top;
            let dragged = false;
            const onMove = (me) => {
                dragged = true;
                this.style.left = Math.max(0, (me.clientX - container.left - ox) / spatialZoom) + 'px';
                this.style.top = Math.max(0, (me.clientY - container.top - oy) / spatialZoom) + 'px';
            };
            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                if (!dragged) openModule(this.dataset.mod);
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
            e.preventDefault();
        });

        space.appendChild(island);
    });
}

function setSpatialZoom(zoom) {
    spatialZoom = zoom;
    document.getElementById('spatialSpace').style.transform = `scale(${zoom})`;
    document.getElementById('spatialZoomLabel').textContent = `Zoom: ${Math.round(zoom * 100)}%`;
    updateSpatialActions();
}

function resetSpatialPositions() {
    buildSpatialIslands();
    setSpatialZoom(1.0);
}

function updateSpatialActions() {
    const zooms = [
        { z: 1.0, label:'üîç 1.0x' },
        { z: 0.75, label:'üîç 0.75x' },
        { z: 0.5, label:'üîç 0.5x' },
        { z: 1.25, label:'üîç 1.25x' },
    ];
    const items = zooms.map(z => ({ label: z.label, active: spatialZoom === z.z, action: () => setSpatialZoom(z.z) }));
    items.push({ label:'‚Ü©Ô∏è Reset', active: false, action: resetSpatialPositions });
    updateActionBar(items, 'SpaceAvanue Settings');
}

// ========== GENERIC ACTION BAR ==========
function updateActionBar(items, moreLabel) {
    const bar = document.getElementById('actionBar');
    bar.innerHTML = '';
    items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'action-chip' + (item.active ? ' active' : '');
        btn.textContent = item.label;
        btn.onclick = () => { if (item.action) item.action(); };
        bar.appendChild(btn);
    });
    const spacer = document.createElement('div');
    spacer.className = 'action-spacer';
    bar.appendChild(spacer);
    const more = document.createElement('button');
    more.className = 'action-more';
    more.textContent = moreLabel;
    bar.appendChild(more);
}

function updateModuleActionBar(mod) {
    const info = MODULES[mod];
    if (!info) return;
    updateActionBar(
        info.actions.map(a => ({ label: a, active: false, action: () => {} })),
        info.more
    );
}

// ========== NAVIGATION ==========
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchShell(btn.dataset.shell));
});

function switchShell(shell) {
    currentShell = shell;
    currentModule = null;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-shell="${shell}"]`).classList.add('active');
    showScreen('screen-' + shell);
    document.getElementById('shellTabs').classList.remove('hidden');
    document.getElementById('backBtn').classList.remove('visible');
    document.getElementById('navTitle').textContent = 'Voice-First UI Shells';
    const names = { classic:'CockpitAvanue', 'avanue-views':'MapViews', lens:'SearchAvanue', spatial:'SpaceAvanue' };
    document.getElementById('shellBadge').textContent = names[shell] || shell;

    if (shell === 'classic') updateClassicActions();
    else if (shell === 'avanue-views') updateAVActions();
    else if (shell === 'lens') updateLensActions();
    else if (shell === 'spatial') updateSpatialActions();
}

function openModule(mod) {
    const info = MODULES[mod];
    if (!info) return;
    currentModule = mod;
    showScreen('screen-mod-' + mod);
    document.getElementById('shellTabs').classList.add('hidden');
    document.getElementById('backBtn').classList.add('visible');
    document.getElementById('navTitle').textContent = info.title;
    document.getElementById('shellBadge').textContent = info.icon + ' Module';
    updateModuleActionBar(mod);
}

function goBack() { currentModule = null; switchShell(currentShell); }

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
}

// ========== LENS SEARCH ==========
const SEARCHABLE = Object.entries(MODULES).map(([k,v]) => ({id:k, title:v.title, icon:v.icon, type:'Module'}));
SEARCHABLE.push(
    {id:'_cmd', title:'Take Screenshot', icon:'üì∏', type:'Command'},
    {id:'_cmd', title:'Start Dictation', icon:'üé§', type:'Command'},
    {id:'_cmd', title:'Toggle Dark Mode', icon:'üåô', type:'Setting'},
    {id:'_cmd', title:'Change Shell Mode', icon:'üîÑ', type:'Setting'},
    {id:'_cmd', title:'Export as PDF', icon:'üì§', type:'Command'},
    {id:'_cmd', title:'Voice Commands Help', icon:'‚ùì', type:'Help'},
);

function onLensInput(query) {
    const results = document.getElementById('lensResults');
    const grid = document.getElementById('quickGrid');
    if (!query.trim()) { results.classList.remove('visible'); grid.style.display=''; return; }
    grid.style.display='none';
    const matches = SEARCHABLE.filter(s => s.title.toLowerCase().includes(query.toLowerCase()));
    results.innerHTML = matches.slice(0,8).map(m => {
        const previewHtml = (m.type === 'Module' && m.id !== '_cmd')
            ? `<div class="result-preview">${renderMiniModule(m.id)}</div>` : '';
        return `<div class="lens-result-item" onclick="${m.id!=='_cmd' ? `openModule('${m.id}')` : ''}">
            <span class="r-icon">${m.icon}</span><span class="r-label">${m.title}</span><span class="r-type">${m.type}</span>
            ${previewHtml}
        </div>`;
    }).join('');
    results.classList.add('visible');
}

// ========== KEYBOARD SHORTCUTS ==========
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && classicLayout === 'cockpit' && cockpitState.maximized) { toggleMaximize(); return; }
    if (e.key === 'Escape' && currentModule) goBack();
    // Cockpit panel navigation (arrow keys = next/previous screen)
    if (currentShell === 'classic' && classicLayout === 'cockpit' && !currentModule) {
        if (e.key === 'ArrowRight') { e.preventDefault(); nextScreen(); return; }
        if (e.key === 'ArrowLeft') { e.preventDefault(); previousScreen(); return; }
        if (e.key === 'n' && !e.metaKey && !e.ctrlKey) { openNewScreen(); return; }
        if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); closeScreen(); return; }
    }
    const shells = ['classic','avanue-views','lens','spatial'];
    if (e.key >= '1' && e.key <= '4' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault(); switchShell(shells[parseInt(e.key)-1]);
    }
    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault(); switchShell('lens');
        setTimeout(() => document.getElementById('lensInput')?.focus(), 100);
    }
});

// ========== INIT ==========
buildClassicLayout('grid');

// Inject MapViews mini module previews
['note','pdf','photo','web','whiteboard','video'].forEach(modId => {
    const el = document.getElementById('av-preview-' + modId);
    if (el) el.innerHTML = renderMiniModule(modId);
});

// Build usage-based spatial islands dynamically
buildSpatialIslands();
</script>
</body>
</html>
