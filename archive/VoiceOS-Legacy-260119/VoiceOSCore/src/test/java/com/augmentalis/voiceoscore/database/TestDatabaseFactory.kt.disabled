/**
 * TestDatabaseFactory.kt - Factory for creating SQLDelight test databases
 *
 * Provides in-memory SQLDelight databases for testing.
 * Replaces Room's in-memory database functionality.
 *
 * Copyright (C) Manoj Jhawar/Aman Jhawar, Intelligent Devices LLC
 * Author: Agent 4 - Test Migration Specialist
 * Created: 2025-11-27
 * Context: Phase 4 - Restoration Plan Production-Ready
 */
package com.augmentalis.voiceoscore.database

import android.content.Context
import app.cash.sqldelight.db.SqlDriver
import app.cash.sqldelight.driver.jdbc.sqlite.JdbcSqliteDriver
import com.augmentalis.database.VoiceOSDatabase
import com.augmentalis.database.VoiceOSDatabaseManager
import io.mockk.mockk

/**
 * Factory for creating test databases.
 *
 * Creates in-memory SQLDelight databases suitable for unit testing.
 * Each test gets a fresh database instance to ensure isolation.
 */
object TestDatabaseFactory {

    /**
     * Creates an in-memory SQLDelight database for testing.
     *
     * The database is created with all tables and is ready to use.
     * It will be automatically cleaned up when the test completes.
     *
     * @return VoiceOSDatabaseManager instance with in-memory database
     */
    fun createTestDatabase(): VoiceOSDatabaseManager {
        val driver = createTestDriver()
        val database = VoiceOSDatabase(driver)

        return VoiceOSDatabaseManager(
            database = database,
            context = mockk<Context>(relaxed = true)
        )
    }

    /**
     * Creates a test SQL driver (in-memory).
     *
     * Uses JDBC SQLite driver with in-memory database.
     * Schema is automatically created from SQLDelight definitions.
     *
     * @return SqlDriver configured for testing
     */
    fun createTestDriver(): SqlDriver {
        val driver = JdbcSqliteDriver(JdbcSqliteDriver.IN_MEMORY)
        VoiceOSDatabase.Schema.create(driver)
        return driver
    }

    /**
     * Creates a test database with custom schema version.
     *
     * Useful for testing migrations.
     *
     * @param version Schema version to create
     * @return SqlDriver at specified version
     */
    fun createTestDriverAtVersion(version: Long): SqlDriver {
        val driver = JdbcSqliteDriver(JdbcSqliteDriver.IN_MEMORY)

        // Create schema up to specified version
        if (version == 1L) {
            VoiceOSDatabase.Schema.create(driver)
        } else {
            VoiceOSDatabase.Schema.create(driver)
            VoiceOSDatabase.Schema.migrate(driver, 1, version)
        }

        return driver
    }

    /**
     * Clears all data from a database while keeping schema.
     *
     * Useful for resetting database state between test cases.
     *
     * @param manager Database manager to clear
     */
    fun clearDatabase(manager: VoiceOSDatabaseManager) {
        manager.database.transaction {
            // Clear all tables (add more as schema grows)
            manager.database.scrapedElementQueries.deleteAll()
            manager.database.generatedCommandQueries.deleteAll()
            // Add more table clears here as needed
        }
    }

    /**
     * Closes and cleans up a test database.
     *
     * Should be called in test teardown.
     *
     * @param manager Database manager to close
     */
    fun closeDatabase(manager: VoiceOSDatabaseManager) {
        // Database driver cleanup handled by JVM
        // No explicit close needed for in-memory database
    }
}
