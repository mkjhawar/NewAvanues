# Avanues iOS - CI/CD Build Pipeline
# Runs on PRs targeting IosVoiceOS-Development and main branches

name: iOS Build

on:
  push:
    branches:
      - IosVoiceOS-Development
    paths:
      - 'Apps/iOS/**'
      - 'Modules/AvanuesShared/**'
      - 'Modules/VoiceOSCore/**'
      - 'Modules/Database/**'
      - 'Modules/Foundation/**'
      - 'Modules/AVID/**'
      - 'Modules/SpeechRecognition/**'
      - 'Modules/AI/NLU/**'
  pull_request:
    branches:
      - IosVoiceOS-Development
      - main

# Cancel in-progress runs for the same branch
concurrency:
  group: ios-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-kmp-framework:
    name: Build KMP Shared Framework
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', 'gradle/libs.versions.toml') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Generate podspec
        run: |
          ./gradlew :Modules:AvanuesShared:podspec \
            -Pkotlin.mpp.enableNativeTargets=true

      - name: Build iOS framework (Simulator)
        run: |
          ./gradlew :Modules:AvanuesShared:linkDebugFrameworkIosSimulatorArm64 \
            -Pkotlin.mpp.enableNativeTargets=true

      - name: Upload framework artifact
        uses: actions/upload-artifact@v4
        with:
          name: avanues-shared-framework
          path: Modules/AvanuesShared/build/bin/iosSimulatorArm64/debugFramework/
          retention-days: 7

  build-ios-app:
    name: Build iOS App
    needs: build-kmp-framework
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Install CocoaPods
        run: gem install cocoapods

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', 'gradle/libs.versions.toml') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Apps/iOS/Avanues/Pods
          key: pods-${{ runner.os }}-${{ hashFiles('Apps/iOS/Avanues/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-

      - name: Generate podspec + framework
        run: |
          ./gradlew :Modules:AvanuesShared:podInstall \
            -Pkotlin.mpp.enableNativeTargets=true

      - name: Install Pods
        working-directory: Apps/iOS/Avanues
        run: pod install

      - name: Generate Xcode project
        working-directory: Apps/iOS/Avanues
        run: xcodegen generate

      - name: Build (xcodebuild)
        working-directory: Apps/iOS/Avanues
        run: |
          xcodebuild build \
            -workspace Avanues.xcworkspace \
            -scheme Avanues \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Run Tests
        working-directory: Apps/iOS/Avanues
        run: |
          xcodebuild test \
            -workspace Avanues.xcworkspace \
            -scheme Avanues \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true
