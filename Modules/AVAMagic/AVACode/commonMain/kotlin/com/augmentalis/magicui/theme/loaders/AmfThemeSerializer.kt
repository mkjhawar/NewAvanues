package com.augmentalis.avamagic.theme.loaders

import com.augmentalis.avamagic.theme.*

/**
 * Serializes AvaUI themes to AMF (AvaMagic Format).
 *
 * Produces compact, line-based output that can be loaded by [AmfThemeLoader].
 *
 * ## Output Format
 *
 * ```
 * # AvaMagic Theme: Dark Theme
 * # Generated by AmfThemeSerializer
 * ---
 * schema: amf-thm-1.0
 * ---
 * THM:Dark Theme:1.0.0
 * PAL:primary:#007AFF
 * PAL:secondary:#5AC8FA
 * ...
 * ```
 *
 * ## Usage Example
 *
 * ```kotlin
 * val theme = ThemeConfig(...)
 * val amfContent = AmfThemeSerializer.serialize(theme)
 * File("theme.amf").writeText(amfContent)
 * ```
 *
 * @since 3.2.0
 * @see AmfThemeParser for format specification
 * @see AmfThemeLoader for loading
 */
object AmfThemeSerializer {

    private const val SCHEMA_VERSION = "amf-thm-1.0"
    private const val THEME_VERSION = "1.0.0"

    /**
     * Serialize ThemeConfig to AMF format string.
     *
     * @param theme The theme configuration to serialize
     * @param includeDefaults Whether to include fields with default values
     * @return AMF format string
     */
    fun serialize(theme: ThemeConfig, includeDefaults: Boolean = false): String {
        return buildString {
            // Header
            appendLine("# AvaMagic Theme: ${theme.name}")
            appendLine("# Generated by AmfThemeSerializer")
            appendLine("---")
            appendLine("schema: $SCHEMA_VERSION")
            appendLine("---")

            // Theme metadata
            appendLine("THM:${theme.name}:$THEME_VERSION")

            // Palette
            serializePalette(theme.palette, includeDefaults)

            // Typography
            serializeTypography(theme.typography, includeDefaults)

            // Spacing
            serializeSpacing(theme.spacing, includeDefaults)

            // Effects
            serializeEffects(theme.effects, includeDefaults)
        }
    }

    private fun StringBuilder.serializePalette(palette: ThemePalette, includeDefaults: Boolean) {
        appendLine("PAL:primary:${palette.primary}")
        appendLine("PAL:secondary:${palette.secondary}")
        appendLine("PAL:background:${palette.background}")
        appendLine("PAL:surface:${palette.surface}")
        appendLine("PAL:error:${palette.error}")

        if (includeDefaults || palette.onPrimary != "#FFFFFF") {
            appendLine("PAL:onPrimary:${palette.onPrimary}")
        }
        if (includeDefaults || palette.onSecondary != "#FFFFFF") {
            appendLine("PAL:onSecondary:${palette.onSecondary}")
        }
        if (includeDefaults || palette.onBackground != "#FFFFFF") {
            appendLine("PAL:onBackground:${palette.onBackground}")
        }
        if (includeDefaults || palette.onSurface != "#FFFFFF") {
            appendLine("PAL:onSurface:${palette.onSurface}")
        }
        if (includeDefaults || palette.onError != "#FFFFFF") {
            appendLine("PAL:onError:${palette.onError}")
        }
    }

    private fun StringBuilder.serializeTypography(typography: ThemeTypography, includeDefaults: Boolean) {
        serializeTextStyle("h1", typography.h1, 28f, "bold")
        serializeTextStyle("h2", typography.h2, 22f, "bold")
        serializeTextStyle("body", typography.body, 16f, "regular")
        serializeTextStyle("caption", typography.caption, 12f, "regular")
    }

    private fun StringBuilder.serializeTextStyle(
        name: String,
        style: TextStyle,
        defaultSize: Float,
        defaultWeight: String
    ) {
        // TYP:style:size:weight:family
        appendLine("TYP:$name:${style.size.toInt()}:${style.weight}:${style.fontFamily}")
    }

    private fun StringBuilder.serializeSpacing(spacing: ThemeSpacing, includeDefaults: Boolean) {
        // SPC:xs:4:sm:8:md:16:lg:24:xl:32
        append("SPC:")
        append("xs:${spacing.xs.toInt()}:")
        append("sm:${spacing.sm.toInt()}:")
        append("md:${spacing.md.toInt()}:")
        append("lg:${spacing.lg.toInt()}:")
        appendLine("xl:${spacing.xl.toInt()}")
    }

    private fun StringBuilder.serializeEffects(effects: ThemeEffects, includeDefaults: Boolean) {
        // EFX:shadow:true:blur:8:elevation:4
        append("EFX:")
        append("shadow:${effects.shadowEnabled}:")
        append("blur:${effects.blurRadius.toInt()}:")
        appendLine("elevation:${effects.elevation.toInt()}")
    }

    /**
     * Serialize to compact single-line format (for embedding).
     *
     * Useful for storing in databases or transmitting over network.
     * Uses pipe (|) as line separator.
     *
     * @param theme The theme configuration to serialize
     * @return Compact single-line AMF string
     */
    fun serializeCompact(theme: ThemeConfig): String {
        return serialize(theme, includeDefaults = false)
            .lines()
            .filter { it.isNotBlank() && !it.startsWith("#") }
            .joinToString("|")
    }
}
