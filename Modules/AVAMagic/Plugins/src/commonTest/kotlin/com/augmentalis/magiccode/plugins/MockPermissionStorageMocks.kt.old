package com.augmentalis.magiccode.plugins

import com.augmentalis.magiccode.plugins.security.PermissionStorage
import com.augmentalis.magiccode.plugins.security.PluginPermissionState

/**
 * Mock implementation of PermissionStorage for testing.
 *
 * Maintains an in-memory storage for permission state without actual disk I/O.
 */
class MockPermissionStorage : PermissionStorage {
    private val storage = mutableMapOf<String, PluginPermissionState>()

    // Test configuration
    var shouldFailSaves = false
    var shouldFailLoads = false
    var shouldFailDeletes = false

    // Tracking for verification
    var saveCount = 0
    var loadCount = 0
    var deleteCount = 0
    var loadAllCount = 0

    override suspend fun save(state: PluginPermissionState) {
        if (shouldFailSaves) {
            throw RuntimeException("Mock save failure")
        }
        storage[state.pluginId] = state
        saveCount++
    }

    override suspend fun load(pluginId: String): PluginPermissionState? {
        if (shouldFailLoads) {
            throw RuntimeException("Mock load failure")
        }
        loadCount++
        return storage[pluginId]
    }

    override suspend fun delete(pluginId: String) {
        if (shouldFailDeletes) {
            throw RuntimeException("Mock delete failure")
        }
        storage.remove(pluginId)
        deleteCount++
    }

    override suspend fun loadAll(): Map<String, PluginPermissionState> {
        if (shouldFailLoads) {
            throw RuntimeException("Mock loadAll failure")
        }
        loadAllCount++
        return storage.toMap()
    }

    /**
     * Add a permission state directly to storage (for test setup).
     */
    fun addState(state: PluginPermissionState) {
        storage[state.pluginId] = state
    }

    /**
     * Get all stored states (for verification).
     */
    fun getAllStates(): Map<String, PluginPermissionState> {
        return storage.toMap()
    }

    /**
     * Clear all stored data and reset counters.
     */
    fun reset() {
        storage.clear()
        saveCount = 0
        loadCount = 0
        deleteCount = 0
        loadAllCount = 0
        shouldFailSaves = false
        shouldFailLoads = false
        shouldFailDeletes = false
    }

    /**
     * Check if storage contains state for a plugin.
     */
    fun contains(pluginId: String): Boolean {
        return storage.containsKey(pluginId)
    }

    /**
     * Get the number of stored plugin states.
     */
    fun size(): Int {
        return storage.size
    }
}
