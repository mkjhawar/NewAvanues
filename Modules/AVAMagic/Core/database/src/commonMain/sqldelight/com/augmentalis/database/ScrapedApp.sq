-- ScrapedApp.sq
-- App metadata for UI scraping

CREATE TABLE scraped_app (
    appId TEXT PRIMARY KEY NOT NULL,
    packageName TEXT NOT NULL,
    versionCode INTEGER NOT NULL,
    versionName TEXT NOT NULL,
    appHash TEXT NOT NULL,
    isFullyLearned INTEGER NOT NULL DEFAULT 0,
    learnCompletedAt INTEGER,
    scrapingMode TEXT NOT NULL DEFAULT 'DYNAMIC',
    scrapeCount INTEGER NOT NULL DEFAULT 0,
    elementCount INTEGER NOT NULL DEFAULT 0,
    commandCount INTEGER NOT NULL DEFAULT 0,
    firstScrapedAt INTEGER NOT NULL,
    lastScrapedAt INTEGER NOT NULL,
    pkg_hash TEXT  -- Pre-computed package hash for compact VUID format
);

CREATE INDEX idx_sa_package ON scraped_app(packageName);
CREATE INDEX idx_sa_learned ON scraped_app(isFullyLearned);
CREATE INDEX idx_sa_pkg_hash ON scraped_app(pkg_hash);

insert:
INSERT OR REPLACE INTO scraped_app VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

getById:
SELECT * FROM scraped_app WHERE appId = ?;

getByPackage:
SELECT * FROM scraped_app WHERE packageName = ?;

getByHash:
SELECT * FROM scraped_app WHERE appHash = ?;

getByPkgHash:
SELECT * FROM scraped_app WHERE pkg_hash = ?;

getAll:
SELECT * FROM scraped_app ORDER BY lastScrapedAt DESC;

getFullyLearned:
SELECT * FROM scraped_app WHERE isFullyLearned = 1;

updateStats:
UPDATE scraped_app
SET scrapeCount = ?, elementCount = ?, commandCount = ?, lastScrapedAt = ?
WHERE appId = ?;

incrementScrapeCount:
UPDATE scraped_app
SET scrapeCount = scrapeCount + 1, lastScrapedAt = ?
WHERE appId = ?;

updateElementCount:
UPDATE scraped_app
SET elementCount = ?
WHERE appId = ?;

updateCommandCount:
UPDATE scraped_app
SET commandCount = ?
WHERE appId = ?;

updateScrapingMode:
UPDATE scraped_app
SET scrapingMode = ?
WHERE appId = ?;

markFullyLearned:
UPDATE scraped_app SET isFullyLearned = 1, learnCompletedAt = ? WHERE appId = ?;

markAsFullyLearned:
UPDATE scraped_app SET isFullyLearned = 1, learnCompletedAt = ? WHERE appId = ?;

deleteById:
DELETE FROM scraped_app WHERE appId = ?;

deleteAll:
DELETE FROM scraped_app;

count:
SELECT COUNT(*) FROM scraped_app;
