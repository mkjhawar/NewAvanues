-- Train example table for Teach-Ava user training and LLM self-learning
-- Migrated from Room TrainExampleEntity
-- VOS4 Patterns: Hash-based deduplication, usage tracking
-- ADR-013: Extended for LLM-as-Teacher self-learning architecture

CREATE TABLE train_example (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    example_hash TEXT NOT NULL UNIQUE,
    utterance TEXT NOT NULL,
    intent TEXT NOT NULL,
    locale TEXT NOT NULL DEFAULT 'en-US',
    source TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    usage_count INTEGER NOT NULL DEFAULT 0,
    last_used INTEGER,
    -- ADR-013: Self-learning columns
    confidence REAL NOT NULL DEFAULT 0.8,
    user_confirmed INTEGER NOT NULL DEFAULT 0,
    times_matched INTEGER NOT NULL DEFAULT 0,
    embedding_vector BLOB,
    embedding_dimension INTEGER NOT NULL DEFAULT 384
);

CREATE INDEX idx_train_example_intent ON train_example(intent);
CREATE INDEX idx_train_example_locale ON train_example(locale);
CREATE INDEX idx_train_example_created_at ON train_example(created_at);
CREATE UNIQUE INDEX idx_train_example_hash ON train_example(example_hash);

-- Insert or replace (VOS4 INSERT OR REPLACE pattern)
insert:
INSERT OR REPLACE INTO train_example (
    example_hash, utterance, intent, locale, source, created_at, usage_count, last_used,
    confidence, user_confirmed, times_matched, embedding_vector, embedding_dimension
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

-- Insert with embedding (ADR-013: Self-learning)
insertWithEmbedding:
INSERT OR REPLACE INTO train_example (
    example_hash, utterance, intent, locale, source, created_at, usage_count, last_used,
    confidence, user_confirmed, times_matched, embedding_vector, embedding_dimension
) VALUES (?, ?, ?, ?, ?, ?, 0, NULL, ?, 0, 0, ?, ?);

-- Select all examples
selectAll:
SELECT * FROM train_example
ORDER BY created_at DESC;

-- Select by intent
selectByIntent:
SELECT * FROM train_example
WHERE intent = ?
ORDER BY created_at DESC;

-- Select by locale
selectByLocale:
SELECT * FROM train_example
WHERE locale = ?
ORDER BY created_at DESC;

-- Select by source
selectBySource:
SELECT * FROM train_example
WHERE source = ?
ORDER BY created_at DESC;

-- Count total examples
count:
SELECT COUNT(*) FROM train_example;

-- Count by intent
countByIntent:
SELECT COUNT(*) FROM train_example
WHERE intent = ?;

-- Update usage stats
updateUsageStats:
UPDATE train_example
SET usage_count = usage_count + 1, last_used = ?
WHERE id = ?;

-- Delete by ID
delete:
DELETE FROM train_example
WHERE id = ?;

-- Delete by intent
deleteByIntent:
DELETE FROM train_example
WHERE intent = ?;

-- Find by hash (for duplicate checking)
findByHash:
SELECT * FROM train_example
WHERE example_hash = ?
LIMIT 1;

-- Insert and return ID
insertWithReturn:
INSERT INTO train_example (
    example_hash, utterance, intent, locale, source, created_at, usage_count, last_used,
    confidence, user_confirmed, times_matched, embedding_vector, embedding_dimension
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

-- Get last insert row id
lastInsertRowId:
SELECT last_insert_rowid();

-- ADR-013: Self-Learning NLU Queries --

-- Find by utterance (exact match)
findByUtterance:
SELECT * FROM train_example
WHERE utterance = ?
LIMIT 1;

-- Find by utterance with embedding
findByUtteranceWithEmbedding:
SELECT * FROM train_example
WHERE utterance = ? AND embedding_vector IS NOT NULL
LIMIT 1;

-- Select all with embeddings (for NLU matching)
selectAllWithEmbeddings:
SELECT * FROM train_example
WHERE embedding_vector IS NOT NULL
ORDER BY times_matched DESC, confidence DESC;

-- Select by source with stats
selectBySourceWithStats:
SELECT source, COUNT(*) AS count FROM train_example
GROUP BY source;

-- Get learning stats by source
getLearningStats:
SELECT
    COUNT(*) AS total,
    SUM(CASE WHEN source = 'llm_auto' THEN 1 ELSE 0 END) AS llm_auto,
    SUM(CASE WHEN source = 'llm_variation' THEN 1 ELSE 0 END) AS llm_variation,
    SUM(CASE WHEN source = 'user' OR source = 'user_taught' THEN 1 ELSE 0 END) AS user_taught,
    SUM(CASE WHEN user_confirmed = 1 THEN 1 ELSE 0 END) AS confirmed
FROM train_example;

-- Confirm utterance (user feedback)
confirmUtterance:
UPDATE train_example
SET user_confirmed = 1, confidence = MIN(confidence + 0.1, 1.0)
WHERE utterance = ?;

-- Increment match count
incrementMatchCount:
UPDATE train_example
SET times_matched = times_matched + 1, last_used = ?
WHERE utterance = ?;

-- Update embedding for utterance
updateEmbedding:
UPDATE train_example
SET embedding_vector = ?, embedding_dimension = ?
WHERE utterance = ?;

-- Delete by utterance
deleteByUtterance:
DELETE FROM train_example
WHERE utterance = ?;

-- Delete all learned (non-bundled) examples
deleteAllLearned:
DELETE FROM train_example
WHERE source IN ('llm_auto', 'llm_variation', 'llm_confirmed');

-- Select high-confidence learned for export
selectHighConfidenceLearned:
SELECT * FROM train_example
WHERE confidence >= 0.8 AND times_matched >= 3
ORDER BY confidence DESC, times_matched DESC;

-- Select low-confidence for review
selectLowConfidenceForReview:
SELECT * FROM train_example
WHERE confidence < 0.7 AND user_confirmed = 0
ORDER BY created_at DESC
LIMIT 50;
