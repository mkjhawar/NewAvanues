/**
 * BaseRepositoryTest.kt - Base test class for repository tests in VoiceOSCore
 *
 * Provides common database setup and teardown for all repository tests.
 * Uses in-memory SQLite database for fast, isolated testing.
 *
 * Copyright (C) Manoj Jhawar/Aman Jhawar, Intelligent Devices LLC
 */

package com.augmentalis.voiceoscore.test.infrastructure

import com.augmentalis.database.VoiceOSDatabase
import com.augmentalis.database.VoiceOSDatabaseManager
import kotlinx.coroutines.ExperimentalCoroutinesApi
import org.junit.After
import org.junit.Before
import org.junit.Rule

/**
 * Base class for all repository integration tests in VoiceOSCore.
 *
 * Subclasses automatically get:
 * - Fresh in-memory database before each test
 * - Proper cleanup after each test
 * - Access to database and databaseManager with all repositories
 * - Coroutine test dispatcher for async testing
 */
@ExperimentalCoroutinesApi
abstract class BaseRepositoryTest {

    @get:Rule
    val coroutineRule = CoroutineTestRule()

    protected lateinit var database: VoiceOSDatabase
    protected lateinit var databaseManager: VoiceOSDatabaseManager
    private lateinit var driver: app.cash.sqldelight.db.SqlDriver

    @Before
    open fun setup() {
        driver = TestDatabaseDriverFactory().createDriver()
        database = VoiceOSDatabase(driver)

        // Create database manager with test driver factory
        databaseManager = VoiceOSDatabaseManager(TestDatabaseDriverFactory())
    }

    @After
    open fun teardown() {
        driver.close()
    }

    /**
     * Clear all data from the database.
     * Useful between test methods.
     */
    protected fun clearDatabase() {
        driver.close()
        driver = TestDatabaseDriverFactory().createDriver()
        database = VoiceOSDatabase(driver)
    }

    /**
     * Helper to get current timestamp.
     */
    protected fun now(): Long = System.currentTimeMillis()

    /**
     * Helper to get a timestamp N milliseconds in the past.
     */
    protected fun past(millisAgo: Long): Long = now() - millisAgo

    /**
     * Helper to get a timestamp N milliseconds in the future.
     */
    protected fun future(millisAhead: Long): Long = now() + millisAhead
}
