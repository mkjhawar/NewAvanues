/**
 * DatabaseConsolidationTest.kt - Tests for Phase 3A database consolidation
 *
 * Copyright (C) Manoj Jhawar/Aman Jhawar, Intelligent Devices LLC
 * Author: Manoj Jhawar
 * Code-Reviewed-By: CCA
 * Created: 2025-10-31
 *
 * Tests unified AppEntity and database migration from version 1 to 2.
 */
package com.augmentalis.voiceoscore.database

import androidx.room.Room
import androidx.room.testing.MigrationTestHelper
import androidx.sqlite.db.framework.FrameworkSQLiteOpenHelperFactory
import androidx.test.ext.junit.runners.AndroidJUnit4
import androidx.test.platform.app.InstrumentationRegistry
import com.augmentalis.voiceoscore.database.entities.AppEntity
import com.google.common.truth.Truth.assertThat
import kotlinx.coroutines.runBlocking
import org.junit.After
import org.junit.Before
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith
import java.io.IOException

/**
 * Database Consolidation Test
 *
 * Verifies:
 * 1. Migration from version 1 to 2 works correctly
 * 2. Unified AppEntity supports both DYNAMIC and LEARN_APP modes
 * 3. Cross-mode queries return correct results
 * 4. Data integrity maintained during migration
 */
@RunWith(AndroidJUnit4::class)
class DatabaseConsolidationTest {

    private lateinit var database: VoiceOSAppDatabase

    @get:Rule
    val migrationTestHelper = MigrationTestHelper(
        InstrumentationRegistry.getInstrumentation(),
        VoiceOSAppDatabase::class.java,
        emptyList(),
        FrameworkSQLiteOpenHelperFactory()
    )

    @Before
    fun setup() {
        val context = InstrumentationRegistry.getInstrumentation().targetContext
        database = Room.inMemoryDatabaseBuilder(
            context,
            VoiceOSAppDatabase::class.java
        )
        .addMigrations(VoiceOSAppDatabase.MIGRATION_1_2)
        .build()
    }

    @After
    @Throws(IOException::class)
    fun closeDatabase() {
        database.close()
    }

    // ========== Migration Tests ==========

    @Test
    fun testMigrationFrom1To2_WithScrapedApps() = runBlocking {
        // Create version 1 database with scraped_apps data
        val db = migrationTestHelper.createDatabase("test_db", 1).apply {
            execSQL("""
                CREATE TABLE IF NOT EXISTS scraped_apps (
                    app_id TEXT NOT NULL PRIMARY KEY,
                    package_name TEXT NOT NULL,
                    app_name TEXT NOT NULL,
                    version_code INTEGER NOT NULL,
                    version_name TEXT NOT NULL,
                    app_hash TEXT NOT NULL,
                    first_scraped INTEGER NOT NULL,
                    last_scraped INTEGER NOT NULL,
                    scrape_count INTEGER NOT NULL DEFAULT 1,
                    element_count INTEGER NOT NULL DEFAULT 0,
                    command_count INTEGER NOT NULL DEFAULT 0,
                    is_fully_learned INTEGER NOT NULL DEFAULT 0,
                    learn_completed_at INTEGER,
                    scraping_mode TEXT NOT NULL DEFAULT 'DYNAMIC'
                )
            """.trimIndent())

            execSQL("""
                INSERT INTO scraped_apps VALUES (
                    'test-app-id',
                    'com.test.app',
                    'Test App',
                    123,
                    '1.2.3',
                    'testhash123',
                    1234567890000,
                    1234567890000,
                    1,
                    10,
                    5,
                    0,
                    NULL,
                    'DYNAMIC'
                )
            """.trimIndent())

            close()
        }

        // Run migration
        migrationTestHelper.runMigrationsAndValidate("test_db", 2, true, VoiceOSAppDatabase.MIGRATION_1_2)

        // Verify data migrated correctly
        val migratedDb = Room.databaseBuilder(
            InstrumentationRegistry.getInstrumentation().targetContext,
            VoiceOSAppDatabase::class.java,
            "test_db"
        )
        .addMigrations(VoiceOSAppDatabase.MIGRATION_1_2)
        .build()

        val app = migratedDb.appDao().getApp("com.test.app")
        assertThat(app).isNotNull()
        assertThat(app?.packageName).isEqualTo("com.test.app")
        assertThat(app?.appName).isEqualTo("Test App")
        assertThat(app?.versionCode).isEqualTo(123)
        assertThat(app?.scrapedElementCount).isEqualTo(10)
        assertThat(app?.commandCount).isEqualTo(5)

        migratedDb.close()
    }

    // ========== Unified AppEntity Tests ==========

    @Test
    fun testUnifiedAppEntity_DynamicMode() = runBlocking {
        val timestamp = System.currentTimeMillis()
        val app = AppEntity(
            packageName = "com.test.dynamic",
            appId = "dynamic-app-id",
            appName = "Dynamic Test App",
            versionCode = 100,
            versionName = "1.0.0",
            appHash = "hash100",
            scrapedElementCount = 15,
            commandCount = 8,
            scrapeCount = 3,
            firstScraped = timestamp,
            lastScraped = timestamp,
            scrapingMode = AppEntity.MODE_DYNAMIC
        )

        database.appDao().insert(app)
        val retrieved = database.appDao().getApp("com.test.dynamic")

        assertThat(retrieved).isNotNull()
        assertThat(retrieved?.packageName).isEqualTo("com.test.dynamic")
        assertThat(retrieved?.scrapingMode).isEqualTo(AppEntity.MODE_DYNAMIC)
        assertThat(retrieved?.scrapedElementCount).isEqualTo(15)
        assertThat(retrieved?.explorationStatus).isNull()  // Not explored yet
    }

    @Test
    fun testUnifiedAppEntity_LearnAppMode() = runBlocking {
        val timestamp = System.currentTimeMillis()
        val app = AppEntity(
            packageName = "com.test.learnapp",
            appId = "learnapp-id",
            appName = "LearnApp Test",
            versionCode = 200,
            versionName = "2.0.0",
            appHash = "hash200",
            explorationStatus = AppEntity.STATUS_COMPLETE,
            totalScreens = 5,
            exploredElementCount = 50,
            totalEdges = 12,
            firstExplored = timestamp,
            lastExplored = timestamp,
            isFullyLearned = true,
            learnCompletedAt = timestamp
        )

        database.appDao().insert(app)
        val retrieved = database.appDao().getApp("com.test.learnapp")

        assertThat(retrieved).isNotNull()
        assertThat(retrieved?.explorationStatus).isEqualTo(AppEntity.STATUS_COMPLETE)
        assertThat(retrieved?.totalScreens).isEqualTo(5)
        assertThat(retrieved?.exploredElementCount).isEqualTo(50)
        assertThat(retrieved?.isFullyLearned).isTrue()
    }

    @Test
    fun testUnifiedAppEntity_BothModes() = runBlocking {
        val timestamp = System.currentTimeMillis()
        val app = AppEntity(
            packageName = "com.test.both",
            appId = "both-modes-id",
            appName = "Both Modes Test",
            versionCode = 300,
            versionName = "3.0.0",
            appHash = "hash300",
            // DYNAMIC mode fields
            scrapedElementCount = 20,
            commandCount = 10,
            scrapeCount = 5,
            firstScraped = timestamp,
            lastScraped = timestamp,
            scrapingMode = AppEntity.MODE_DYNAMIC,
            // LEARN_APP mode fields
            explorationStatus = AppEntity.STATUS_COMPLETE,
            totalScreens = 8,
            exploredElementCount = 60,
            totalEdges = 15,
            firstExplored = timestamp,
            lastExplored = timestamp,
            isFullyLearned = true,
            learnCompletedAt = timestamp
        )

        database.appDao().insert(app)
        val retrieved = database.appDao().getApp("com.test.both")

        assertThat(retrieved).isNotNull()
        // Verify DYNAMIC mode fields
        assertThat(retrieved?.scrapedElementCount).isEqualTo(20)
        assertThat(retrieved?.commandCount).isEqualTo(10)
        // Verify LEARN_APP mode fields
        assertThat(retrieved?.explorationStatus).isEqualTo(AppEntity.STATUS_COMPLETE)
        assertThat(retrieved?.exploredElementCount).isEqualTo(60)
        assertThat(retrieved?.isFullyLearned).isTrue()
    }

    // ========== Cross-Mode Query Tests ==========

    @Test
    fun testCrossModeQueries_GetAppsInBothModes() = runBlocking {
        val timestamp = System.currentTimeMillis()

        // Insert app with both modes
        database.appDao().insert(AppEntity(
            packageName = "com.test.both1",
            appId = "both1-id",
            appName = "Both Modes 1",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            scrapedElementCount = 10,
            explorationStatus = AppEntity.STATUS_COMPLETE
        ))

        // Insert app with only DYNAMIC mode
        database.appDao().insert(AppEntity(
            packageName = "com.test.dynamic1",
            appId = "dynamic1-id",
            appName = "Dynamic Only 1",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash2",
            scrapedElementCount = 5
        ))

        // Insert app with only LEARN_APP mode
        database.appDao().insert(AppEntity(
            packageName = "com.test.learn1",
            appId = "learn1-id",
            appName = "Learn Only 1",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash3",
            explorationStatus = AppEntity.STATUS_COMPLETE
        ))

        val appsInBothModes = database.appDao().getAppsInBothModes()
        assertThat(appsInBothModes).hasSize(1)
        assertThat(appsInBothModes[0].packageName).isEqualTo("com.test.both1")
    }

    @Test
    fun testCrossModeQueries_GetFullyLearnedApps() = runBlocking {
        // Insert fully learned app
        database.appDao().insert(AppEntity(
            packageName = "com.test.fully.learned",
            appId = "fully-id",
            appName = "Fully Learned",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            isFullyLearned = true,
            learnCompletedAt = System.currentTimeMillis()
        ))

        // Insert partially learned app
        database.appDao().insert(AppEntity(
            packageName = "com.test.partial",
            appId = "partial-id",
            appName = "Partial",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash2",
            isFullyLearned = false
        ))

        val fullyLearned = database.appDao().getFullyLearnedApps()
        assertThat(fullyLearned).hasSize(1)
        assertThat(fullyLearned[0].packageName).isEqualTo("com.test.fully.learned")
    }

    // ========== DAO Operation Tests ==========

    @Test
    fun testAppDao_UpsertWithScrapingData() = runBlocking {
        // First insert
        database.appDao().upsertWithScrapingData(
            packageName = "com.test.upsert",
            appId = "upsert-id",
            appName = "Upsert Test",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            scrapedElementCount = 10,
            commandCount = 5
        )

        val first = database.appDao().getApp("com.test.upsert")
        assertThat(first).isNotNull()
        assertThat(first?.scrapeCount).isEqualTo(1)
        assertThat(first?.scrapedElementCount).isEqualTo(10)

        // Update (upsert again)
        database.appDao().upsertWithScrapingData(
            packageName = "com.test.upsert",
            appId = "upsert-id",
            appName = "Upsert Test",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            scrapedElementCount = 15,
            commandCount = 8
        )

        val updated = database.appDao().getApp("com.test.upsert")
        assertThat(updated).isNotNull()
        assertThat(updated?.scrapeCount).isEqualTo(2)  // Incremented
        assertThat(updated?.scrapedElementCount).isEqualTo(15)  // Updated
    }

    @Test
    fun testAppDao_UpdateExplorationStatus() = runBlocking {
        database.appDao().insert(AppEntity(
            packageName = "com.test.exploration",
            appId = "exploration-id",
            appName = "Exploration Test",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            explorationStatus = AppEntity.STATUS_IN_PROGRESS
        ))

        database.appDao().updateExplorationStatus(
            packageName = "com.test.exploration",
            status = AppEntity.STATUS_COMPLETE
        )

        val updated = database.appDao().getApp("com.test.exploration")
        assertThat(updated?.explorationStatus).isEqualTo(AppEntity.STATUS_COMPLETE)
        assertThat(updated?.lastExplored).isNotNull()
    }

    @Test
    fun testAppDao_MarkAsFullyLearned() = runBlocking {
        database.appDao().insert(AppEntity(
            packageName = "com.test.mark",
            appId = "mark-id",
            appName = "Mark Test",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            isFullyLearned = false
        ))

        database.appDao().markAsFullyLearned("com.test.mark")

        val updated = database.appDao().getApp("com.test.mark")
        assertThat(updated?.isFullyLearned).isTrue()
        assertThat(updated?.explorationStatus).isEqualTo(AppEntity.STATUS_COMPLETE)
        assertThat(updated?.learnCompletedAt).isNotNull()
    }

    // ========== Count and Statistics Tests ==========

    @Test
    fun testAppDao_Counts() = runBlocking {
        // Insert various apps
        database.appDao().insert(AppEntity(
            packageName = "com.test.complete1",
            appId = "id1",
            appName = "Complete 1",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash1",
            explorationStatus = AppEntity.STATUS_COMPLETE,
            isFullyLearned = true
        ))

        database.appDao().insert(AppEntity(
            packageName = "com.test.complete2",
            appId = "id2",
            appName = "Complete 2",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash2",
            explorationStatus = AppEntity.STATUS_COMPLETE,
            isFullyLearned = false
        ))

        database.appDao().insert(AppEntity(
            packageName = "com.test.progress",
            appId = "id3",
            appName = "In Progress",
            versionCode = 1,
            versionName = "1.0",
            appHash = "hash3",
            explorationStatus = AppEntity.STATUS_IN_PROGRESS
        ))

        assertThat(database.appDao().getAppCount()).isEqualTo(3)
        assertThat(database.appDao().getCompletedAppCount()).isEqualTo(2)
        assertThat(database.appDao().getFullyLearnedAppCount()).isEqualTo(1)
    }
}
