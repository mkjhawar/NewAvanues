package com.augmentalis.magiccode.plugins.themes

import com.augmentalis.magiccode.plugins.utils.TestUtils
import com.augmentalis.magiccode.plugins.utils.TestConstants
import kotlin.test.*

/**
 * Unit tests for ThemeValidator.
 *
 * Tests:
 * - Valid themes
 * - Invalid color formats
 * - Invalid spacing values
 * - Missing required fields
 */
class ThemeValidatorTest {
    private lateinit var validator: ThemeValidator

    @BeforeTest
    fun setup() {
        validator = ThemeValidator()
    }

    // Test 1: Valid Themes
    @Test
    fun testValidThemes() {
        val validTheme = TestUtils.createTestTheme()

        val result = validator.validate(validTheme)

        assertTrue(result is ThemeValidator.ValidationResult.Valid)
    }

    // Test 2: Invalid Color Formats
    @Test
    fun testInvalidColorFormats() {
        // Test invalid hex color
        val invalidHexTheme = ThemeDefinition(
            name = "Invalid Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = "not-a-color", // Invalid
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )

        val result = validator.validate(invalidHexTheme)

        assertTrue(result is ThemeValidator.ValidationResult.Invalid)
        val errors = (result as ThemeValidator.ValidationResult.Invalid).errors
        assertTrue(errors.any { it.field.contains("colors.primary") })
    }

    // Test 3: Valid Color Formats
    @Test
    fun testValidColorFormats() {
        // Test hex colors
        val hexTheme = TestUtils.createTestTheme(
            primaryColor = "#007AFF", // 6-digit hex
            secondaryColor = "#FFF", // 3-digit hex
            backgroundColor = "#1C1C1EFF", // 8-digit hex with alpha
            textColor = "#FFFFFF"
        )
        assertTrue(validator.validate(hexTheme) is ThemeValidator.ValidationResult.Valid)

        // Test RGB colors
        val rgbTheme = ThemeDefinition(
            name = "RGB Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = "rgb(0, 122, 255)",
                secondary = "rgb(88, 86, 214)",
                background = "rgb(28, 28, 30)",
                text = "rgb(255, 255, 255)"
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )
        assertTrue(validator.validate(rgbTheme) is ThemeValidator.ValidationResult.Valid)

        // Test RGBA colors
        val rgbaTheme = ThemeDefinition(
            name = "RGBA Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = "rgba(0, 122, 255, 1.0)",
                secondary = "rgba(88, 86, 214, 0.8)",
                background = "rgba(28, 28, 30, 0.95)",
                text = "rgba(255, 255, 255, 1)"
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )
        assertTrue(validator.validate(rgbaTheme) is ThemeValidator.ValidationResult.Valid)
    }

    // Test 4: Invalid Spacing Values
    @Test
    fun testInvalidSpacingValues() {
        val invalidSpacingTheme = ThemeDefinition(
            name = "Invalid Spacing Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = -5, // Invalid: negative
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = 200 // Invalid: too large
            )
        )

        val result = validator.validate(invalidSpacingTheme)

        assertTrue(result is ThemeValidator.ValidationResult.Invalid)
        val errors = (result as ThemeValidator.ValidationResult.Invalid).errors
        assertTrue(errors.any { it.field.contains("spacing.xs") })
        assertTrue(errors.any { it.field.contains("spacing.xl") })
    }

    // Test 5: Missing Required Fields
    @Test
    fun testMissingRequiredFields() {
        // Empty name
        val emptyNameTheme = TestUtils.createTestTheme(name = "")
        val result1 = validator.validate(emptyNameTheme)
        assertTrue(result1 is ThemeValidator.ValidationResult.Invalid)
        val errors1 = (result1 as ThemeValidator.ValidationResult.Invalid).errors
        assertTrue(errors1.any { it.field == "name" })

        // Invalid version
        val invalidVersionTheme = TestUtils.createTestTheme(version = "not-semver")
        val result2 = validator.validate(invalidVersionTheme)
        assertTrue(result2 is ThemeValidator.ValidationResult.Invalid)
        val errors2 = (result2 as ThemeValidator.ValidationResult.Invalid).errors
        assertTrue(errors2.any { it.field == "version" })
    }

    // Test 6: Font Size Validation
    @Test
    fun testFontSizeValidation() {
        // Font size too small
        val tooSmallTheme = ThemeDefinition(
            name = "Too Small Font Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = 2, // Invalid: too small
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )

        val result1 = validator.validate(tooSmallTheme)
        assertTrue(result1 is ThemeValidator.ValidationResult.Invalid)

        // Font size too large
        val tooLargeTheme = ThemeDefinition(
            name = "Too Large Font Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = 200 // Invalid: too large
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )

        val result2 = validator.validate(tooLargeTheme)
        assertTrue(result2 is ThemeValidator.ValidationResult.Invalid)

        // Invalid progression (small >= medium)
        val badProgressionTheme = ThemeDefinition(
            name = "Bad Progression Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = 20, // Should be < medium
                    medium = 16,
                    large = 24
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )

        val result3 = validator.validate(badProgressionTheme)
        assertTrue(result3 is ThemeValidator.ValidationResult.Invalid)
        val errors = (result3 as ThemeValidator.ValidationResult.Invalid).errors
        assertTrue(errors.any { it.severity == ThemeValidator.Severity.WARNING })
    }

    // Test 7: Font Weight Validation
    @Test
    fun testFontWeightValidation() {
        // Invalid font weight (out of range)
        val invalidWeightTheme = ThemeDefinition(
            name = "Invalid Weight Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                ),
                fontWeight = FontWeights(
                    regular = 50, // Invalid: too light
                    bold = 1000 // Invalid: too heavy
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            )
        )

        val result = validator.validate(invalidWeightTheme)
        assertTrue(result is ThemeValidator.ValidationResult.Invalid)
    }

    // Test 8: Effects Validation
    @Test
    fun testEffectsValidation() {
        // Valid effects
        val validEffectsTheme = ThemeDefinition(
            name = "Valid Effects Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            ),
            effects = Effects(
                borderRadius = BorderRadius(none = 0, small = 4, medium = 8, large = 16),
                opacity = Opacity(transparent = 0.0, semiTransparent = 0.5, opaque = 1.0)
            )
        )

        assertTrue(validator.validate(validEffectsTheme) is ThemeValidator.ValidationResult.Valid)

        // Invalid opacity (out of range)
        val invalidOpacityTheme = ThemeDefinition(
            name = "Invalid Opacity Theme",
            version = "1.0.0",
            colors = ColorPalette(
                primary = TestConstants.TEST_COLOR_PRIMARY,
                secondary = TestConstants.TEST_COLOR_SECONDARY,
                background = TestConstants.TEST_COLOR_BACKGROUND,
                text = TestConstants.TEST_COLOR_TEXT
            ),
            typography = Typography(
                fontFamily = "SF Pro",
                fontSize = FontSizes(
                    small = TestConstants.TEST_FONT_SIZE_SMALL,
                    medium = TestConstants.TEST_FONT_SIZE_MEDIUM,
                    large = TestConstants.TEST_FONT_SIZE_LARGE
                )
            ),
            spacing = Spacing(
                xs = TestConstants.TEST_SPACING_XS,
                sm = TestConstants.TEST_SPACING_SM,
                md = TestConstants.TEST_SPACING_MD,
                lg = TestConstants.TEST_SPACING_LG,
                xl = TestConstants.TEST_SPACING_XL
            ),
            effects = Effects(
                opacity = Opacity(transparent = -0.5, semiTransparent = 0.5, opaque = 1.5) // Invalid
            )
        )

        val result = validator.validate(invalidOpacityTheme)
        assertTrue(result is ThemeValidator.ValidationResult.Invalid)
    }
}
