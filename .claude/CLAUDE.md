# IDEACODE v12.1 - Global Instructions

Scope: ALL projects in /Volumes/M-Drive/Coding/

---

## SESSION START (MANDATORY SEQUENCE)

**CRITICAL FIRST STEP:** Detect current repository
```bash
pwd  # Determine which repo this terminal is in
```

**Then show:**
```
Working in: {detected-repo}
```

**Then read instructions:**
1. Read `{project}/.claude/CLAUDE.md`
2. Read `{project}/.ideacode/registries/script-registry.md` (if exists)
3. Read `{module}/.claude/CLAUDE.md` for module work

**RULE:** Work ONLY in detected repo unless user explicitly asks to switch repos

---

## ZERO TOLERANCE RULES

| Rule | Enforcement |
|------|-------------|
| TERMINAL ISOLATION | **CRITICAL:** Detect current repo at session start. ONLY work in THAT repo. NEVER switch repos/worktrees without explicit user permission. Ask "Switch to {repo}? (Y/n)" before any cross-repo work |
| REPO DETECTION | **FIRST ACTION:** Run `pwd` to detect current repo. Show: "Working in: {repo}". If user asks about different repo: ASK before switching |
| NO BRANCH CHANGES | **NEVER** create, switch, or delete branches without explicit user approval. Ask: "Create/switch to branch {name}? (Y/n)" |
| OWN WORK ONLY | **ONLY** stage, commit, or push work done in YOUR terminal session. NEVER commit/push changes made by others or in other terminals |
| NO CROSS-COMMIT | **NEVER** commit or push to branches other than current working branch without approval + clear reason. Verify branch before every commit |
| CROSS-PROJECT CAUTION | When modifying files outside your detected project, ALWAYS check for potential conflicts/issues with other files that may depend on them |
| MANDATORY NAMING | ALL files MUST follow naming: {App}-{Module}-{Desc}-{YDDMMHH}-V#.md (Y=single digit year, NOT YY). NO files without App prefix |
| NO HARDWIRING | Never hardcode. Use config/env. .yolo: ABSOLUTE BAN. Non-yolo: explicit approval + justification |
| NO DELETE | Never delete code without approval + pros/cons |
| NO MAIN COMMITS | NEVER commit to main (feature/, bugfix/, hotfix/) |
| NO AI MARKS | No "Generated by Claude", no emojis in commits |
| NO DUPLICATION | Library imports ONLY, NEVER copy-paste code |
| WAIT FOR USER | STOP after questions, NEVER proceed until answered |
| REGISTRY CHECK | ALWAYS check PROJECT-REGISTRY.json before multi-repo ops |
| NO STUBS | **ABSOLUTE BAN** on stub/placeholder code. ONLY full working implementations. No `// TODO`, no `throw NotImplementedException()`, no empty function bodies, no "implement later". Every function MUST be complete. Applies to ALL modes including `.yolo` and `.swarm` |

---

## IDEACODE API (PREFERRED - 97% TOKEN SAVINGS)

API URL: `http://localhost:3847`
Check: `curl -s http://localhost:3847/health`
**AUTO-LOADS:** YES (global, all terminals)

| Command | Use API |
|---------|---------|
| /i.think, /i.analyze, /i.research | Yes (read-only, cacheable) |
| /i.spec, /i.plan, /i.review | Yes (planning phases) |
| /i.develop, /i.fix, /i.implement | Yes (all operations) |

Call format:
```bash
curl -X POST http://localhost:3847/i.<command> \
  -H "Content-Type: application/json" \
  -d '{"params":{"description":"..."},"modifiers":{"yolo":true,"cot":true}}'
```

Manual start (if needed): `cd /Volumes/M-Drive/Coding/ideacode/ideacode-api && npm start`

**SMALL FILE EXCEPTION (<1.5KB):**

| File Size | Action | Reason |
|-----------|--------|--------|
| <1.5KB | Use direct Read tool | API adds 33% overhead |
| 1.5KB-10KB | Either works | Break-even zone |
| >10KB | Use API | 98%+ token savings |

Decision tree:
1. Single known file <1.5KB → Read tool directly
2. Multiple files OR unknown content → Use API
3. Analysis/research/workflow → Always use API

---

## MCP SERVER (PER-REPO, MANUAL ONLY)

**AUTO-LOADS:** NO (must start manually)
**SCOPE:** Per-terminal/per-repo (isolated)
Check: `/i.mcp status`
Start: `/i.mcp start`
Stop: `/i.mcp stop`

**Why manual:**
- Repo-specific configuration
- Terminal isolation (multiple MCP instances can run independently)
- Stateful (unlike API which is stateless)

Config: `{repo}/.claude/mcp.json`

---

## DOCUMENT LOADING (TOKEN OPTIMIZATION)

Rule: Summaries FIRST, full docs ONLY when insufficient

Start: `docs/QUICK-REFERENCE.md` or `docs/ideacode/protocols/INDEX.md`
Structure: `00-*.md` (summary ~200 tok), `01-*.md` (section ~400 tok), `99-*.md` (full)
Session: QUICK-REFERENCE + LD-CORE (~800 tok total)
Workflows: Use `00-Checklist.md` NOT full protocols
Penalty: Violating wastes 15k-30k tokens/workflow

---

## AUTO TOKEN OPTIMIZATION

**Runs automatically on API build** (`npm run build`)

| Script | Purpose |
|--------|---------|
| `scripts/token-optimizer.sh` | Detect bloated files (>20KB, >500 lines) |
| `scripts/extract-templates.sh` | Create template extraction structure |
| `scripts/quantize-instructions.sh` | Compress instructions with abbreviations |

**Thresholds:**

| Metric | Limit | Action |
|--------|-------|--------|
| File size | >20KB | CRITICAL: Extract templates |
| Line count | >500 | WARNING: Split or refactor |
| Template strings | >5 | CRITICAL: Move to `src/templates/` |
| Command files | >10KB | WARNING: Compact to tables/lists |

**Commands:**
```bash
npm run token-check    # Check all files (CI mode)
npm run token-analyze  # Verbose analysis
npm run token-fix      # Generate extraction guides
```

**Template Extraction Pattern:**
```
src/tools/handlers/document.ts    # 68KB → 14KB (79% reduction)
src/templates/documentation/       # 34 template files
```

---

## FILE OPERATIONS

1. Check registry: `/Volumes/M-Drive/Coding/ideacode/.ideacode/registries/FOLDER-REGISTRY.md`
2. **NO REDUNDANT FOLDER NAMES:** Parent name implies content → children MUST NOT repeat
   - ❌ `Common/Libraries/` → ✅ `Common/`
   - ❌ `Modules/libraries/` → ✅ `Modules/`
   - ❌ `Docs/Documentation/` → ✅ `Docs/`
3. **CASE SENSITIVITY:**
   - **Quoted** (`"readme"`): Use EXACT case only (strict match)
   - **Unquoted** (`readme`): Case-insensitive search (find README.md, readme.md, Readme.md, etc.)
   - Check project conventions from existing files when inferring
   - Example: `readme` → finds README.md | `"readme"` → only finds exactly `readme`
4. Use API: File operations through `/i.*` endpoints
5. Run: `curl -X POST http://localhost:3847/i.standards -d '{"params":{"context":"task"}}'`

Paths:
- Context: `{project}/contextsave/con-{app}-{module}-{desc}-{YYYYMMDD}.md`
- Living Docs: `{project}/.ideacode/living-docs/LD-App-Module-Desc-V#.md`
- Commands: `/Volumes/M-Drive/Coding/.claude/commands/` (GLOBAL ONLY)

---

## HARD RULES

| Rule | Enforcement |
|------|-------------|
| File reading | Read in chunks until found (debugging). No limit on chunk count |
| Question format | Display ALL questions FIRST, then ask one-at-a-time (single submit) |
| Always "Other" | EVERY question must include "Other" option for user input |
| Options analysis | For each option: pros, cons, AI recommendation, optimal alternative, hybrid solutions |
| Optimal only | Best approach always (hybrid OK), no "good enough" |
| Token efficiency | Batch ops, targeted reads, minimal output |
| Compact format | Tables/lists only, NO prose |
| CLAUDE.md | <150 lines, structured, no emojis |
| API tools | Use API for files >1.5KB, direct Read for smaller |
| Test coverage | 90%+ critical paths |
| SOLID | ALL code |
| No redundant names | Parent implies type → children NEVER repeat (Common/ NOT Common/Libraries/) |
| Smart casing | Quoted: EXACT case only. Unquoted: case-insensitive search |

YOLO Mode:
- No questions within repo/branch scope (autonomous decisions)
- Only ask if: outside repo, external access, or affects main branch
- No shortcuts, re-enable disabled, 100% equivalence
- ABSOLUTE BAN: hardwiring (use config/env/constants)

---

## QUESTION-ASKING PROTOCOL

When asking questions:

1. **Display Phase:** Show ALL questions in message BEFORE asking
2. **Ask Phase:** Use AskUserQuestion tool with questions (user submits once for all)
3. **"Other" Required:** EVERY question MUST have "Other" option
4. **Options Analysis:** For each option provide:
   - Pros (benefits)
   - Cons (drawbacks/tradeoffs)
   - AI recommendation + reason
   - Optimal alternative (if different from options)
   - Hybrid solutions (combinations that may be better)

Example:
```
I need to decide on the authentication approach. Here are the questions:

Question 1: Which auth method?
Question 2: Where to store tokens?

[Then use AskUserQuestion with both questions, each with "Other" option]

For each option I'll provide:
- Option A: JWT
  Pros: Stateless, scalable
  Cons: Token size, rotation complexity
- Option B: Session
  Pros: Simple, revocable
  Cons: Server state, scaling issues
- Optimal: Hybrid (JWT + refresh tokens)
  Why: Combines stateless benefits with revocation
```

---

## AUTO-INVOKED

Always-On: SOLID enforcement, Reasoning (auto `.cot`/`.tot`/`.rot`), Skills (17), Subagents (13), Web search

Skills: develop-feature, fix-bug, create-ui, developing-{android|ios|web|kmp|tauri|kotlin|web}
Subagents: code-reviewer, security-scanner, architect, test-runner, doc-writer, performance-optimizer, spec-verifier, plan-verifier, impl-verifier, debug-agent, exploration-agent, research-agent, cleanup-agent

Ref: `LD-IDEACODE-AI-Instructions-V1.md`

---

## COMMANDS

**All commands use API (97% token savings) - API auto-starts, MCP manual**

Analysis: /i.think /i.analyze /i.research /i.review
Planning: /i.spec /i.plan /i.scan /i.document
Implementation: /i.develop /i.fix /i.implement /i.refactor
Repository: /i.repo /i.commit
UI: /i.createui
Configuration: /i.model /i.mcp
Advanced: /i.swarm /i.agent

Modifiers: .yolo .swarm .tdd .ood .solid .tcr .cot .tot .profile

/i.spec modifiers: .review .respec .clarify .fix .continue .variant
/i.repo modifiers: .new .cleanup .migrate .validate .fix .add .list
/i.mcp modifiers: status start stop restart config

Full: /ideacode or /imodifiers or `docs/ideacode-v10-manual.md`

---

## FILE NAMING

**MANDATORY: ALL files MUST have App/Module prefix**

Docs: `App-Module-Desc-YDDMMHH-V#.md` (Y = SINGLE digit year: 5 for 2025, NOT 25)
Living: `LD-App-Module-Desc-V#.md`
Specs: `App-Spec-Feature-YDDMM-V#.md` (Y = SINGLE digit)
Plans: `App-Plan-Feature-YDDMM-V#.md` (Y = SINGLE digit)
Context: `con-{app}-{module}-{desc}-{YYYYMMDD}.md` (context uses full 4-digit year)

Examples:
- ✅ `AvaConnect-Status-Progress-51209-V1.md` (Dec 9, 2025)
- ❌ `Status-Progress-251209-V1.md` (missing App prefix)
- ❌ `AvaConnect-Status-Progress-251209-V1.md` (2-digit year 25 instead of 5)

Code:
- TypeScript: `{app}-{module}-{desc}.ts`
- Kotlin/Swift: `{App}{Module}{Desc}.{kt|swift}`

Folders:
- Gradle: `android/ios/desktop/` (lowercase)
- Other: `Docs/Common/Shared/` (PascalCase)
- Config: `.claude/.ideacode/` (kebab)

Enforce: App prefix + version `-V#` required, Y=single digit (NOT YY), use `ideacode_fs` for validation

Full: FOLDER-REGISTRY.md, FILE-REGISTRY.md

---

## API ENDPOINTS

Workflow: /i.{develop|fix|specify|plan|implement|review}
Analysis: /i.{think|analyze|research}
UI: /i.createui
Project: /i.{project|scan|document}
Advanced: /i.{swarm|agent|refactor}

Total: 15+ endpoints | Auto-start on first use

Ref: `ideacode-api/README.md`

---

## UI FRAMEWORK

Stack:
- Android: Compose + Material3
- iOS: SwiftUI
- Web: React + Tailwind
- Override: MagicUI (all platforms)

Input (ALL platforms REQUIRED): Voice, Touch, Gaze, Keyboard, Mouse
Optional: Eye tracking (iOS/Android), Gestures (glasses)
Glasses: Standalone/Tethered (Rokid, Xreal, Viture, RayNeo)

Command: /icreateui .app "name"
Pipeline: Requirements → Research → Design → ASCII → Code → Demo → Verify

Full: `LD-IDEACODE-UI-Guidelines-V3.md`
Manual: `docs/manuals/developer/ui/IDEACODE-UI-Implementation-Guide-V3-*.md`

---

## QUALITY GATES

| Metric | Target |
|--------|--------|
| Test coverage | 90%+ |
| Blockers | 0 |
| Warnings | 0 |
| Gaze accuracy | 95%+ <50px |

---

## VERSION MANAGEMENT

Central Source: `/Volumes/M-Drive/Coding/ideacode/version-info.json`
Backup: `/Volumes/M-Drive/Coding/ideacode/VERSION`

All repos read version from central file (NOT individual configs)
Update: Edit version-info.json OR run `bash scripts/sync-versions.sh`
Deploy: Run `bash scripts/deploy-statusline.sh` to update all repos
Registry: Always check PROJECT-REGISTRY.json for active repos

Files:
- `ideacode/version-info.json` - Single source of truth
- `ideacode/VERSION` - Simple version file
- `PROJECT-REGISTRY.json` - Active repo list

---

## MEMORY SYSTEM

Task-aware context management with per-repo isolation.

| Indicator | Meaning | Action |
|-----------|---------|--------|
| `MEM:ok` | Clear, no pending | Safe to /clear |
| `MEM:save` | 80%+, no task | /compact now |
| `MEM:task[%]` | Task active | Finish task first |

Commands: `.claude/hooks/memory-manager.sh {check|save|task-start|task-end|decision}`
Files: `{repo}/.claude/memory.md` (per-repo state)
Full: `docs/ideacode-v10-manual.md` or `LD-IDEACODE-Context-Management-V2.md`

---

## IDC & PROFILES

IDC: Compact config (60-80% smaller than YAML)
Codes: PRJ: PRF: CFG: THR: SIG: VRF: GAT: AGT: CMD:
Separators: `:` fields, `+` multi-value, `,` lists
Files: `.ideacode/config.idc`
Spec: `docs/specifications/IDC-FORMAT-SPEC-V1.md`

Profiles:
- default: TDD 50, OOD 40, auto-verify
- strict: TDD 30, OOD 30, auto-verify, visual
- prototype: TDD 90, OOD 80, no verify
- production: TDD 40, OOD 40, auto-verify, visual

Usage: /idevelop .profile strict "feature"
Verifiers: spec-verifier, plan-verifier, impl-verifier (auto-run after phases)

---

Author: Manoj Jhawar | License: Proprietary | Version: 12.1.0 | Updated: 2025-12-16
Version Source: `/Volumes/M-Drive/Coding/ideacode/version-info.json` (centralized)
