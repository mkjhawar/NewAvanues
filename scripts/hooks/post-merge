#!/bin/bash
# post-merge hook - Git LFS + Worktree cleanup suggestions

# Git LFS handling
command -v git-lfs >/dev/null 2>&1 || { printf >&2 "\n%s\n\n" "This repository is configured for Git LFS but 'git-lfs' was not found on your path. If you no longer wish to use Git LFS, remove this hook by deleting the 'post-merge' file in the hooks directory (set by 'core.hookspath'; usually '.git/hooks')."; exit 2; }
git lfs post-merge "$@"

# Worktree cleanup check
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Only run in main worktree
if [ -f "$REPO_ROOT/.git" ]; then
    exit 0
fi

CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
STALE_COUNT=0
STALE_BRANCHES=""

while IFS= read -r line; do
    case "$line" in
        worktree*)
            WORKTREE_PATH="${line#worktree }"
            ;;
        branch*)
            BRANCH="${line#branch refs/heads/}"
            if [ "$WORKTREE_PATH" = "$REPO_ROOT" ]; then continue; fi
            if git branch --merged "$CURRENT_BRANCH" 2>/dev/null | grep -q "^\s*$BRANCH$"; then
                STALE_COUNT=$((STALE_COUNT + 1))
                STALE_BRANCHES="$STALE_BRANCHES  - $BRANCH\n"
            fi
            ;;
    esac
done < <(git worktree list --porcelain)

if [ "$STALE_COUNT" -gt 0 ]; then
    echo ""
    echo "=== WORKTREE CLEANUP AVAILABLE ==="
    echo "Merged branches with worktrees:"
    echo -e "$STALE_BRANCHES"
    echo "Run: ./scripts/worktree-cleanup.sh"
    echo ""
fi
