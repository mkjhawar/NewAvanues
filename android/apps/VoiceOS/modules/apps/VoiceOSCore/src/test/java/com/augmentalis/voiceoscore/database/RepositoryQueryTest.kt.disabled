/**
 * RepositoryQueryTest.kt - Tests for repository query operations
 *
 * Converted from SafeCursorManagerTest (Room cursors) to SQLDelight repository tests
 *
 * Tests verify:
 * 1. Repository queries return correct results
 * 2. Parameterized queries work correctly
 * 3. Query operations are exception-safe
 * 4. Multiple query operations work independently
 * 5. Complex queries with joins work correctly
 *
 * Zero Tolerance: 0 errors, 0 warnings, 100% pass rate
 *
 * Copyright (C) Manoj Jhawar/Aman Jhawar, Intelligent Devices LLC
 */
package com.augmentalis.voiceoscore.database

import com.augmentalis.database.dto.ScrapedAppDTO
import com.augmentalis.database.dto.ScrapedElementDTO
import com.augmentalis.database.dto.GeneratedCommandDTO
import com.augmentalis.voiceoscore.test.infrastructure.BaseRepositoryTest
import com.augmentalis.voiceoscore.test.infrastructure.CoroutineTestRule
import com.google.common.truth.Truth.assertThat
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.runTest
import org.junit.Rule
import org.junit.Test
import kotlin.test.assertFailsWith

/**
 * Test suite for repository query operations.
 *
 * Verifies that:
 * - Queries return correct results
 * - Parameterized queries work
 * - Exception handling works correctly
 * - Multiple queries work independently
 */
@OptIn(ExperimentalCoroutinesApi::class)
class RepositoryQueryTest : BaseRepositoryTest() {

    // coroutineRule is inherited from BaseRepositoryTest

    /**
     * TEST 1: Verify repository can be accessed
     */
    @Test
    fun `test repository can be accessed`() {
        assertThat(databaseManager.scrapedApps).isNotNull()
    }

    /**
     * TEST 2: Verify query returns correct results
     */
    @Test
    fun `query returns correct results`() = runTest {
        // Insert test data
        val apps = listOf(
            ScrapedAppDTO(
                packageName = "com.example.app1",
                appName = "Test App 1",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = now(),
                lastScrapedAt = now()
            ),
            ScrapedAppDTO(
                packageName = "com.example.app2",
                appName = "Test App 2",
                versionCode = 2L,
                versionName = "2.0",
                firstScrapedAt = now(),
                lastScrapedAt = now()
            )
        )

        apps.forEach { databaseManager.scrapedApps.insert(it) }

        // Query all
        val allApps = databaseManager.scrapedApps.getAll()
        assertThat(allApps).hasSize(2)
        assertThat(allApps.map { it.packageName }).containsExactly(
            "com.example.app1",
            "com.example.app2"
        )
    }

    /**
     * TEST 3: Verify query with parameters works
     */
    @Test
    fun `query with parameters works`() = runTest {
        // Insert test data
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = "com.example.target",
                appName = "Target App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = now(),
                lastScrapedAt = now()
            )
        )

        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = "com.example.other",
                appName = "Other App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = now(),
                lastScrapedAt = now()
            )
        )

        // Query by package name
        val app = databaseManager.scrapedApps.getByPackageName("com.example.target")
        assertThat(app).isNotNull()
        assertThat(app?.packageName).isEqualTo("com.example.target")
        assertThat(app?.appName).isEqualTo("Target App")
    }

    /**
     * TEST 4: Verify empty result handling
     */
    @Test
    fun `empty result handling works correctly`() = runTest {
        // Query when no data exists
        val allApps = databaseManager.scrapedApps.getAll()
        assertThat(allApps).isEmpty()

        // Query specific item that doesn't exist
        val app = databaseManager.scrapedApps.getByPackageName("com.example.nonexistent")
        assertThat(app).isNull()
    }

    /**
     * TEST 5: Verify multiple independent queries
     */
    @Test
    fun `multiple independent queries work correctly`() = runTest {
        val timestamp = now()

        // Insert app
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = "com.example.app",
                appName = "Test App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = timestamp,
                lastScrapedAt = timestamp
            )
        )

        // Insert elements
        databaseManager.scrapedElements.insert(
            ScrapedElementDTO(
                elementHash = "hash1",
                packageName = "com.example.app",
                screenHash = "screen1",
                resourceId = "button1",
                className = "Button",
                text = "Click me",
                contentDescription = "Button",
                isClickable = true,
                isScrollable = false,
                isEditable = false,
                boundsInScreen = "[0,0][100,50]",
                parentHash = null,
                firstSeenAt = timestamp,
                lastSeenAt = timestamp,
                clickCount = 0L,
                inferredLabel = null
            )
        )

        // Query from different repositories independently
        val apps = databaseManager.scrapedApps.getAll()
        val elements = databaseManager.scrapedElements.getByPackageName("com.example.app")

        assertThat(apps).hasSize(1)
        assertThat(elements).hasSize(1)
        assertThat(apps[0].packageName).isEqualTo("com.example.app")
        assertThat(elements[0].text).isEqualTo("Click me")
    }

    /**
     * TEST 6: Verify query after update
     */
    @Test
    fun `query after update returns updated data`() = runTest {
        val initialTime = now()
        val packageName = "com.example.updatable"

        // Insert initial data
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = packageName,
                appName = "Original Name",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = initialTime,
                lastScrapedAt = initialTime
            )
        )

        // Verify initial data
        val initialApp = databaseManager.scrapedApps.getByPackageName(packageName)
        assertThat(initialApp?.appName).isEqualTo("Original Name")

        // Update
        val updatedTime = now()
        databaseManager.scrapedApps.update(
            ScrapedAppDTO(
                packageName = packageName,
                appName = "Updated Name",
                versionCode = 2L,
                versionName = "2.0",
                firstScrapedAt = initialTime,
                lastScrapedAt = updatedTime
            )
        )

        // Verify updated data
        val updatedApp = databaseManager.scrapedApps.getByPackageName(packageName)
        assertThat(updatedApp?.appName).isEqualTo("Updated Name")
        assertThat(updatedApp?.versionCode).isEqualTo(2L)
    }

    /**
     * TEST 7: Verify query with filtering
     */
    @Test
    fun `query with filtering works correctly`() = runTest {
        val timestamp = now()
        val packageName = "com.example.filtered"

        // Insert app
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = packageName,
                appName = "Filter Test App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = timestamp,
                lastScrapedAt = timestamp
            )
        )

        // Insert multiple elements with different properties
        listOf(
            ScrapedElementDTO(
                elementHash = "clickable1",
                packageName = packageName,
                screenHash = "screen1",
                resourceId = "button1",
                className = "Button",
                text = "Clickable",
                contentDescription = "Clickable Button",
                isClickable = true,
                isScrollable = false,
                isEditable = false,
                boundsInScreen = "[0,0][100,50]",
                parentHash = null,
                firstSeenAt = timestamp,
                lastSeenAt = timestamp,
                clickCount = 0L,
                inferredLabel = null
            ),
            ScrapedElementDTO(
                elementHash = "editable1",
                packageName = packageName,
                screenHash = "screen1",
                resourceId = "input1",
                className = "EditText",
                text = "",
                contentDescription = "Text Input",
                isClickable = false,
                isScrollable = false,
                isEditable = true,
                boundsInScreen = "[0,50][200,100]",
                parentHash = null,
                firstSeenAt = timestamp,
                lastSeenAt = timestamp,
                clickCount = 0L,
                inferredLabel = null
            ),
            ScrapedElementDTO(
                elementHash = "scrollable1",
                packageName = packageName,
                screenHash = "screen1",
                resourceId = "list1",
                className = "RecyclerView",
                text = "",
                contentDescription = "List",
                isClickable = false,
                isScrollable = true,
                isEditable = false,
                boundsInScreen = "[0,100][200,400]",
                parentHash = null,
                firstSeenAt = timestamp,
                lastSeenAt = timestamp,
                clickCount = 0L,
                inferredLabel = null
            )
        ).forEach { databaseManager.scrapedElements.insert(it) }

        // Query all elements
        val allElements = databaseManager.scrapedElements.getByPackageName(packageName)
        assertThat(allElements).hasSize(3)

        // Filter results
        val clickableElements = allElements.filter { it.isClickable }
        val editableElements = allElements.filter { it.isEditable }
        val scrollableElements = allElements.filter { it.isScrollable }

        assertThat(clickableElements).hasSize(1)
        assertThat(clickableElements[0].text).isEqualTo("Clickable")

        assertThat(editableElements).hasSize(1)
        assertThat(editableElements[0].className).isEqualTo("EditText")

        assertThat(scrollableElements).hasSize(1)
        assertThat(scrollableElements[0].className).isEqualTo("RecyclerView")
    }

    /**
     * TEST 8: Verify query operations are exception-safe
     */
    @Test
    fun `query operations are exception safe`() = runTest {
        // This should not throw even if data doesn't exist
        val app = databaseManager.scrapedApps.getByPackageName("com.example.nonexistent")
        assertThat(app).isNull()

        // Query all on empty database
        val allApps = databaseManager.scrapedApps.getAll()
        assertThat(allApps).isEmpty()

        // These operations should complete without throwing
    }

    /**
     * TEST 9: Verify complex query with multiple conditions
     */
    @Test
    fun `complex query with multiple conditions works`() = runTest {
        val timestamp = now()

        // Insert multiple apps with different versions
        listOf(
            ScrapedAppDTO(
                packageName = "com.example.app1",
                appName = "App 1",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = past(1000),
                lastScrapedAt = past(500)
            ),
            ScrapedAppDTO(
                packageName = "com.example.app2",
                appName = "App 2",
                versionCode = 5L,
                versionName = "5.0",
                firstScrapedAt = past(2000),
                lastScrapedAt = timestamp
            ),
            ScrapedAppDTO(
                packageName = "com.example.app3",
                appName = "App 3",
                versionCode = 10L,
                versionName = "10.0",
                firstScrapedAt = past(3000),
                lastScrapedAt = past(100)
            )
        ).forEach { databaseManager.scrapedApps.insert(it) }

        // Query all and filter
        val allApps = databaseManager.scrapedApps.getAll()
        assertThat(allApps).hasSize(3)

        // Find apps with version >= 5
        val recentVersions = allApps.filter { it.versionCode >= 5L }
        assertThat(recentVersions).hasSize(2)
        assertThat(recentVersions.map { it.packageName }).containsExactly(
            "com.example.app2",
            "com.example.app3"
        )
    }

    /**
     * TEST 10: Verify query by screen hash
     */
    @Test
    fun `query elements by screen hash works`() = runTest {
        val timestamp = now()
        val packageName = "com.example.app"

        // Insert app
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = packageName,
                appName = "Test App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = timestamp,
                lastScrapedAt = timestamp
            )
        )

        // Insert elements on different screens
        listOf(
            ScrapedElementDTO(
                elementHash = "elem1",
                packageName = packageName,
                screenHash = "screen1",
                resourceId = "button1",
                className = "Button",
                text = "Screen 1 Button",
                contentDescription = "Button",
                isClickable = true,
                isScrollable = false,
                isEditable = false,
                boundsInScreen = "[0,0][100,50]",
                parentHash = null,
                firstSeenAt = timestamp,
                lastSeenAt = timestamp,
                clickCount = 0L,
                inferredLabel = null
            ),
            ScrapedElementDTO(
                elementHash = "elem2",
                packageName = packageName,
                screenHash = "screen2",
                resourceId = "button2",
                className = "Button",
                text = "Screen 2 Button",
                contentDescription = "Button",
                isClickable = true,
                isScrollable = false,
                isEditable = false,
                boundsInScreen = "[0,0][100,50]",
                parentHash = null,
                firstSeenAt = timestamp,
                lastSeenAt = timestamp,
                clickCount = 0L,
                inferredLabel = null
            )
        ).forEach { databaseManager.scrapedElements.insert(it) }

        // Query by screen hash
        val allElements = databaseManager.scrapedElements.getByPackageName(packageName)
        val screen1Elements = allElements.filter { it.screenHash == "screen1" }
        val screen2Elements = allElements.filter { it.screenHash == "screen2" }

        assertThat(screen1Elements).hasSize(1)
        assertThat(screen1Elements[0].text).isEqualTo("Screen 1 Button")

        assertThat(screen2Elements).hasSize(1)
        assertThat(screen2Elements[0].text).isEqualTo("Screen 2 Button")
    }

    /**
     * TEST 11: Verify query returns consistent results
     */
    @Test
    fun `query returns consistent results on multiple calls`() = runTest {
        // Insert data
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = "com.example.consistent",
                appName = "Consistent App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = now(),
                lastScrapedAt = now()
            )
        )

        // Query multiple times
        val result1 = databaseManager.scrapedApps.getByPackageName("com.example.consistent")
        val result2 = databaseManager.scrapedApps.getByPackageName("com.example.consistent")
        val result3 = databaseManager.scrapedApps.getByPackageName("com.example.consistent")

        // All results should be consistent
        assertThat(result1).isNotNull()
        assertThat(result2).isNotNull()
        assertThat(result3).isNotNull()

        assertThat(result1?.packageName).isEqualTo(result2?.packageName)
        assertThat(result2?.packageName).isEqualTo(result3?.packageName)
        assertThat(result1?.appName).isEqualTo(result2?.appName)
    }

    /**
     * TEST 12: Verify delete and query
     */
    @Test
    fun `query after delete returns correct results`() = runTest {
        val packageName = "com.example.deletable"

        // Insert
        databaseManager.scrapedApps.insert(
            ScrapedAppDTO(
                packageName = packageName,
                appName = "Deletable App",
                versionCode = 1L,
                versionName = "1.0",
                firstScrapedAt = now(),
                lastScrapedAt = now()
            )
        )

        // Verify exists
        val beforeDelete = databaseManager.scrapedApps.getByPackageName(packageName)
        assertThat(beforeDelete).isNotNull()

        // Delete
        databaseManager.scrapedApps.delete(packageName)

        // Verify deleted
        val afterDelete = databaseManager.scrapedApps.getByPackageName(packageName)
        assertThat(afterDelete).isNull()
    }
}
