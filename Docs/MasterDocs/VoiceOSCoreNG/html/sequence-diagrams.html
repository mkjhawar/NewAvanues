<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequence Diagrams - VoiceOSCoreNG Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --accent-primary: #0d6efd;
            --accent-secondary: #6610f2;
            --border-color: #dee2e6;
            --code-bg: #f1f3f5;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --text-muted: #868e96;
            --accent-primary: #4dabf7;
            --accent-secondary: #9775fa;
            --border-color: #343a40;
            --code-bg: #2d2d44;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 { font-size: 1.25rem; }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
        }

        nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 2rem;
            position: sticky;
            top: 64px;
            z-index: 99;
        }

        nav ul {
            max-width: 1200px;
            margin: 0 auto;
            list-style: none;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        nav a {
            display: block;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
        }

        nav a:hover, nav a.active {
            background: var(--accent-primary);
            color: white;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        h2 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        h3 {
            color: var(--text-primary);
            margin: 2rem 0 1rem;
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .diagram-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .diagram-container h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        .explanation {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .explanation h4 {
            color: var(--accent-primary);
            margin-bottom: 0.75rem;
        }

        .explanation ul, .explanation ol {
            margin-left: 1.5rem;
            color: var(--text-secondary);
        }

        .explanation li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--code-bg);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--accent-secondary);
        }

        .timeline {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .timeline-item {
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .timeline-arrow {
            color: var(--text-muted);
        }

        footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 2rem;
            margin-top: 3rem;
            text-align: center;
            color: var(--text-muted);
        }

        footer a { color: var(--accent-primary); text-decoration: none; }

        @media (max-width: 768px) {
            header, nav, main { padding-left: 1rem; padding-right: 1rem; }
            nav { top: auto; position: relative; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>VoiceOSCoreNG - Sequence Diagrams</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">&#9790;</button>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="index.html">Overview</a></li>
            <li><a href="architecture.html">Architecture</a></li>
            <li><a href="flowcharts.html">Flowcharts</a></li>
            <li><a href="sequence-diagrams.html" class="active">Sequences</a></li>
            <li><a href="class-diagrams.html">Classes</a></li>
        </ul>
    </nav>

    <main>
        <h2>Sequence Diagrams</h2>
        <p>
            These diagrams show the step-by-step message flow between components for key operations
            in the VoiceOSCoreNG system.
        </p>

        <div class="diagram-container">
            <h3>Voice Command Processing - Full Flow</h3>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant User
    participant SpeechEngine as ISpeechEngine
    participant VoiceOS as VoiceOSCoreNG
    participant Coordinator as ActionCoordinator
    participant CmdReg as CommandRegistry
    participant StaticReg as StaticCommandRegistry
    participant HandlerReg as HandlerRegistry
    participant Handler as IHandler
    participant Executor as Platform Executor

    User->>SpeechEngine: Speak "click Submit"
    activate SpeechEngine
    SpeechEngine->>SpeechEngine: Audio capture & processing
    SpeechEngine-->>VoiceOS: SpeechResult(text="click Submit", conf=0.95)
    deactivate SpeechEngine

    activate VoiceOS
    VoiceOS->>Coordinator: processVoiceCommand("click Submit", 0.95)
    activate Coordinator

    Note over Coordinator: Step 1: Extract verb & target
    Coordinator->>Coordinator: extractVerbAndTarget("click Submit")
    Note right of Coordinator: verb="click", target="submit"

    Note over Coordinator: Step 2: Dynamic command lookup
    Coordinator->>CmdReg: findByPhrase("submit")
    alt Found in Dynamic Registry
        CmdReg-->>Coordinator: QuantizedCommand(VUID="abc123")
        Coordinator->>HandlerReg: findHandler("click submit")
        HandlerReg-->>Coordinator: UIHandler
        Coordinator->>Handler: execute(command)
        Handler->>Executor: clickByVuid("abc123")
        Executor-->>Handler: true
        Handler-->>Coordinator: Success("Clicked Submit")
    else Not Found - Try Static
        CmdReg-->>Coordinator: null
        Coordinator->>StaticReg: findByPhrase("click submit")
        StaticReg-->>Coordinator: null
        Coordinator->>HandlerReg: canHandle("click submit")
        HandlerReg-->>Coordinator: true (UIHandler)
        Coordinator->>HandlerReg: findHandler("click submit")
        HandlerReg-->>Coordinator: UIHandler
        Coordinator->>Handler: execute(command)
        Handler->>Executor: clickByText("submit")
        Executor-->>Handler: true
        Handler-->>Coordinator: Success("Clicked submit")
    end

    Coordinator-->>VoiceOS: HandlerResult.Success
    deactivate Coordinator

    VoiceOS-->>User: Feedback: "Clicked Submit"
    deactivate VoiceOS
            </div>
        </div>

        <div class="explanation">
            <h4>Key Interactions</h4>
            <ul>
                <li><strong>Steps 1-3:</strong> Speech engine captures audio and emits SpeechResult</li>
                <li><strong>Steps 4-6:</strong> ActionCoordinator extracts verb and target from natural language</li>
                <li><strong>Steps 7-10:</strong> Dynamic registry lookup with VUID for direct execution</li>
                <li><strong>Steps 11-16:</strong> Static handler fallback with text-based element search</li>
            </ul>
        </div>

        <div class="diagram-container">
            <h3>System Initialization Sequence</h3>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant App as Application
    participant VoiceOS as VoiceOSCoreNG
    participant Config as LearnAppConfig
    participant Toggle as LearnAppDevToggle
    participant Coordinator as ActionCoordinator
    participant HandlerReg as HandlerRegistry
    participant Factory as HandlerFactory
    participant AppHandler as AppHandler

    App->>VoiceOS: initialize(tier=LITE, isDebug=true)
    activate VoiceOS

    VoiceOS->>Toggle: initialize(tier, isDebug)
    Toggle-->>VoiceOS: OK

    VoiceOS->>Config: setVariant(tier)
    Config-->>VoiceOS: OK

    alt Debug Build
        VoiceOS->>Config: DeveloperSettings.enable(unlockAll=false)
    end

    VoiceOS-->>App: initialized = true
    deactivate VoiceOS

    Note over App: Create ActionCoordinator with handlers

    App->>Factory: createHandlers(accessibilityService)
    activate Factory
    Factory->>Factory: Create SystemHandler(executor)
    Factory->>Factory: Create NavigationHandler(executor)
    Factory->>Factory: Create UIHandler(executor)
    Factory->>Factory: Create InputHandler(executor)
    Factory->>Factory: Create AppHandler(launcher)
    Factory-->>App: List<IHandler>
    deactivate Factory

    App->>Coordinator: initialize(handlers)
    activate Coordinator

    loop For each handler
        Coordinator->>HandlerReg: register(handler)
        HandlerReg->>HandlerReg: Add to category map
    end

    Coordinator->>HandlerReg: initializeAll()
    activate HandlerReg

    loop For each handler
        HandlerReg->>AppHandler: initialize()
        AppHandler->>AppHandler: syncInstalledApps()
        Note right of AppHandler: Loads 150+ apps
    end

    HandlerReg-->>Coordinator: successCount
    deactivate HandlerReg

    Coordinator-->>App: CoordinatorState.READY
    deactivate Coordinator
            </div>
        </div>

        <div class="explanation">
            <h4>Initialization Timeline</h4>
            <div class="timeline">
                <span class="timeline-item">VoiceOSCoreNG.initialize()</span>
                <span class="timeline-arrow">&#8594;</span>
                <span class="timeline-item">Config Setup</span>
                <span class="timeline-arrow">&#8594;</span>
                <span class="timeline-item">Handler Creation</span>
                <span class="timeline-arrow">&#8594;</span>
                <span class="timeline-item">Handler Registration</span>
                <span class="timeline-arrow">&#8594;</span>
                <span class="timeline-item">App Sync</span>
                <span class="timeline-arrow">&#8594;</span>
                <span class="timeline-item">Ready</span>
            </div>
        </div>

        <div class="diagram-container">
            <h3>Dynamic Command Update (Screen Scan)</h3>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant A11y as AccessibilityService
    participant Explorer as ExplorationEngine
    participant Extractor as UnifiedExtractor
    participant Coordinator as ActionCoordinator
    participant CmdReg as CommandRegistry
    participant SpeechEng as ISpeechEngine

    Note over A11y: Screen content changed

    A11y->>Explorer: onWindowContentChanged(event)
    activate Explorer

    Explorer->>Explorer: Debounce (300ms)
    Explorer->>A11y: getRootInActiveWindow()
    A11y-->>Explorer: AccessibilityNodeInfo

    Explorer->>Extractor: extract(rootNode)
    activate Extractor
    Extractor->>Extractor: Walk UI tree
    Extractor->>Extractor: Filter actionable elements
    Extractor->>Extractor: Generate VUIDs
    Extractor->>Extractor: Create QuantizedElements
    Extractor-->>Explorer: List<QuantizedElement>
    deactivate Extractor

    Explorer->>Explorer: Convert to QuantizedCommands
    Note right of Explorer: "1 Submit" -> CMD with VUID

    Explorer->>Coordinator: updateDynamicCommands(commands)
    activate Coordinator

    Coordinator->>CmdReg: update(commands)
    CmdReg->>CmdReg: Clear existing
    CmdReg->>CmdReg: Index by VUID
    CmdReg-->>Coordinator: OK

    Coordinator->>Coordinator: Get command phrases
    Coordinator->>SpeechEng: updateCommands(phrases)
    SpeechEng->>SpeechEng: Rebuild recognition grammar
    SpeechEng-->>Coordinator: OK

    Coordinator-->>Explorer: Success
    deactivate Coordinator

    deactivate Explorer
            </div>
        </div>

        <div class="explanation">
            <h4>Screen Scan Details</h4>
            <ul>
                <li><strong>Debouncing:</strong> 300ms delay to prevent rapid-fire updates during scrolling</li>
                <li><strong>VUID Generation:</strong> Unique IDs based on element properties and position</li>
                <li><strong>Grammar Update:</strong> Speech engine vocabulary updated for context-sensitive recognition</li>
                <li><strong>Atomic Update:</strong> CommandRegistry replaces all commands atomically (no accumulation)</li>
            </ul>
        </div>

        <div class="diagram-container">
            <h3>NLU/LLM Fallback Sequence</h3>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant Coordinator as ActionCoordinator
    participant CmdReg as CommandRegistry
    participant HandlerReg as HandlerRegistry
    participant NLU as INluProcessor
    participant LLM as ILlmProcessor
    participant VoiceInterp as VoiceInterpreter

    Note over Coordinator: Command: "dismiss this popup"

    Coordinator->>CmdReg: findByPhrase("dismiss this popup")
    CmdReg-->>Coordinator: null (no dynamic match)

    Coordinator->>HandlerReg: canHandle("dismiss this popup")
    HandlerReg-->>Coordinator: false (no static handler)

    alt NLU Enabled
        Coordinator->>Coordinator: getAllQuantizedCommands()
        Coordinator->>NLU: isAvailable()
        NLU-->>Coordinator: true

        Coordinator->>NLU: classify("dismiss this popup", commands)
        activate NLU
        NLU->>NLU: BERT embedding comparison
        NLU->>NLU: Semantic similarity scoring
        alt High Confidence Match
            NLU-->>Coordinator: NluResult.Match(command="dismiss", conf=0.92)
            deactivate NLU
            Note over Coordinator: Execute matched command
        else No Match
            NLU-->>Coordinator: NluResult.NoMatch
        end
    end

    alt LLM Enabled & NLU Failed
        Coordinator->>LLM: isAvailable()
        LLM-->>Coordinator: true

        Coordinator->>Coordinator: getNluSchema()
        Coordinator->>LLM: interpretCommand(text, schema, commands)
        activate LLM
        LLM->>LLM: Prompt construction
        LLM->>LLM: LLM inference
        alt Interpreted
            LLM-->>Coordinator: LlmResult.Interpreted("dismiss", conf=0.85)
            deactivate LLM
            Note over Coordinator: Execute interpreted command
        else Failed
            LLM-->>Coordinator: LlmResult.NoMatch
        end
    end

    alt All AI Failed
        Coordinator->>VoiceInterp: interpret("dismiss this popup")
        VoiceInterp->>VoiceInterp: Keyword mapping lookup
        alt Found Mapping
            VoiceInterp-->>Coordinator: "dismiss"
            Note over Coordinator: Execute legacy command
        else No Mapping
            VoiceInterp-->>Coordinator: null
            Coordinator-->>Coordinator: HandlerResult.Failure("Unknown command")
        end
    end
            </div>
        </div>

        <div class="explanation">
            <h4>AI Fallback Chain</h4>
            <ol>
                <li><strong>NLU (BERT-based):</strong> Fast semantic matching against known commands</li>
                <li><strong>LLM (Large Language Model):</strong> Natural language interpretation for complex queries</li>
                <li><strong>Voice Interpreter:</strong> Legacy keyword-to-action mapping as final fallback</li>
            </ol>
        </div>

        <div class="diagram-container">
            <h3>UI Disambiguation Sequence</h3>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant User
    participant Coordinator as ActionCoordinator
    participant UIHandler as UIHandler
    participant Disambiguator as ElementDisambiguator
    participant Executor as UIExecutor
    participant Overlay as OverlayService

    User->>Coordinator: "click Settings"
    Coordinator->>UIHandler: execute(command)
    activate UIHandler

    UIHandler->>Executor: getScreenElements()
    Executor-->>UIHandler: List<ElementInfo>

    UIHandler->>Disambiguator: findMatches("settings", elements)
    activate Disambiguator
    Disambiguator->>Disambiguator: Filter by text/contentDescription
    Disambiguator-->>UIHandler: DisambiguationResult(matches=3)
    deactivate Disambiguator

    Note over UIHandler: Multiple matches found

    UIHandler->>Overlay: onShowDisambiguation(result)
    Overlay->>Overlay: Show numbered badges on matches only

    UIHandler-->>Coordinator: AwaitingSelection(count=3)
    Coordinator-->>User: "3 'Settings' found. Say a number."

    User->>Coordinator: "two"
    Coordinator->>UIHandler: handleNumberSelection(2)

    UIHandler->>Disambiguator: selectByNumber(result, 2)
    Disambiguator-->>UIHandler: ElementInfo (2nd match)

    UIHandler->>Overlay: onHideDisambiguation()
    Overlay->>Overlay: Remove numbered badges

    UIHandler->>Executor: clickElement(element)
    Executor-->>UIHandler: true

    UIHandler-->>Coordinator: Success("Clicked Settings")
    deactivate UIHandler

    Coordinator-->>User: "Clicked Settings"
            </div>
        </div>

        <div class="explanation">
            <h4>Disambiguation Flow</h4>
            <ul>
                <li><strong>Step 3-5:</strong> Screen elements retrieved and filtered for matches</li>
                <li><strong>Step 7:</strong> Numbered overlay shown ONLY on matching elements</li>
                <li><strong>Step 9:</strong> User speaks number to select desired element</li>
                <li><strong>Step 12:</strong> Overlay cleared before action execution</li>
            </ul>
        </div>

        <div class="diagram-container">
            <h3>Handler Disposal Sequence</h3>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant Service as AccessibilityService
    participant Coordinator as ActionCoordinator
    participant HandlerReg as HandlerRegistry
    participant CmdReg as CommandRegistry
    participant Handlers as IHandler[]
    participant Scope as CoroutineScope

    Service->>Coordinator: dispose()
    activate Coordinator

    Coordinator->>Coordinator: state = DISPOSING

    Coordinator->>HandlerReg: disposeAll()
    activate HandlerReg

    loop For each handler
        HandlerReg->>Handlers: dispose()
        Handlers->>Handlers: Release resources
        Handlers-->>HandlerReg: OK
    end

    HandlerReg-->>Coordinator: successCount
    deactivate HandlerReg

    Coordinator->>HandlerReg: clear()
    HandlerReg->>HandlerReg: Remove all handlers

    Coordinator->>CmdReg: clear()
    CmdReg->>CmdReg: commandsSnapshot = emptyMap()

    Coordinator->>Scope: cancel()
    Scope->>Scope: Cancel all coroutines

    Coordinator->>Coordinator: state = DISPOSED
    Coordinator-->>Service: Complete
    deactivate Coordinator
            </div>
        </div>

        <div class="explanation">
            <h4>Cleanup Order</h4>
            <ol>
                <li><strong>State Transition:</strong> Set DISPOSING to prevent new operations</li>
                <li><strong>Handler Disposal:</strong> Call dispose() on each handler for resource cleanup</li>
                <li><strong>Registry Clearing:</strong> Remove all handlers and commands</li>
                <li><strong>Scope Cancellation:</strong> Cancel pending coroutines</li>
                <li><strong>Final State:</strong> Set DISPOSED to mark completion</li>
            </ol>
        </div>
    </main>

    <footer>
        <p>VoiceOSCoreNG v2.0.0 | <a href="index.html">Back to Overview</a></p>
    </footer>

    <script>
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        mermaid.initialize({
            startOnLoad: true,
            theme: savedTheme === 'dark' ? 'dark' : 'default',
            sequence: {
                useMaxWidth: true,
                wrap: true,
                actorMargin: 50
            }
        });

        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            location.reload();
        }
    </script>
</body>
</html>
