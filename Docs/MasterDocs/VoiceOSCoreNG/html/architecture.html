<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture - VoiceOSCoreNG Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --accent-primary: #0d6efd;
            --accent-secondary: #6610f2;
            --border-color: #dee2e6;
            --code-bg: #f1f3f5;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --text-muted: #868e96;
            --accent-primary: #4dabf7;
            --accent-secondary: #9775fa;
            --border-color: #343a40;
            --code-bg: #2d2d44;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.25rem;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
        }

        nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 2rem;
            position: sticky;
            top: 64px;
            z-index: 99;
        }

        nav ul {
            max-width: 1200px;
            margin: 0 auto;
            list-style: none;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        nav a {
            display: block;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }

        nav a:hover, nav a.active {
            background: var(--accent-primary);
            color: white;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        h2 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        h3 {
            color: var(--text-primary);
            margin: 2rem 0 1rem;
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .diagram-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .diagram-container h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        .explanation {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .explanation h4 {
            color: var(--accent-primary);
            margin-bottom: 0.75rem;
        }

        .explanation ul {
            margin-left: 1.5rem;
            color: var(--text-secondary);
        }

        .explanation li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--code-bg);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--accent-secondary);
        }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .component-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem;
        }

        .component-card h4 {
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .component-card p {
            font-size: 0.925rem;
            margin-bottom: 0.5rem;
        }

        .component-card code {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 2rem;
            margin-top: 3rem;
            text-align: center;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            header, nav, main {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            nav {
                top: auto;
                position: relative;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>VoiceOSCoreNG - System Architecture</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">&#9790;</button>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="index.html">Overview</a></li>
            <li><a href="architecture.html" class="active">Architecture</a></li>
            <li><a href="flowcharts.html">Flowcharts</a></li>
            <li><a href="sequence-diagrams.html">Sequences</a></li>
            <li><a href="class-diagrams.html">Classes</a></li>
        </ul>
    </nav>

    <main>
        <h2>System Architecture Overview</h2>
        <p>
            VoiceOSCoreNG is built on a modular, KMP-compatible architecture that separates concerns
            between command coordination, handler management, and platform-specific execution.
        </p>

        <div class="diagram-container">
            <h3>High-Level Architecture</h3>
            <div class="mermaid">
graph TB
    subgraph "Voice Input Layer"
        VoiceInput["&#127908; Voice Input"]
        SpeechEngine["Speech Engine<br/>(ISpeechEngine)"]
    end

    subgraph "Core Processing Layer"
        VoiceOSCoreNG["VoiceOSCoreNG<br/>(Main Facade)"]
        ActionCoordinator["ActionCoordinator<br/>(Command Router)"]
        CommandRegistry["CommandRegistry<br/>(Dynamic Commands)"]
        StaticRegistry["StaticCommandRegistry<br/>(System Commands)"]
    end

    subgraph "Handler Layer"
        HandlerRegistry["HandlerRegistry<br/>(Priority Lookup)"]
        SystemH["SystemHandler<br/>Priority: 1"]
        NavH["NavigationHandler<br/>Priority: 2"]
        AppH["AppHandler<br/>Priority: 3"]
        UIH["UIHandler<br/>Priority: 6"]
        InputH["InputHandler<br/>Priority: 8"]
    end

    subgraph "Executor Layer (Platform-Specific)"
        SysExec["SystemExecutor"]
        NavExec["NavigationExecutor"]
        AppExec["IAppLauncher"]
        UIExec["UIExecutor"]
        InputExec["InputExecutor"]
    end

    subgraph "AI Layer (Optional)"
        NLU["NLU Processor<br/>(BERT-based)"]
        LLM["LLM Processor<br/>(Natural Language)"]
    end

    VoiceInput --> SpeechEngine
    SpeechEngine --> VoiceOSCoreNG
    VoiceOSCoreNG --> ActionCoordinator
    ActionCoordinator --> CommandRegistry
    ActionCoordinator --> StaticRegistry
    ActionCoordinator --> HandlerRegistry
    ActionCoordinator --> NLU
    ActionCoordinator --> LLM

    HandlerRegistry --> SystemH
    HandlerRegistry --> NavH
    HandlerRegistry --> AppH
    HandlerRegistry --> UIH
    HandlerRegistry --> InputH

    SystemH --> SysExec
    NavH --> NavExec
    AppH --> AppExec
    UIH --> UIExec
    InputH --> InputExec

    style VoiceOSCoreNG fill:#4dabf7,stroke:#1864ab,color:#fff
    style ActionCoordinator fill:#9775fa,stroke:#6741d9,color:#fff
    style HandlerRegistry fill:#69db7c,stroke:#2b8a3e,color:#fff
    style NLU fill:#fcc419,stroke:#e67700,color:#000
    style LLM fill:#fcc419,stroke:#e67700,color:#000
            </div>
        </div>

        <div class="explanation">
            <h4>Layer Responsibilities</h4>
            <ul>
                <li><strong>Voice Input Layer:</strong> Captures speech via platform-specific engines and converts to text</li>
                <li><strong>Core Processing Layer:</strong> Routes commands through 5-level priority matching system</li>
                <li><strong>Handler Layer:</strong> KMP handlers that define command logic without platform dependencies</li>
                <li><strong>Executor Layer:</strong> Platform-specific implementations (Android, iOS, Desktop)</li>
                <li><strong>AI Layer:</strong> Optional NLU/LLM for natural language understanding</li>
            </ul>
        </div>

        <h3>Component Details</h3>
        <div class="component-grid">
            <div class="component-card">
                <h4>VoiceOSCoreNG</h4>
                <p>Main facade and entry point. Provides builder-pattern initialization and configuration management.</p>
                <code>VoiceOSCoreNG.initialize(tier, isDebug)</code>
            </div>
            <div class="component-card">
                <h4>ActionCoordinator</h4>
                <p>Central command router implementing 5-level priority matching with dynamic and static command support.</p>
                <code>processVoiceCommand(text, confidence)</code>
            </div>
            <div class="component-card">
                <h4>HandlerRegistry</h4>
                <p>Manages handler registration and priority-based lookup using ActionCategory ordering.</p>
                <code>findHandler(action): IHandler?</code>
            </div>
            <div class="component-card">
                <h4>CommandRegistry</h4>
                <p>In-memory storage for dynamic screen-specific commands using VUID-based lookup.</p>
                <code>findByPhrase(phrase): QuantizedCommand?</code>
            </div>
        </div>

        <div class="diagram-container">
            <h3>Handler-Executor Pattern</h3>
            <div class="mermaid">
graph LR
    subgraph "KMP Common Code"
        IHandler["IHandler<br/>(Interface)"]
        BaseHandler["BaseHandler<br/>(Abstract)"]
        SystemHandler["SystemHandler"]
        NavHandler["NavigationHandler"]
        UIHandler["UIHandler"]
        InputHandler["InputHandler"]
        AppHandler["AppHandler"]
    end

    subgraph "Platform Executors"
        subgraph "Android"
            AndroidSysExec["AndroidSystemExecutor"]
            AndroidNavExec["AndroidNavigationExecutor"]
            AndroidUIExec["AndroidUIExecutor"]
            AndroidInputExec["AndroidInputExecutor"]
            AndroidAppLauncher["AndroidAppLauncher"]
        end
        subgraph "iOS"
            iOSSysExec["iOSSystemExecutor"]
            iOSNavExec["iOSNavigationExecutor"]
        end
        subgraph "Desktop"
            DesktopSysExec["DesktopSystemExecutor"]
            DesktopNavExec["DesktopNavigationExecutor"]
        end
    end

    IHandler --> BaseHandler
    BaseHandler --> SystemHandler
    BaseHandler --> NavHandler
    BaseHandler --> UIHandler
    BaseHandler --> InputHandler
    BaseHandler --> AppHandler

    SystemHandler -.-> AndroidSysExec
    SystemHandler -.-> iOSSysExec
    SystemHandler -.-> DesktopSysExec

    NavHandler -.-> AndroidNavExec
    NavHandler -.-> iOSNavExec
    NavHandler -.-> DesktopNavExec

    UIHandler -.-> AndroidUIExec
    InputHandler -.-> AndroidInputExec
    AppHandler -.-> AndroidAppLauncher

    style IHandler fill:#4dabf7,stroke:#1864ab,color:#fff
    style BaseHandler fill:#4dabf7,stroke:#1864ab,color:#fff
            </div>
        </div>

        <div class="explanation">
            <h4>KMP Strategy Pattern</h4>
            <ul>
                <li><strong>IHandler Interface:</strong> Defines common contract for all handlers (KMP common)</li>
                <li><strong>BaseHandler:</strong> Provides default <code>canHandle()</code> implementation with fuzzy matching</li>
                <li><strong>Executor Interfaces:</strong> Abstract platform operations (SystemExecutor, NavigationExecutor, etc.)</li>
                <li><strong>Platform Executors:</strong> Implement native functionality using platform APIs</li>
            </ul>
        </div>

        <div class="diagram-container">
            <h3>Speech Engine Architecture</h3>
            <div class="mermaid">
graph TB
    subgraph "Speech Engine Factory"
        Factory["ISpeechEngineFactory"]
    end

    subgraph "Speech Engines (ISpeechEngine)"
        AndroidSTT["Android STT<br/>(Built-in)"]
        GoogleCloud["Google Cloud<br/>Speech API"]
        Azure["Azure<br/>Speech Services"]
        Vivoka["Vivoka SDK<br/>(Offline)"]
        Vosk["Vosk<br/>(Offline OSS)"]
        AppleSpeech["Apple Speech<br/>(iOS/macOS)"]
    end

    subgraph "Engine State Machine"
        Uninit["Uninitialized"]
        Init["Initializing"]
        Ready["Ready"]
        Listen["Listening"]
        Process["Processing"]
        Error["Error"]
        Destroyed["Destroyed"]
    end

    Factory --> AndroidSTT
    Factory --> GoogleCloud
    Factory --> Azure
    Factory --> Vivoka
    Factory --> Vosk
    Factory --> AppleSpeech

    Uninit --> Init
    Init --> Ready
    Init --> Error
    Ready --> Listen
    Listen --> Process
    Process --> Ready
    Ready --> Destroyed
    Error --> Destroyed

    style Factory fill:#9775fa,stroke:#6741d9,color:#fff
    style Ready fill:#69db7c,stroke:#2b8a3e,color:#fff
    style Listen fill:#4dabf7,stroke:#1864ab,color:#fff
    style Error fill:#ff6b6b,stroke:#c92a2a,color:#fff
            </div>
        </div>

        <div class="explanation">
            <h4>Speech Engine Features</h4>
            <ul>
                <li><strong>Unified Interface:</strong> All engines implement <code>ISpeechEngine</code> for consistent API</li>
                <li><strong>Factory Pattern:</strong> <code>ISpeechEngineFactory</code> creates platform-appropriate engines</li>
                <li><strong>State Flow:</strong> Observable <code>StateFlow&lt;EngineState&gt;</code> for reactive UI updates</li>
                <li><strong>Dynamic Vocabulary:</strong> <code>updateCommands()</code> for context-sensitive recognition</li>
            </ul>
        </div>

        <div class="diagram-container">
            <h3>Data Flow Architecture</h3>
            <div class="mermaid">
graph LR
    subgraph "Input"
        Voice["&#127908; Voice"]
        Screen["&#128241; Screen Scan"]
    end

    subgraph "Processing"
        Speech["SpeechResult<br/>(text, confidence)"]
        QCmd["QuantizedCommand<br/>(phrase, actionType, VUID)"]
        QScreen["QuantizedScreen<br/>(elements, hash)"]
    end

    subgraph "Registry"
        CmdReg["CommandRegistry<br/>(VUID -> Command)"]
        StaticReg["StaticCommandRegistry<br/>(phrase -> action)"]
    end

    subgraph "Execution"
        Handler["IHandler<br/>.execute()"]
        Result["HandlerResult<br/>(Success/Failure/Awaiting)"]
    end

    Voice --> Speech
    Speech --> QCmd
    Screen --> QScreen
    QScreen --> CmdReg
    QCmd --> CmdReg
    QCmd --> StaticReg
    CmdReg --> Handler
    StaticReg --> Handler
    Handler --> Result

    style QCmd fill:#4dabf7,stroke:#1864ab,color:#fff
    style Result fill:#69db7c,stroke:#2b8a3e,color:#fff
            </div>
        </div>

        <h3>Key Data Structures</h3>
        <div class="component-grid">
            <div class="component-card">
                <h4>QuantizedCommand</h4>
                <p>Represents a voice command with phrase, action type, target VUID, and confidence score.</p>
                <code>CMD:uuid:phrase:actionType:vuid:conf</code>
            </div>
            <div class="component-card">
                <h4>HandlerResult</h4>
                <p>Sealed class with Success, Failure, NotHandled, RequiresInput, InProgress, AwaitingSelection variants.</p>
                <code>HandlerResult.success("Clicked")</code>
            </div>
            <div class="component-card">
                <h4>ActionCategory</h4>
                <p>Enum defining handler priorities: SYSTEM(1), NAVIGATION(2), APP(3), ..., CUSTOM(11).</p>
                <code>ActionCategory.PRIORITY_ORDER</code>
            </div>
            <div class="component-card">
                <h4>EngineState</h4>
                <p>Sealed class for speech engine states: Uninitialized, Initializing, Ready, Listening, Processing, Error, Destroyed.</p>
                <code>state.isListening</code>
            </div>
        </div>
    </main>

    <footer>
        <p>VoiceOSCoreNG v2.0.0 | <a href="index.html">Back to Overview</a></p>
    </footer>

    <script>
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        mermaid.initialize({
            startOnLoad: true,
            theme: savedTheme === 'dark' ? 'dark' : 'default',
            themeVariables: {
                primaryColor: '#4dabf7',
                primaryTextColor: '#fff',
                primaryBorderColor: '#1864ab',
                lineColor: '#868e96',
                secondaryColor: '#9775fa',
                tertiaryColor: '#f8f9fa'
            }
        });

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            location.reload();
        }
    </script>
</body>
</html>
