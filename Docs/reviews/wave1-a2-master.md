## Database | 264 kt, 60 sq | Tier 1
PURPOSE: Unified KMP SQLite persistence layer for all Avanues modules — scraping, commands, browser, notes, Cockpit, plugins, AVID, VOS, and NLU learning data.
WHY: Single SQLDelight database (voiceos.db / VoiceOSDatabase) shared across all KMP targets, replacing fragmented Room databases (LearningDatabase, LearnWebDatabase, LearnAppDatabase) and providing cross-platform schema consistency.
DEPS: sqldelight-runtime, sqldelight-coroutines-extensions, sqldelight-android/native/sqlite drivers, SQLCipher (Android browser data), kotlinx-coroutines, kotlinx-serialization-json, kotlinx-datetime, kotlinx-atomicfu, Modules:AVID
CONSUMERS: VoiceOSCore (scraped_app, scraped_element, commands_generated, screen_context, screen_transition, user_interaction, vos_file_registry), Cockpit (CockpitSession/Frame/PinnedFrame/WorkflowStep/TimelineEvent/CockpitCrossFrameLink), NoteAvanue (note_entity, note_folder, note_attachment), WebAvanue (tab, favorite, history_entry, download, browser_settings, site_permission, session, scraped_websites, scraped_web_elements, scraped_web_command, web_app_whitelist), AI/NLU (recognition_learning, language_model, command_usage, command_history_entry), Plugin subsystem (plugins, plugin_dependencies, plugin_permissions, system_checkpoints), AVID (avid_elements, avid_hierarchy, avid_aliases, avid_analytics), CommandManager (commands_static, commands_scraped, custom_command, user_sequence, context_preference), LearnApp (learned_apps, screen_states, exploration_sessions, navigation_edges, app_consent_history)
KMP: commonMain (all .sq files, all interfaces, all impl repositories, DTOs, adapters) | androidMain (AndroidSqliteDriver + WAL/FK bootstrap, SQLCipher) | iosMain (NativeSqliteDriver — conditional compile) | desktopMain (SqliteDriver / JVM)
TABLES: scraped_app, scraped_element, scraped_hierarchy, commands_generated, commands_static, commands_scraped, screen_context, screen_transition, user_interaction, element_state_history, element_relationship, element_command, element_quality_metric, custom_command, command_history_entry, command_usage, context_preference, user_preference, user_sequence, avid_elements, avid_hierarchy, avid_aliases, avid_analytics, tab, tab_group, favorite, favorite_folder, favorite_tag, history_entry, download, browser_settings, site_permission, session, session_tab, learned_apps, screen_states, exploration_sessions, navigation_edges, app_consent_history, scraped_websites, scraped_web_elements, generated_web_commands, scraped_web_command, web_app_whitelist, plugins, plugin_dependencies, plugin_permissions, system_checkpoints, language_model, recognition_learning, gesture_learning, touch_gesture, vos_file_registry, phrase_suggestion, app_version, app_category_override, app_pattern_group, device_profile, usage_statistic, error_report, database_version, analytics_settings, retention_settings, note_entity, note_folder, note_attachment, CockpitSession, CockpitFrame, CockpitPinnedFrame, CockpitWorkflowStep, CockpitTimelineEvent, CockpitCrossFrameLink — 67 tables total
KEY_CLASSES: DatabaseDriverFactory (expect/actual KMP driver factory + WAL/FK bootstrap), SQLDelightScrapedElementRepository (core element persistence, 27-column element store), SQLDelightCommandRepository (custom command persistence with pipe-vs-JSON serialization gap), SQLDelightScrapedAppRepository (app scraping registry), SQLDelightPluginRepository (plugin lifecycle management)
HEALTH: YELLOW — Schema breadth and index coverage are strong. Android driver correctly enables FK constraints and WAL mode. Critical gap: no SQLDelight migration system (deriveSchemaFromMigrations=false, verifyMigrations=false) means any schema evolution silently drops user data on upgrade. Two parallel, incompatible web command stores (generated_web_commands vs scraped_web_command) and two parallel app registries (scraped_app vs learned_apps) create correctness gaps for consumers. Commented-out FK constraints on scraped_hierarchy and commands_generated allow orphan accumulation. Cockpit tables store timestamps as TEXT instead of INTEGER, breaking temporal ordering. CustomCommand.phrases serialized as pipe-delimited by repository but schema documents JSON array. getSuccessFailureRatio is a hardcoded stub returning 1.0 always. Rule 7 violations in 6+ files. Full details: docs/reviews/Database-Review-QualityAnalysis-260222-V1.md
