# WebAvanue Bug Fix Tasks

## Issue 1: Add New Page Dialog URL Validation

### Task 1.1: Update AddPageDialog composable
- [ ] Add `error: String? = null` parameter
- [ ] Add `isError = error != null` to OutlinedTextField
- [ ] Add `supportingText` to display error message inline
- [ ] Update colors for error state

### Task 1.2: Add validation state to BrowserScreen
- [ ] Add `addPageError` state variable
- [ ] Clear error in `onUrlChange` callback
- [ ] Pass error state to AddPageDialog

### Task 1.3: Implement synchronous validation in onConfirm
- [ ] Format URL with https:// if needed
- [ ] Call `UrlValidation.validate()` synchronously
- [ ] If Invalid: set error, return early (dialog stays open)
- [ ] If Valid: proceed with createTab, close dialog

---

## Issue 2: Download Status Persistence

### Task 2.1: Implement loadDownloads() properly
- [ ] Replace stub implementation with repository call
- [ ] Handle success/failure results
- [ ] Update isLoading state

### Task 2.2: Persist status changes in setupProgressMonitoring()
- [ ] Detect status transitions (PENDING â†’ DOWNLOADING, etc.)
- [ ] Call `repository.updateDownloadProgress()` on status change
- [ ] Call `repository.completeDownload()` when progress.isComplete

### Task 2.3: Handle edge cases
- [ ] Verify BroadcastReceiver backup path works
- [ ] Handle race conditions between ViewModel and Receiver
- [ ] Test with app restart mid-download

---

## Issue 3: Bookmark Folder Persistence

### Task 3.1: Add SQL queries to BrowserDatabase.sq
- [ ] insertFavoriteFolder
- [ ] selectAllFolders
- [ ] selectFolderById
- [ ] selectFoldersByParent
- [ ] selectRootFolders
- [ ] updateFolder
- [ ] deleteFolderById
- [ ] deleteFavoritesInFolder
- [ ] clearFolderFromFavorites

### Task 3.2: Add FavoriteFolder mappers to DbMappers.kt
- [ ] FavoriteFolder.toDbModel() extension
- [ ] Favorite_folder.toDomainModel() extension

### Task 3.3: Implement createFolder() in BrowserRepositoryImpl
- [ ] Call queries.insertFavoriteFolder()
- [ ] Return Result with success/failure
- [ ] Handle duplicate folder names

### Task 3.4: Implement getAllFolders() in BrowserRepositoryImpl
- [ ] Call queries.selectAllFolders()
- [ ] Map results to domain model
- [ ] Return Result with success/failure

### Task 3.5: Implement deleteFolder() in BrowserRepositoryImpl
- [ ] Handle deleteContents flag
- [ ] If true: call deleteFavoritesInFolder first
- [ ] If false: call clearFolderFromFavorites first
- [ ] Then call deleteFolderById
- [ ] Return Result with success/failure

---

## Verification Tasks

### Task V.1: Build Verification
- [ ] Run WebAvanue module build
- [ ] Run VoiceOSCore build
- [ ] Run AVA app build

### Task V.2: Test URL Validation Fix
- [ ] Test invalid URL shows error in dialog
- [ ] Test error clears on URL edit
- [ ] Test valid URL creates tab and closes dialog
- [ ] Test blank URL creates empty tab

### Task V.3: Test Download Status Fix
- [ ] Test download shows Downloading status
- [ ] Test completed download shows Completed status
- [ ] Test status persists after app restart

### Task V.4: Test Folder Persistence Fix
- [ ] Test create new folder saves to database
- [ ] Test folder appears in subsequent edits
- [ ] Test folder appears for other bookmarks
- [ ] Test delete folder options work correctly
