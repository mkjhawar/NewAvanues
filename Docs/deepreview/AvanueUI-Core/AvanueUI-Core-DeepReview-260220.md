# AvanueUI/Core — Deep Code Review
**Date:** 260220
**Reviewer:** code-reviewer agent
**Scope:** All 82 .kt files under `Modules/AvanueUI/Core/src/commonMain/`
**Branch:** HTTPAvanue

---

## Summary

The AvanueUI/Core module has two **Critical** KMP-breaking defects (a JVM-only `Math.toRadians()` in `commonMain` and a pervasive `TODO()` stub pattern that throws `NotImplementedError` instead of `Exception`) and a systemic architectural problem: the same class names are defined in multiple packages simultaneously, and roughly half the component classes do not implement the `Component` interface. The module will not compile on iOS/JS as-is and cannot be safely rendered through the DSL.

---

## Issues

| Severity | File:Line | Issue | Suggestion |
|----------|-----------|-------|------------|
| **Critical** | `base/Components.kt:16–18, 29–31, 42–44, 53–55, 65–67, 83–85, 99–101, 112–114, 126–128, 147–149, 162–164, 173–175, 191–193, 212–214, 227–229, 249–251, 263–265, 278–280, 323–325, 339–341, 358–360, 382–384, 411–413, 434–436, 445–447, 463–465, 484–486` | Every `render()` in the DSL `Components.kt` file throws `TODO("Platform rendering not yet implemented")`. `TODO()` expands to `throw NotImplementedError()`. `NotImplementedError` extends `Error`, not `Exception`. This is uncatchable by any standard `catch (e: Exception)` block. Calling any DSL-constructed component through `AvaUI.render()` crashes the JVM unconditionally and cannot be handled at the caller. | Replace with `expect fun render(renderer: Renderer): Any` in `Component` interface and provide `actual` implementations per platform target, OR move rendering logic into platform-specific renderer implementations that are invoked via `Renderer.render(component)` dispatch. Do not leave `TODO()` in any `render()` override. |
| **Critical** | `base/Types3D.kt:123,128,133,213` | `Math.toRadians()` is `java.lang.Math` — a JVM-only API — called from `commonMain` in `Transform3D.rotateX()`, `rotateY()`, `rotateZ()`, and `perspectiveMatrix()`. This fails to compile on iOS (Kotlin/Native) and JS targets. | Replace with `kotlin.math.PI / 180.0 * degrees.toDouble()` (pure Kotlin, KMP-safe). The same file already uses `kotlin.math.cos` and `kotlin.math.sin` correctly — apply the same pattern for degree-to-radian conversion. |
| **High** | `base/Components.kt` vs `ui/core/layout/LayoutComponents.kt` | `ColumnComponent`, `RowComponent`, `ContainerComponent`, `ScrollViewComponent`, `CardComponent` are each defined in **two separate packages**. The `components.dsl` versions throw `TODO()`. The `ui.core.layout` versions properly delegate to `renderer.renderComponent()`. Any code importing both packages gets an ambiguous reference at call sites. | Remove the duplicate definitions from `base/Components.kt`. Keep the concrete implementations in `ui.core.layout`. The DSL scopes in `MagicUI.kt` should produce the `ui.core.layout` types. |
| **High** | `base/Components.kt` vs `ui/core/display/DisplayComponents.kt` | `TextComponent`, `IconComponent`, `ImageComponent` defined in both `components.dsl` and `ui.core.display`. Same ambiguous-reference problem, same `TODO()` issue in the DSL versions. | Remove DSL duplicates. `ui.core.display.TextComponent` has richer fields (letterSpacing, textDecoration, TextFont). Keep the richer definition. |
| **High** | `base/Components.kt` vs `ui/core/form/FormComponents.kt` | `CheckboxComponent`, `TextFieldComponent`, `SwitchComponent` defined in both `components.dsl` and `ui.core.form`. | Remove DSL duplicates. `ui.core.form` versions are richer (multiline, keyboardType, indeterminate state). |
| **High** | `ui/core/feedback/Badge.kt` AND `ui/core/display/Badge.kt` AND `base/Components.kt` | `BadgeComponent` defined in three separate packages with incompatible field types (`style: ComponentStyle?` vs `style: Any?`; typed `modifiers` vs untyped). | Consolidate into one canonical `BadgeComponent`. The `display` version (implementing `Component`) is the most complete. Delete the `feedback` and DSL versions. |
| **High** | `ui/core/feedback/Tooltip.kt` AND `ui/core/display/Tooltip.kt` AND `base/Components.kt` | `TooltipComponent` defined in three packages. The `feedback` version has `child: Any` (untyped). The `display` version has `child: Component?`. The DSL version has `child: Component`. | Consolidate into one definition using `child: Component?`. |
| **High** | `ui/core/data/TreeView.kt` AND `ui/core/display/TreeView.kt` | `TreeViewComponent` and `TreeNode` defined twice. The `data` version does not implement `Component`. The `display` version does. | Remove `data.TreeViewComponent` and `data.TreeNode`; update all callers to use `display.TreeViewComponent`. |
| **High** | `ui/core/data/Avatar.kt` AND `ui/core/display/Avatar.kt` | `AvatarComponent` defined twice with incompatible APIs (`source`/`text` in `data`; `imageUrl`/`initials`/`icon` in `display`). Only `display` version implements `Component`. | Unify into one `AvatarComponent`. Merge fields: keep `imageUrl`, `initials`, `icon` from display; add `text` as alias for `initials`. |
| **High** | `ui/core/data/Chip.kt` AND `ui/core/display/Chip.kt` | `ChipComponent` defined twice. `data` version has `onClick`/`onDelete` lambdas; `display` version has `deletable: Boolean` and `selected: Boolean` but typed modifiers. Neither is complete. | Merge into one `ChipComponent` with all fields. |
| **High** | `ui/core/data/Table.kt` AND `ui/core/display/Table.kt` | `TableComponent` defined twice. `data.Table` does NOT implement `Component`; `display.Table` does. `data.Table`'s `empty()` factory creates a table with `rows = emptyList()` which would pass its own `init` (no non-empty check), but the `display.Table.init` requires `rows.isNotEmpty()`. Runtime inconsistency. | Delete `data.Table.TableComponent`; keep `display.Table.TableComponent`. Fix the `empty()` factory to be removed or to accept that an empty table is valid (then relax the `require`). |
| **High** | `ui/core/feedback/Badge.kt:40–47`, `ui/core/feedback/Spinner.kt:31–37`, `ui/core/feedback/Tooltip.kt:33–44`, `ui/core/navigation/Tabs.kt:36–48`, `ui/core/navigation/Drawer.kt:38–50`, `ui/core/navigation/Pagination.kt:34–51`, `ui/core/data/Accordion.kt:42–55`, `ui/core/data/Carousel.kt:39–57`, `ui/core/data/TreeView.kt:42–55`, `ui/core/data/EmptyState.kt:33–46`, `ui/core/data/List.kt:45–54`, `ui/core/data/Paper.kt:32–43`, `ui/core/data/Avatar.kt:31–44`, `ui/core/data/Chip.kt:33–48`, `ui/core/data/Table.kt:51–118`, `ui/core/display/StatCard.kt:59–155` | These 16 component classes do **not** implement the `Component` interface. They declare `style: Any?` and `modifiers: List<Any>` instead of `style: ComponentStyle?` and `modifiers: List<Modifier>`. They cannot be passed to any DSL scope or renderer. They are unrenderable dead types. | Make each implement `Component` with the typed fields, and add `override fun render(renderer: Renderer): Any = renderer.renderComponent(this)`. |
| **High** | `ui/core/feedback/NotificationCenter.kt:113` | `System.currentTimeMillis()` called in `commonMain` inside `data class Notification(... val timestamp: Long = System.currentTimeMillis() ...)`. `System.currentTimeMillis()` is `java.lang.System` — JVM-only. Fails to compile on iOS/Kotlin Native. | Replace with `kotlinx.datetime.Clock.System.now().toEpochMilliseconds()` (requires `kotlinx-datetime` dependency) or define a `expect fun currentTimeMillis(): Long` with `actual` per platform. |
| **Medium** | `base/Types.kt` (line 327) AND `ui/core/layout/LayoutComponents.kt` (line 135) | `enum class Orientation` declared in both packages. Import of either brings a conflicting definition. Same for `enum class Arrangement` at `Types.kt:299` and `LayoutComponents.kt:123`. | Remove the duplicates from `ui.core.layout`; import from `components.core`. |
| **Medium** | `ui/core/form/FormComponents.kt:15` | `val buttonStyle: ButtonScope = ButtonScope.Filled` — `ButtonScope` is an enum that mirrors `ButtonVariant` with the same values. It exists "for mapper compatibility" but is a separate type. Any mapper treating `ButtonComponent` with `ButtonScope` will differ from code treating `ButtonVariant`. This is precisely the kind of indirection Rule 2 forbids. | Remove `ButtonScope` enum and the `buttonStyle` field. Mappers should use `variant: ButtonVariant` directly. |
| **Medium** | All interactive components: `ButtonComponent`, `CheckboxComponent`, `RadioComponent`, `SwitchComponent`, `FABComponent`, `BottomNavComponent`, `AppBarComponent`, `TabsComponent`, `DrawerComponent`, `SliderComponent`, `DropdownComponent`, `SearchBarComponent`, `AutocompleteComponent`, `ToggleButtonGroupComponent`, `MultiSelectComponent`, `TagInputComponent`, `IconButtonComponent` | Zero AVID voice semantics on any interactive component. The project mandates AVID on ALL interactive elements. `contentDescription` fields exist on `IconComponent` and `IconButtonComponent` but are not set to AVID format. | Add an `avid: String?` field (or use `contentDescription` for AVID format strings like `"Voice: click Submit"`) to all interactive components. Provide a `AvidDefaults` helper that generates AVID strings from component type + label. |
| **Medium** | `ui/core/layout/LayoutComponents.kt` — `ColumnComponent.arrangement`, `RowComponent.arrangement`, `ScrollViewComponent.orientation` | Fields marked "For mapper compatibility" create dual-representation ambiguity. `ColumnComponent` has both `verticalArrangement: VerticalArrangement` AND `arrangement: Arrangement`. Two different fields describe the same semantic — whichever mapper ignores one will produce incorrect layouts. | Pick one canonical field per layout axis; deprecate and remove the compatibility alias. If mappers need the old name, handle via an extension property, not a primary constructor field. |
| **Medium** | `ui/core/layout/StickyHeader.kt` companion `section()`:88 | `StickyHeaderComponent.section()` hardcodes `backgroundColor = Color.White`. This bypasses AvanueTheme and will be visually wrong on dark mode / LUNA / SOL palettes. | Use a theme-token approach: pass a `Color?` parameter that defaults to `null` (transparent, inherits from container) or document that callers must supply a theme-aware color. |
| **Medium** | `ui/core/feedback/NotificationCenter.kt` — `addNotification()`, `removeNotification()`, `clearAll()` | These methods mutate state by returning new copies of an immutable `data class`. But `NotificationCenterComponent` is a Compose-hostile model — Compose will not recompose on reference changes unless the list is inside a `State`. These mutation helpers give false impression of reactive state management. | Document clearly that these are immutable transformation helpers; state management must be done via `MutableState<NotificationCenterComponent>` or a ViewModel. |
| **Medium** | `ui/core/display/StatCard.kt:169–179` | Validation: `require(trendValue == null || trendValue == 0f)` for `Neutral` trend. `0f == 0f` is float equality — safe here since 0f is exact. But `trendValue >= 0f` check on L168 uses float comparison without epsilon. More importantly: business logic (what color trend means) is embedded in a data class (`trendColor`, `formattedTrend`) rather than the renderer. This violates the renderer-responsibility principle of this DSL. | Move `trendColor` and `formattedTrend` into the renderer layer. The data class should be a plain data carrier. |
| **Low** | `ui/core/3d/Canvas3D.kt:50–52` | `Canvas3D.render()` does `return renderer.render(this)` — this is the ONLY component in the module that correctly delegates to renderer dispatch. All other functional components use `renderer.renderComponent(this)` which is the backwards-compat alias. `Canvas3D` does not call `renderComponent`. Inconsistency. | Standardise: all components should use `renderer.renderComponent(this)` (or all use `renderer.render(this)`). |
| **Low** | `base/MagicUI.kt` (1127 lines) | Extremely long single file containing all DSL scope classes. The `AvaUIScope` class alone spans 360 lines and lists every component factory method. Adding a new component requires editing this mega-file. Single Responsibility Principle violation. | Split into per-category scope files: `LayoutScope.kt`, `FormScope.kt`, `FeedbackScope.kt`, matching the package structure already used in `ui.core.*`. |
| **Low** | `ui/core/layout/MasonryGrid.kt`, `ui/core/layout/IconPicker.kt`, `ui/core/feedback/Dialog.kt`, `ui/core/feedback/Toast.kt`, `ui/core/feedback/Snackbar.kt`, `ui/core/feedback/Banner.kt`, `ui/core/feedback/ProgressBar.kt`, `ui/core/feedback/ProgressCircle.kt`, `ui/core/display/Avatar.kt`, `ui/core/display/Badge.kt`, `ui/core/display/Chip.kt`, `ui/core/display/TreeView.kt`, `ui/core/display/Timeline.kt`, `ui/core/display/DataTable.kt`, `ui/core/form/Checkbox.kt`, `ui/core/form/Switch.kt`, `ui/core/form/ColorPicker.kt`, `ui/core/form/TagInput.kt` | 18 files are compressed to 1–3 lines of code with no formatting, no blank lines, semicolons between statements. This makes review and git diffs extremely difficult. | Run `ktlint` formatter. Each property/init block/companion should be on its own line. |
| **Low** | No test files found in this module | Zero test coverage for any component's `init` validation logic, factory methods, or data transformation helpers (DataGrid filtering/sorting, TableComponent manipulation, AutocompleteComponent filtering, ToggleButtonGroup selection logic). | Add unit tests for all `init` validation paths, all `companion object` factory methods, and all pure transformation methods (DataGrid, Table, AutocompleteComponent). |

---

## Recommendations

1. **Fix the KMP violation in `Types3D.kt` immediately** — replace `Math.toRadians()` with `(degrees * kotlin.math.PI / 180.0).toFloat()` at lines 123, 128, 133, and 213. This is a one-line fix per call site that unblocks iOS/JS compilation.

2. **Resolve the `TODO()` stubs in `base/Components.kt`** — the DSL component layer is entirely non-functional. The correct fix is to remove all the duplicate data classes from `Components.kt` and have the DSL scopes in `MagicUI.kt` construct the `ui.core.*` types directly. This resolves both the stub problem and the duplicate-class problem in one pass.

3. **Fix `System.currentTimeMillis()` in `NotificationCenter.kt:113`** — add `kotlinx-datetime` to the module's `build.gradle.kts` and use `Clock.System.now().toEpochMilliseconds()` as the default. This is the standard KMP-safe approach already used elsewhere in the project.

4. **Make all non-conforming components implement `Component`** — the 16 classes in `data.*`, `feedback.Badge`, `feedback.Spinner`, `feedback.Tooltip`, `navigation.Tabs`, `navigation.Drawer`, `navigation.Pagination`, and `display.StatCard` need typed `style: ComponentStyle?`, typed `modifiers: List<Modifier>`, and a `render()` implementation. Without this, they are unreachable through any DSL or renderer.

5. **Consolidate duplicate class definitions** — the pattern of defining `BadgeComponent` in three packages and `TooltipComponent` in three packages is the most dangerous structural issue after the KMP break. Write a migration table: for each duplicated class name, pick the canonical home (prefer `ui.core.*` over `base/Components.kt`), delete the others, and update all import sites.

6. **Add AVID to all interactive components** — this is a zero-tolerance project rule. At minimum, add `val avidLabel: String? = null` to every interactive component and document the expected format (`"Voice: click $label"`). The renderer implementations can then apply this as `contentDescription` on Android/Compose.

7. **Remove `ButtonScope` enum** — it is a Rule 2 violation (unnecessary indirection). Remove both the enum and the `buttonStyle: ButtonScope` field from `ButtonComponent`. Update all mapper call sites to use `variant: ButtonVariant`.

8. **Resolve `Orientation` and `Arrangement` enum duplication** — these are declared in both `components.core` and `ui.core.layout`. Delete the `ui.core.layout` copies and import from `components.core`. Already done correctly in `Divider.kt` (it imports `com.augmentalis.avamagic.components.core.Orientation`); apply the same to all other files.

9. **Add `ktlint` and run it** — 18 files are single-line compressed. Add the `ktlint` Gradle plugin to the module's build file and run `./gradlew :Modules:AvanueUI:Core:ktlintFormat` before the next commit.

10. **Add unit tests** — coverage target: all `init` validation blocks, all `companion object` factory methods, `DataGridComponent` sort/filter/pagination logic, `TableComponent` cell manipulation, `AutocompleteComponent.filteredSuggestions`, `ToggleButtonGroupComponent.toggleSelection`. These are all pure Kotlin with no platform dependencies and can run in `commonTest`.

---

## Critical Path Summary

| Priority | Fix | Impact |
|----------|-----|--------|
| 1 | `Types3D.kt` — replace `Math.toRadians()` | Unblocks iOS/JS compilation |
| 2 | `Components.kt` — remove all `TODO()` `render()` stubs | Unblocks DSL usage |
| 3 | `NotificationCenter.kt:113` — replace `System.currentTimeMillis()` | Unblocks iOS/JS compilation |
| 4 | Consolidate 10+ duplicate class definitions | Eliminates import ambiguity |
| 5 | Implement `Component` on 16 non-conforming classes | Makes module usable |
| 6 | AVID on all interactive components | Project zero-tolerance rule |
