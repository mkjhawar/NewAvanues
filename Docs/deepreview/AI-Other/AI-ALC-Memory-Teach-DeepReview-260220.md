# Deep Code Review — AI Modules: ALC + Memory + Teach
**Date:** 260220
**Scope:** `Modules/AI/ALC/` (32 files) · `Modules/AI/Memory/` (10 files) · `Modules/AI/Teach/` (19 files)
**Total files reviewed:** 61
**Reviewer:** Code-Reviewer Agent

---

## Summary

The ALC module contains four **CRITICAL** stubs across iOS/macOS/Linux/Windows platform engines where local inference is completely non-functional (returns uniform random distributions), plus two **CRITICAL** security vulnerabilities in the AVA3 file format (MD5 nonce derivation; hash-mismatch-only-warns). The Memory module is well-designed but has a **HIGH** mutex-over-IO suspension bug in `FileBasedMemoryStore` that constitutes a coroutine threading violation. The Teach module contains two **HIGH** KMP violations in `TrainingAnalytics.kt` (`System.currentTimeMillis()` and `String.format()` in commonMain) and a pervasive **HIGH** theme violation: every UI component across all five UI files uses `MaterialTheme.colorScheme.*` instead of the mandatory `AvanueTheme.colors.*`.

---

## Issues

### CRITICAL

| Severity | File:Line | Issue | Suggestion |
|----------|-----------|-------|------------|
| Critical | `ALC/src/iosMain/.../CoreMLRuntime.kt:49-66` | `predict()` and `predictBatch()` return `FloatArray(outputSize) { 1.0f / outputSize }` — uniform distribution, NOT real CoreML inference. `loadModel()` sets `isInitialized = true` without loading any model file. Comment confirms: "stubbed inference for testing until cinterop is configured." iOS local inference is entirely non-functional. | Wire actual CoreML cinterop: `MLModel.load()`, `MLFeatureProvider`, and tensor to `FloatArray` conversion. Until ready, return a `Result.failure` from `generateResponse()` with a clear message rather than silently producing garbage tokens. |
| Critical | `ALC/src/macosMain/.../ALCEngineMacOS.kt:200-203` | `runInference()` returns uniform distribution; comment "Note: CoreML model loading stubbed until cinterop is configured". `healthCheck()` returns `HEALTHY` for a stub engine. | Same fix as iOS CoreMLRuntime. `healthCheck()` must return `DEGRADED` or `UNAVAILABLE` when the real engine is not wired. |
| Critical | `ALC/src/linuxMain/.../ALCEngineLinux.kt:149-152` | `loadLlamaModel()` returns `Result.success(Unit)` immediately — no llama.cpp invocation. When `modelHandle == null`, `runInference()` returns random floats. `initialize()` sets `_isInitialized = true` even when `libHandle` is null. | Implement real dlopen/dlsym for llama.cpp, or gate `initialize()` so it returns failure when the native lib is absent instead of reporting false success. |
| Critical | `ALC/src/mingwMain/.../ALCEngineWindows.kt:191-195` | `loadOnnxModel()` returns `Result.success(Unit)` immediately — no ONNX Runtime call. Same random-fallback in `runInference()`. | Implement real ONNX Runtime Windows path via JNI/cinterop, or return `Result.failure` with clear message. |
| Critical | `ALC/src/androidMain/.../ava3/AVA3Decoder.kt:172-174` and `desktopMain` equivalent | Hash mismatch on file integrity check logs a `WARNING` and continues — corrupted or tampered AVA3 model files are silently accepted. This applies to both Android and Desktop decoders. | Throw an `IntegrityException` (or return `Result.failure`) when the hash does not match. Never silently continue past a failed integrity check. |
| Critical | `ALC/src/androidMain/.../ava3/AVA3Decoder.kt:295` and `desktopMain` equivalent | `deriveNonce()` uses MD5 to derive the cipher nonce: `MessageDigest.getInstance("MD5")`. MD5 is cryptographically broken (collision attacks practical since 2004). An attacker who can produce MD5 collisions on the input material can potentially reuse a nonce, breaking AES-CTR's confidentiality entirely. | Replace MD5 with SHA-256 in `deriveNonce()`. Update both Android (`androidMain`) and Desktop (`desktopMain`) copies simultaneously. |

---

### HIGH

| Severity | File:Line | Issue | Suggestion |
|----------|-----------|-------|------------|
| High | `ALC/src/androidMain/.../di/ALCModule.kt:~40-60` | `System.getenv("ANTHROPIC_API_KEY")` etc. — `System.getenv()` always returns `null` on Android; environment variables are not available in the Android runtime. All cloud providers are constructed with `null` API keys silently, then fail at runtime when the first request is made. | On Android, API keys must come from encrypted SharedPreferences / DataStore / Hilt-bound config, NOT environment variables. Replace all `System.getenv()` calls in `ALCModule` with an injected `ApiKeyProvider` or read from `SecureStorage`. |
| High | `ALC/src/androidMain/.../engine/ALCEngineAndroid.kt` `desktopMain` `iosMain` | `isGenerating` and `shouldStop` are plain `var` fields accessed from `flow { }` coroutines running on `Dispatchers.IO` / `Dispatchers.Default`. Without `@Volatile` or a synchronisation mechanism, reads from one coroutine may see stale values from another — a data race on token generation cancellation. `totalTokensGenerated`, `totalInferenceTimeMs`, `sessionCount` share the same problem across all three engine variants. | Annotate with `@Volatile` at minimum, or use `AtomicBoolean` / `AtomicLong` for all mutable state accessed across coroutines. |
| High | `ALC/src/commonMain/.../provider/BaseCloudProvider.kt` | Each `BaseCloudProvider` instance creates a `HttpClient(CIO)` in its initializer and **never closes it**. In long-running applications or where providers are recreated (e.g., after key rotation via `UnifiedProviderFactory.clearCache()`), this leaks file descriptors and native socket resources. | Override `close()` from `Closeable` and call `client.close()`. In `UnifiedProviderFactory`, close evicted providers in `clearCache()`. |
| High | `ALC/src/androidMain/.../ava3/AVA3Decoder.kt:121` and `desktopMain` | `fis.read(headerBytes)` — the return value is not checked. `read()` can return fewer bytes than requested on slow storage or network-backed files. A partial read will silently corrupt the header parse. | Replace with `DataInputStream.readFully(headerBytes)` which guarantees all bytes are read or throws `EOFException`. |
| High | `ALC/src/desktopMain/.../ava3/AVA3Encoder.kt:207` | `encodeDirectory()` throws `UnsupportedOperationException("Directory encoding not supported yet")` — a production stub in violation of Rule 1. | Implement directory encoding: iterate files with `File.walkTopDown()`, encode each file, and optionally build a manifest. If genuinely deferred, remove the public API entry point and document the gap in a tracked issue. |
| High | `ALC/src/commonMain/.../provider/GoogleAIProvider.kt` | Streaming is not implemented: `options.stream` selects the `streamGenerateContent` endpoint but the response is always parsed with `.body<GeminiResponse>()` — a single-response parser. Real SSE streaming is never consumed. Additionally, the API key is sent both as a query parameter (`parameter("key", ...)`) AND as a header — the double key is harmless but indicates copy-paste drift. | Implement true SSE streaming using Ktor's `HttpStatement.execute { response -> response.bodyAsChannel().… }`. Remove the redundant header-based key. |
| High | `ALC/src/commonMain/.../provider/LLMProviderFactory.kt` — `FallbackProvider.chat()` | If a provider emits several `LLMResponse.Streaming` chunks and then an `LLMResponse.Error`, the fallback logic sets `providerFailed = true` and tries the next provider — but the already-emitted streaming chunks cannot be retracted from the caller's flow. The consumer receives mixed partial output from the failed provider concatenated with the full output of the fallback provider. | Reset and retry from the beginning for the next provider. Track whether any non-error chunks were emitted; if so, emit a synthetic delimiter or error event before switching, or buffer chunks until the provider signals completion before forwarding them. |
| High | `ALC/src/commonMain/.../provider/AnthropicProvider.kt:~30` | `authHeader = "x-api-key" to (config.apiKey ?: "")` — when `config.apiKey` is null, an empty string key is sent. Anthropic's API will respond with a 401 that is swallowed by `parseStreamChunk()` returning null silently. The caller sees an empty response with no error indication. | Fail fast: in `AnthropicProvider.init {}` (or in `LLMProviderFactory.createCloudProvider()`), throw `IllegalArgumentException` if `config.apiKey` is null or blank. |
| High | `ALC/src/commonMain/.../provider/AnthropicProvider.kt` | The `message_stop` event handling emits `Complete(fullText = "", usage = TokenUsage(0, 0))` — token usage is always reported as zero for streaming completions. Additionally, the `anthropic-version` header is set only on the non-streaming branch (L70), not on the streaming path. | Accumulate token usage from `message_delta` events with `usage.output_tokens`. Add the `anthropic-version` header to the streaming request builder. |
| High | `Memory/src/desktopMain/.../FileBasedMemoryStore.kt` — `ensureCacheLoaded()` | `mutex.withLock { … withContext(Dispatchers.IO) { … } … }` — the coroutine `Mutex` is held across a `withContext` suspension point. A Mutex must never be held across suspension in Kotlin coroutines; doing so causes the coroutine to suspend while holding the lock, preventing any other coroutine from acquiring the mutex and creating a potential deadlock. | Refactor: check `cacheLoaded` under the mutex, release it, run IO outside the lock, then re-acquire the mutex to apply the loaded data (with a double-check). Pattern mirrors `AndroidMemoryStore.ensureDiskLoaded()` which does this correctly. |
| High | `Teach/src/commonMain/.../TrainingAnalytics.kt:211` | `System.currentTimeMillis()` in `commonMain` — `java.lang.System` is not available on iOS/native KMP targets. This file will **fail to compile for iOS/native**. | Use `kotlinx.datetime.Clock.System.now().toEpochMilliseconds()` (already available in the project as seen in other modules). |
| High | `Teach/src/commonMain/.../TrainingAnalytics.kt` — `toOneDecimal()` / `toTwoDecimals()` extensions | `"%.1f".format(this)` and `"%.2f".format(this)` use `String.format()` which is NOT available in KMP `commonMain` on iOS/native. This will fail to compile for iOS/native targets. | Use `kotlin.math.round()` with division: `(this * 10).toLong() / 10.0` and convert to string manually, or use `kotlinx.serialization` number formatting. |
| High | `Teach/src/androidMain/…` — ALL FIVE UI files (`AddExampleDialog`, `EditExampleDialog`, `SimilarityAnalysisScreen`, `TeachAvaContent`, `TeachAvaScreen`, `TrainingAnalyticsScreen`, `TrainingExampleCard`) | Every UI file uses `MaterialTheme.colorScheme.*`, `MaterialTheme.typography.*`, `MaterialTheme.shapes.*` — violating mandatory Rule (CLAUDE.md #3): ALL UI code MUST use `AvanueTheme.colors.*`. This is a pervasive theme system violation across the entire Teach UI layer. | Replace all `MaterialTheme.colorScheme.*` references with `AvanueTheme.colors.*`. Use `AvanueCard`, `AvanueSurface`, `AvanueButton` unified components which auto-adapt to MaterialMode. |
| High | `Teach/src/androidMain/.../AddExampleDialog.kt:183` and `EditExampleDialog.kt:246` | Hash is computed as MD5 of `"$utterance:$intent"` (AddExampleDialog) but in `BulkImportExportManager.kt:187`, the hash is computed as MD5 of `"${utterance}${intent}"` (no separator). The two paths produce **different hashes for the same utterance+intent pair**, breaking the deduplication check entirely: a manually added example will not be deduplicated against a bulk-imported one. | Standardize on a single format. The separator (`:`) version in AddExampleDialog is preferable as it avoids hash collisions between e.g., `("ab", "cd")` and `("a", "bcd")`. Update `BulkImportExportManager.calculateMD5Hash()` to use `"$utterance:$intent"`. |
| High | `ALC/src/androidMain/.../engine/ALCEngineAndroid.kt:327` | EOS token hardcoded as `2`. This is the Llama/LLaMA-2 EOS token ID. For any other model family loaded via TVM (e.g., Phi-2, Mistral, Gemma), the EOS token ID is different (e.g., Phi-2 uses 50256; Gemma uses 1). Hardcoding will cause infinite generation or premature truncation on non-Llama models. | Load the EOS token ID from the model's tokenizer config (`tokenizer_config.json`) or expose it as a parameter in `ModelConfig`. |

---

### MEDIUM

| Severity | File:Line | Issue | Suggestion |
|----------|-----------|-------|------------|
| Medium | `ALC/src/commonMain/.../provider/OpenAIProvider.kt` — `frequencyPenalty` mapping | `frequencyPenalty = options.repetitionPenalty - 1.0f` — OpenAI's `frequency_penalty` range is -2.0 to 2.0 (where 0 is neutral). The module's `repetitionPenalty` convention is >1.0 = penalise repeats. Subtracting 1.0 maps 1.0→0.0 (correct baseline) but maps 0.0→-1.0 (would encourage repeats) and maps 2.0→1.0 (half the intended penalty). The semantics are inverted for low repetition penalty values. | Document the intended mapping contract in `GenerationOptions.repetitionPenalty`. If the field is an OpenAI-style penalty (0 = neutral), pass it directly. If it uses HuggingFace convention (>1 = penalty), the mapping needs to be `(options.repetitionPenalty - 1.0f).coerceIn(-2.0f, 2.0f)`. |
| Medium | `ALC/src/commonMain/.../provider/HuggingFaceProvider.kt` | `inputTokens = prompt.split(" ").size` — whitespace token count is wildly inaccurate for subword tokenizers. A 100-word English sentence can tokenize to 130+ tokens with BPE. The resulting `TokenUsage` is unreliable for cost tracking and rate limiting. | Document the approximation clearly. For accurate counts, use the actual HuggingFace tokenizer response metadata (the API returns `usage` in its response). |
| Medium | `ALC/src/commonMain/.../provider/OpenRouterProvider.kt` | Request body is `mapOf("model" to model, "messages" to messages, ...)` — a `Map<String, Any>`. Ktor's default JSON serializer does not handle `Map<String, Any>` reliably (the `Any` type has no serializer). This will fail at runtime with a serialization error unless a custom serializer or `kotlinx.serialization.json.buildJsonObject` is used. | Use a proper `@Serializable` data class for the request body, or use `kotlinx.serialization.json.buildJsonObject { }` to build the JSON structure. |
| Medium | `ALC/src/commonMain/.../response/ResponseGenerator.kt:~L80` | `templates["unknown"]!!` — will throw `NullPointerException` if the "unknown" template key is removed from the map. No defensive check exists. | Use `?: error("Missing required 'unknown' template in TemplateResponseGenerator")` or provide a hardcoded fallback string. |
| Medium | `ALC/src/commonMain/.../response/ResponseGenerator.kt` — `HybridResponseGenerator` | All exceptions from the LLM call are silently swallowed: the catch block falls through to the template response with no log, no metric increment, no user-visible indication that a real LLM was attempted but failed. Debugging production failures is extremely difficult. | Log at `WARN` level with the exception. Consider emitting a metric or setting a flag on the returned response indicating the response was template-generated rather than LLM-generated. |
| Medium | `ALC/src/desktopMain/.../catalog/AVAModelCatalog.kt` — companion object vars | `remoteCatalog: List<AVAModelInfo>?` and `lastCatalogRefresh: Long` are companion object `var` fields accessed from multiple coroutines without any synchronisation. Concurrent writes or read-write interleaving can produce inconsistent state. | Move mutable catalog state into an instance-level `Mutex`-protected field, or use `AtomicReference`. Companion object state is effectively global mutable state shared across all `AVAModelCatalog` users. |
| Medium | `ALC/src/desktopMain/.../catalog/AVAModelCatalog.kt` — `refreshCatalogSilently()` | Function body is a no-op: `// For now, we use static catalog only`. The function is public and its name implies remote fetch behaviour. Callers cannot distinguish between "refresh not implemented" and "refresh succeeded". | Either implement the remote fetch or remove the function from the public API until it is ready. A stub that silently does nothing violates Rule 1. |
| Medium | `ALC/src/desktopMain/.../catalog/AVAModelCatalog.kt:370` | `ModelCategory.values()` — `values()` is deprecated in Kotlin 1.9+; the replacement is `ModelCategory.entries`. | Replace with `ModelCategory.entries`. |
| Medium | `ALC/src/desktopMain/.../download/HuggingFaceDownloader.kt` | Uses `java.net.HttpURLConnection` for downloads — inconsistent with the rest of the module using Ktor. `HttpURLConnection` has no configurable connect/read timeouts set in this code, no retry logic, and no coroutine integration (blocks a thread). | Migrate to Ktor `HttpClient` for consistency and to enable timeouts, coroutine-native cancellation, and proper error propagation. |
| Medium | `ALC/src/desktopMain/.../download/ModelRegistry.kt` | `saveRegistry()` is called synchronously from `registerModel()`, blocking the calling coroutine/thread with disk I/O. | Wrap `saveRegistry()` call in `withContext(Dispatchers.IO)` inside `registerModel()`. |
| Medium | `ALC/src/androidMain/.../ava3/AVA3Decoder.kt` — PBKDF2 iterations | `PBKDF2_ITERATIONS = 10000` — NIST SP 800-132 (2023) recommends a minimum of 600,000 iterations for PBKDF2-HMAC-SHA256 for password-based key derivation. 10,000 iterations was adequate in 2010; it is insecure against modern GPU-accelerated brute-force attacks. | Increase to at minimum 200,000 iterations; 600,000 is preferred. Document the change in the AVA3 format version header so older files remain decodable. |
| Medium | `ALC/src/desktopMain/.../ava3/AVA3Encoder.kt:155` | Metadata serialised via manual string concatenation: `"\"${entry.key}\":\"${entry.value}\""`. If any key or value contains a double-quote (`"`) or a colon (`:`), the resulting JSON is invalid and cannot be decoded. | Use `kotlinx.serialization.json.buildJsonObject { }` or a `@Serializable` data class for metadata serialisation. |
| Medium | `ALC/src/desktopMain/.../ava3/AVA3Encoder.kt` — `compress()` | Fixed output buffer `ByteArray(data.size + 1024)` — for very small or already-compressed inputs this is acceptable, but for highly-compressible large files the output can exceed `data.size + 1024`. DEFLATE guarantees the worst case is roughly `ceil(n * 1.0009) + 11` bytes. | Use `ByteArrayOutputStream` to capture deflate output of arbitrary size, then convert to `ByteArray`. |
| Medium | `Memory/src/desktopMain/.../DefaultMemoryManager.kt` | `println()` used for all logging throughout the class. Desktop JVM environment has SLF4J available (used by other modules). `println()` output cannot be filtered by log level, redirected to log files, or correlated with structured logging. | Replace `println()` with `LoggerFactory.getLogger(DefaultMemoryManager::class.java)` calls at appropriate log levels (`debug`, `info`, `warn`). |
| Medium | `Memory/src/desktopMain/.../DefaultMemoryManager.kt` — coroutine scope | `scope = CoroutineScope(SupervisorJob() + Dispatchers.Default)` — scope is never cancelled and has no lifecycle attachment. For a long-running service this is acceptable, but for unit tests or short-lived processes (e.g., CLI tools), this creates a leaked scope. | Implement `Closeable`: add `fun close() { scope.cancel() }` and document that callers are responsible for closing the manager. |
| Medium | `Memory/src/desktopMain/.../DefaultMemoryManager.kt:~L60` — `summarizeConversation()` | Returns a static formatted string summary (`"Conversation with N messages"`) with a comment "in production, this would use LLM". This is a functional stub. | If not yet integrated with LLM: either connect to `ResponseGenerator` or `ILLMProvider` for a real summary, or clearly mark the method `@Deprecated` with a tracking issue reference rather than shipping it as-is. |
| Medium | `Memory/src/androidMain/.../AndroidMemoryStore.kt:97-101` — `retrieve()` | Updates the in-memory entry with incremented `accessCount` / `lastAccessed` via `entries[id] = accessed` but does NOT call `persistEntryToDisk()`. The access statistics are silently not persisted. After a process restart, all `accessCount` values revert to their pre-access state. | Call `persistEntryToDisk(accessed)` after updating the in-memory entry, consistent with how `store()` behaves. |
| Medium | `Memory/src/androidMain/.../AndroidMemoryStore.kt` — `persistEntryToDisk()` | Read-full-file + merge + rewrite on every `store()` call — O(n) disk I/O per write. For a session with 100 entries, every new entry stored requires reading and rewriting all 100. This will cause noticeable latency for active conversation sessions. | Use an append-only journal format for writes, with periodic compaction. Alternatively, batch writes using a dirty-flag and periodic flush timer (already partially supported by the "bulk writes should call rewriteDiskFile()" comment). |
| Medium | `Teach/src/commonMain/.../TeachAvaBusinessLogic.kt` — `setLocaleFilter()` and `setIntentFilter()` | Each call launches a new coroutine that `collect()`s the repository flow indefinitely. Multiple calls stack up multiple active collectors on the same flow. After 10 locale changes, 10 coroutines are all collecting the same repository flow and all updating `_uiState`. This causes N×redundant database queries and potential state race conditions. | Cancel the previous collection job before starting a new one. Store the job in a `var filterJob: Job? = null` field and call `filterJob?.cancel()` before launching the new `filterJob = scope.launch { … }`. |
| Medium | `Teach/src/androidMain/.../BulkImportExportManager.kt` — `isValidLocale()` | Locale validation regex `[a-z]{2}-[A-Z]{2}` rejects valid locales like `zh-Hans`, `sr-Latn`, `zh-TW`, `en-001`. It also rejects language tags like `fr-CA` (actually valid, but a 3-letter country code like `zh-CHT` would fail). | Use `Locale.forLanguageTag()` wrapped in `runCatching` to validate locale strings, which handles the full BCP 47 language tag spec. |
| Medium | `Teach/src/androidMain/.../SimilarityAnalysisScreen.kt:133` | `containerColor = Color(0xFFFFF3E0)` — hardcoded color value bypasses the theme system. In dark mode this light-orange background will be illegible. Same issue in multiple places (`Color(0xFFC62828)`, `Color.White` at L259). | Replace hardcoded colors with `MaterialTheme.colorScheme.*` references (until full AvanueTheme migration). Light-on-dark hardcoded colors are an accessibility issue. |
| Medium | `Teach/src/androidMain/.../TrainingAnalyticsScreen.kt:543` | `progress = (count.toFloat() / totalExamples)` — when `totalExamples == 0` this produces `NaN` (0/0 in float). `LinearProgressIndicator` with `NaN` progress causes undefined rendering behaviour. | Guard: `progress = if (totalExamples > 0) count.toFloat() / totalExamples else 0f`. |

---

### LOW

| Severity | File:Line | Issue | Suggestion |
|----------|-----------|-------|------------|
| Low | `ALC/src/commonMain/.../engine/Interfaces.kt` — `IModelLoader.loadModel()` | Returns `Result<Any>` — the `Any` return type loses all type safety. Each platform engine must unsafely cast the result. | Use a sealed class `LoadedModel` (or a generic `Result<T>`) with platform-specific subtypes, or document the expected concrete type in KDoc. |
| Low | `ALC/src/androidMain/.../di/ALCModule.kt` | `ALCManager` class is defined inside the DI module file — violates Single Responsibility Principle. DI modules should only contain `@Provides` / `@Binds` annotations. | Move `ALCManager` to its own file `ALCManager.kt`. |
| Low | `ALC/src/commonMain/.../config/LLMConfig.kt` — `ModelSelector.selectModel()` | Hardcoded ONNX model path `"models/phi-2-q4.onnx"` for MEDIUM class — no validation that this path exists before returning it. `DeviceProfile.fromMemory()` hardcodes `availableMemory = totalMemory * 0.70f` regardless of actual free memory. | Path should be validated against `ModelRegistry`. `availableMemory` should use `ActivityManager.getMemoryInfo()` on Android or `Runtime.getRuntime().freeMemory()` on Desktop for dynamic accuracy. |
| Low | `ALC/src/commonMain/.../provider/BaseCloudProvider.kt` — `streamRequest()` | `val buffer = StringBuilder()` declared at L~50 but never used. The streaming accumulation is done via `fullText` in the calling provider. | Remove the dead `buffer` variable. |
| Low | `ALC/src/desktopMain/.../cli/ALCModelTool.kt` — `handleUninstall()` | `readLine()` for user confirmation has no timeout; in non-interactive environments (CI, scripting) the CLI will hang indefinitely. | Add a `--yes` / `--force` flag for non-interactive confirmation, consistent with standard CLI tooling convention. |
| Low | `ALC/src/androidMain/.../engine/TVMRuntime.kt` — `TVMTokenizer` | Uses simple whitespace splitting for tokenization — not BPE or WordPiece. Tokens produced are whole words, not subword units. This produces incorrect token IDs for all modern models (Llama, Phi, Gemma, etc.). | This is a known approximation appropriate only for prototype/testing purposes. Document it explicitly and track the real BPE tokenizer implementation as a required feature before production use. |
| Low | `Memory/src/commonMain/.../InMemoryStore.kt` — `update()` | Silently does nothing if the ID is not found — no error, no return value indicating the entry did not exist. Callers cannot distinguish "update succeeded" from "entry not found". | Change the return type to `Boolean` (or `Result<Unit>`) and return `false`/`Result.failure` when the ID is not found. |
| Low | `Teach/src/androidMain/.../AddExampleDialog.kt:183` / `EditExampleDialog.kt:246` | Both dialogs use `java.security.MessageDigest("MD5")` directly for deduplication hashing. MD5 is used for data integrity only here (not security), but the inconsistency with `PlatformUtils.calculateMD5Hash()` (the `expect/actual` function) means there are now three separate MD5 implementations in the Teach module. | Consolidate: call the `expect` function `calculateMD5Hash()` from `PlatformUtils.kt` instead of directly instantiating `MessageDigest`. This ensures a single implementation path and makes future hash algorithm changes easier. |
| Low | `Teach/src/commonMain/.../IntentSimilarityAnalyzer.kt` — `findSimilarIntents()` | Calls `analyzeSimilarities(examples, 0.0)` for every single-intent lookup — this recalculates the entire TF-IDF corpus matrix every time. O(n²) complexity for n intents, called per-example. With 500 training examples, a single `findSimilarIntents()` call processes ~250,000 pairs. | Cache the TF-IDF model: build it once when examples change, invalidate on add/delete/update. `findSimilarIntents()` should query the cached model rather than rebuilding it. |
| Low | `Teach/src/androidMain/.../TeachAvaViewModelExtensions.kt` — `findSimilarIntents()` extension | Calls the O(n²) `analyzeSimilarities()` synchronously from what may be a Compose recomposition context. If called from a composable or click handler without `LaunchedEffect`, it will block the UI thread. | Wrap in `viewModelScope.launch(Dispatchers.Default) { … }` and expose the result via a `StateFlow`. |
| Low | `Teach/src/androidMain/…` UI files — ALL interactive elements | None of the interactive elements (buttons, dialogs, filter chips, FAB, navigation icons) have AVID voice semantics (`Modifier.semantics { contentDescription = "Voice: ..." }`). This violates the mandatory voice-first AVID rule across the entire Teach UI. | Add `semantics { contentDescription = "Voice: add training example" }` (etc.) to every `Button`, `IconButton`, `FloatingActionButton`, `FilterChip`, and `IconButton(onClick = onBackClick)`. |
| Low | `Teach/src/androidUnitTest/.../TeachAvaViewModelTest.kt` | Test for `updateExample` with "add failure after successful delete" (L158) verifies the error state is `TeachAvaUiState.Error` with message `"Add failed"` — but it does not verify that the deleted example is now **gone** (data loss scenario). The worst-case scenario (delete succeeded, add failed → example permanently lost) is untested. | Add an assertion that the repository now contains the original example after the failed update, or confirm a compensating re-add is attempted. |

---

## Recommendations

1. **Block iOS/macOS/Linux/Windows local inference from shipping** until real platform engines are wired. Return a clear `Result.failure("Local inference not available on this platform — use cloud providers")` from `generateResponse()` so callers can fall back gracefully rather than receiving random-token gibberish.

2. **Fix AVA3 security issues before any model distribution**: Replace MD5 nonce derivation with SHA-256; increase PBKDF2 iterations to at least 200,000; make hash mismatch throw rather than warn. These three issues together mean AVA3-protected model files provide weak security guarantees.

3. **Fix the Android API key injection** in `ALCModule.kt` immediately — all cloud provider calls fail silently at runtime due to null keys from `System.getenv()`. This likely means the entire ALC cloud path is non-functional on Android today.

4. **Standardize hash input format** between `AddExampleDialog` and `BulkImportExportManager` (High severity) — the mismatch means duplicate detection silently fails between manual and bulk-imported examples.

5. **Fix both KMP violations in `TrainingAnalytics.kt`** (`System.currentTimeMillis()` and `String.format()`) — these are compile-time failures for any iOS/native KMP target, not runtime issues.

6. **Fix the `FileBasedMemoryStore` mutex-over-IO pattern** — holding a `kotlinx.coroutines.sync.Mutex` across a `withContext(Dispatchers.IO)` suspension point can deadlock. The correct pattern is already demonstrated in `AndroidMemoryStore.ensureDiskLoaded()`.

7. **Migrate all Teach UI to AvanueTheme** — every Compose component in the Teach module uses `MaterialTheme.colorScheme.*` in direct violation of CLAUDE.md mandatory Rule #3. This is a full-module theme migration task.

8. **Add AVID semantics to all Teach UI interactive elements** — zero interactive elements in the module have voice accessibility semantics, violating the mandatory voice-first AVID rule.

9. **Fix `FallbackProvider` streaming semantics** — partial output from a failed provider mixed with full output from the fallback provider produces a garbled user experience that is very difficult to diagnose.

10. **Consolidate MD5 usage in Teach** — three separate `MessageDigest("MD5")` instantiation sites. Use the `expect/actual calculateMD5Hash()` from `PlatformUtils.kt` uniformly. Also note MD5 is appropriate for deduplication only; the hash is not security-sensitive in this context, so the algorithm is acceptable here specifically.

---

## Statistics

| Module | CRITICAL | HIGH | MEDIUM | LOW | Total |
|--------|----------|------|--------|-----|-------|
| ALC | 6 | 8 | 11 | 5 | 30 |
| Memory | 0 | 2 | 5 | 1 | 8 |
| Teach | 0 | 4 | 4 | 5 | 13 |
| **Total** | **6** | **14** | **20** | **11** | **51** |

---

## Files Reviewed

### ALC (32 files)
- `commonMain`: LLMConfig, ChatMessage, LLMResponse, ProviderTypes, Interfaces, BaseCloudProvider, AnthropicProvider, OpenAIProvider, GoogleAIProvider, GroqProvider, HuggingFaceProvider, OpenRouterProvider, LLMProviderFactory, UnifiedProviderFactory, ResponseGenerator
- `androidMain`: ALCEngineAndroid, TVMRuntime, AVA3Decoder (android), ALCModule, ALCManager
- `desktopMain`: ALCEngineDesktop, ONNXRuntime, AVA3Decoder (desktop), AVA3Encoder, AVAModelCatalog, HuggingFaceDownloader, ModelRegistry, ALCModelTool
- `iosMain`: ALCEngineIOS, CoreMLRuntime, AVA3Decoder (ios)
- `linuxMain`: ALCEngineLinux
- `macosMain`: ALCEngineMacOS
- `mingwMain`: ALCEngineWindows

### Memory (10 files)
- `commonMain`: MemoryType, MemoryEntry, MemoryStore, InMemoryStore, MemoryManager
- `desktopMain`: DefaultMemoryManager, FileBasedMemoryStore
- `androidMain`: AndroidMemoryStore
- `commonTest`: InMemoryStoreTest, MemoryEntryTest

### Teach (19 files)
- `commonMain`: TeachAvaUiState, TeachAvaViewModelInterface, TeachAvaBusinessLogic, IntentSimilarityAnalyzer, TrainingAnalytics, PlatformUtils (common)
- `androidMain`: TeachAvaViewModel, TeachAvaViewModelExtensions, AddExampleDialog, EditExampleDialog, BulkImportExportManager, SimilarityAnalysisScreen, TeachAvaContent, TeachAvaScreen, TrainingAnalyticsScreen, TrainingExampleCard, PlatformUtils (android)
- `desktopMain`: PlatformUtils (desktop)
- `androidUnitTest`: TeachAvaViewModelTest
