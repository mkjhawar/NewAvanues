package com.augmentalis.magiccode.plugins

import com.augmentalis.magiccode.plugins.core.PluginLoader
import com.augmentalis.magiccode.plugins.core.PluginRegistry
import com.augmentalis.magiccode.plugins.core.PluginException
import com.augmentalis.magiccode.plugins.core.InstallationFailedException

/**
 * Mock implementation of PluginLoader for testing.
 *
 * Allows control over plugin loading behavior for testing.
 */
class MockPluginLoader {
    var shouldFailLoading = false
    var loadingFailureMessage = "Mock loading failure"
    var lastLoadedPluginId: String? = null
    var lastLoadedManifestPath: String? = null
    var lastLoadedLibraryPath: String? = null

    // Store loaded plugins
    private val loadedPlugins = mutableSetOf<String>()

    /**
     * Load a plugin from the specified paths.
     */
    suspend fun loadPlugin(
        pluginId: String,
        manifestPath: String,
        libraryPath: String,
        appDataDir: String
    ): PluginLoader.LoadResult {
        lastLoadedPluginId = pluginId
        lastLoadedManifestPath = manifestPath
        lastLoadedLibraryPath = libraryPath

        if (shouldFailLoading) {
            return PluginLoader.LoadResult.Failure(
                InstallationFailedException(pluginId, loadingFailureMessage)
            )
        }

        loadedPlugins.add(pluginId)

        // Create a minimal PluginInfo for success case
        val manifest = com.augmentalis.magiccode.plugins.utils.TestUtils.createTestManifest(
            id = pluginId
        )
        val namespace = com.augmentalis.magiccode.plugins.utils.TestUtils.createTestNamespace(pluginId)
        val pluginInfo = PluginRegistry.PluginInfo(
            manifest = manifest,
            namespace = namespace,
            state = com.augmentalis.magiccode.plugins.core.PluginState.INSTALLED
        )

        return PluginLoader.LoadResult.Success(pluginInfo)
    }

    /**
     * Check if a plugin was loaded.
     */
    fun isPluginLoaded(pluginId: String): Boolean {
        return loadedPlugins.contains(pluginId)
    }

    /**
     * Reset mock state.
     */
    fun reset() {
        shouldFailLoading = false
        loadingFailureMessage = "Mock loading failure"
        lastLoadedPluginId = null
        lastLoadedManifestPath = null
        lastLoadedLibraryPath = null
        loadedPlugins.clear()
    }
}
